# Цифровая модель рельефа

```{r}
#| echo: false

# Нумерация заданий
ch <- 7 # Номер главы
t <- 1 # Номер первого задания (task)

task_fun <- function(ch, t){
  # Функция для добавление номера к заданию
  t <<- t+1
  paste(ch, t, sep = ".")
}

# Пример заголовка задания
## Задание `r task_fun(ch, t)`
```

(Заметки: сначала примеры на 1-слойном растре, потом добавить туда экспозицию, крутизну, TPI и проделать операции с многоканальным растром, модель заменить на NASA DEM)

Цифровая модель рельефа это растр в каждой ячейке которого записана средняя высота поверхности земли. В этом разделе используется цифровая модель ASTER GDEM с пространственным разрешением 30 метров на пиксель.

## Загрузка растровых данных.

Загрузка растровых данных производится через пункт **"Слой" > "Добавить слой" > "Добавить растровый слой"** или перетаскиванием файла растра в окно программы.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Создайте новый проект. Загрузите слои "kvartala", "videla" и растр "DEM".
!!ссылка.
:::

## Визуализация

Настройки отображения растра устанавливаются в контекстном меню слоя **"Свойства.." > "Стиль"**. В пункте "Изображение" настраивается режим отображения. Для количественных данных используются режимы "Одноканальное серое" и "Одноканальное псевдоцветное". Классифицированные изображения визуализируют при помощи режима "Палитра / Уникальные значения". Для многоканальных растров используют режим "Многоканальное цветное". Режимы "Теневой рельеф" и "Изолинии" применяются для цифровых моделей рельефа.

!!Видео задания ниже

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Для слоя "DEM" измените стиль отображения.  Примените режим "Одноканальное псевдоцветное", задайте градиент "Magma".
:::

## Классификация одноканального изображения

Инструмент **"Растр" > "Калькулятор растров..."** позволяет проводить арифметические операции с растровыми изображениями. Для составления выражения используются каналы растров и арифметические операторы. Калькулятор растров так же используется для классификации изображения т.е. разбиения его на классы. Для примера, воспользуемся инструментом и разобьем (классифицируем) растровое изображение на 2 класса. Первый класс будет иметь метку 0, в него войдут все пиксели с высотой до 250 метров, второй класс будет содержать пиксели с высотой большей или равной 250 метров и иметь метку 1.  
Для такой классификации записывают выражение `"DEM@1"  >= 250` в "Калькуляторе растров". Каждый пиксель изображение проверяется на соответсвтие условию. Пикселям, соответсвтующим условию, присваивается значение 1, не соответствующим - 0. Созданный растр будет содержать пиксели только с двумя значениями: 0 и 1 (до 250 и более 250 метров соответственно).


!!Видео добавить

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Проведите классификацию растра "DEM" по примеру выше.
:::

Аналогичным образом возможно разбить растр на несколько классов. Для примера разобъем растр цифровой модели рельефа "DEM" на 3 класса. Класс 1 - значения от 0 до 200 м, класс 2 - от 200 до 400 м, класс 3 - от 400 до 600 м. Распределение по классам осуществляется при помощи инструмента "Калькулятор растров".  
Упомянутую классификацию можно осуществить с помощью следующего выражения: `("DEM@1"  > 0  AND "DEM@1"  < 200)*1 + ("DEM@1"   >=  200  AND "DEM@1"  < 400)*2 +  ("DEM@1"   >=  400  AND "DEM@1"  < 600)*3`. Для объяснения действия выражения, рассмотрим его по частям. Часть выражения `("DEM@1"  > 0  AND "DEM@1"  < 200)` будет принимать значение 1 при высоте от 0 до 200 м (когда **И** одно **И** другое условие истинны). Во всех остальных случаях выражение будет принимать значение 0. Множитель рядом с выражением задает значение класса.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Классифицируйте раст "DEM" по 3 классам, как показано выше. К полученному изображению примените стиль отображения "Палитра / Уникальные значения". Результат должен соответствовать изображению ниже.
:::

![Результат выполнения задания](./pictures/7_1_DEM_3_class.jpg)

## Обрезка растра по границе векторного слоя

Часто требуется ограничить растровое изображение границами векторного слоя. Для выполнения этой операции возможно использовать два инструмента (они находятся во вкладке **"Растр" > "Извлечение"**): **"Обрезать растр по охвату..."** и **"Обрезать растр по маске..."**. Первый обрезает растр по границе наиманьшего прямоугольника, в который попадает геометрия, второй - по границе собственно геометрии (полигона).  
При использовании инструмента **"Обрезать растр по охвату..."** в пункте "Исходный слой" задается растр, который необходимо обрезать. "Охват обрезки" задается двумя парами координат (левый нижний и правый верхний углы прямоугольника), которые можно заполнить вручную, "Рассчитать из слоя" (в этом случае необходимо выбрать слой) задать "Текущий охват карты" или "Указать на карте" напрямую. 

!!Добавить картинку **"Обрезать растр по охвату..."**

Обрезанный растр возможно охранить как новый растровый слой. Для этого в контекстном меню временного слоя выберите пункт **"Экспорт" > "Сохранить как"** формат **"GeoTIFF"**.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Обрежьте растр "DEM" по охвату слоя "videla". Сохраните новый растр.
:::

При использовании инструмента **"Обрезать растр по маске..."** в качестве "Исходного слоя" указывается растровое изображение, которое должно быть обрезано. В пункте "Слой маски" указывается векторный слой, по границам которого будет проведена обрезка. Чек-бокс "Только выделенные объекты" позволяет провести обрезку по границе выделенных объектов.

!! Картинки инструмента **"Обрезать растр по маске..."**

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Обрежьте растр "DEM" по границе Караульного участкового лесничества (слой "uch_lesn"). Используйте инструмент **"Обрезать растр по маске..."**.
:::

!!!Добавить в проект слой "uch_lesn", добавить пункт добавления нового векторного слоя.


## Зональная статистика

Зональная статистика предполагает разделение территории на несколько зон для каждой из которых извлекается значение из растрового слоя. Для выбора инструмента "Зональная статистика" активируйте **"Панель инструментов"**, в пункте **"Анализ растров"** выберите **"Зональная статистика"**. В пункте "Исходный слой" выбирается векторный слой с зонами, в пункте "Растровый слой" задается растр из которого будут извлечены значения для каждой зоны. Пункт "Статистики для расчета" позволяет выбрать несколько статистик, которые будут добавлены в атрибутивную информацию для каждой зоны (среднее, медиана и т.д.).  
Рассчитайте максимальную, минимальную и среднюю высоту для каждого выдела. В пункте "Исходный слой" указывается векторный слой выделов ("videla"), в пункте растровый слой - слой "DEM", префикс поля ввода - "dem_". В пункте **"Статистики расчета"** указываются: **"Среднее"; "Минимум"; "Максимум"**. После выполнения появится новый векторный слой выделов ("Зональная статистика") с добавленными колонками.

!! Добавить видео выполнения задания

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
1. Добавьте в слой выделов среднюю, максимальную и минимальную высоту над уровнем моря по примеру выше.
2. Выберите выдела, которые имеют среднюю высоту более 400 м, сохраните их как отдельный векторный слой. (!добавить количество выделов)
:::

## Расчет топографических индексов.

На основе цифровой модели рельефа возможен расчет экспозиции и крутизны склона а так же топографических индексов TPI, TRI и др. Для примера рассчитаем экспозицию, крутизну и TPI.  
Для расчета экспозиции склона перейдите в пункт **"Растр" > "Анализ" > "Экспозиция..."**. В качестве исходного слоя выбирается цифровая модель рельефа (слой "DEM"), так же отметьте чек-боксы "Возвращать 0 в плоских областях...". После применения инструмента в панеле слоев появится новый временный слой "Экспозиция" в каждой ячейке которого будет указана экспозиция склона в виде азимута (угол, отсчитываемый от северного направления географического меридиана). Равнинные участки будут иметь значние 0.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Рассчитайте экспозицию склона по примеру выше.
:::

Для расчета крутизны склона на основе цифровой модели рельефа используется инструмент **"Растр" > "Анализ" > "Крутизна..."**. В качестве исходного слоя выбирается цифровая модель рельефа (слой "DEM"), результат выполнения появится в панеле слоев в виде временного растрового слоя "Крутизна".

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Рассчитайте крутизну склона по примеру выше.
:::

Индекс топологического положения (TPI) позволяет выделить повышенные и пониженные участки рельефа относительно соседних участков. Для расчета индекса применяется инструмент **"Растр" > "Анализ" > "Индекс топографического положения (TPI)..."** В качестве исходного слоя выбирается цифровая модель рельефа (слой "DEM"), результат выполнения появится в панеле слоев в виде временного растрового слоя "Индекс топографического положения". Для каждого пикселя цифровой модели рельефа оценивается положение относительно соседних пикселей. Значения близкие к нулю соответствуют равнинным местам. Положительные значения характеризуют водоразделы, отрицательные - водотоки.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Рассчитайте индекс топологического положения (TPI) по примеру выше.
:::

## Создание многоканального изображения.

Несколько изображений с одинаковыми пространственным разрешением, охватом и общей системой координат возможно объединить в одно многоканальное изображение. Таким образом в каждом пикселе изображения будет содержаться несколько переменных в виде отдельных каналов. Такая практика часто используется в мультиспектральных изображениях, получаемых со спутников.  
Для объединения нескольких изображений в одно многоканальное используется инструмент **"Растр" > "Прочее" > "Результат объединения..."**. В пункте "Исходные слои" отмечаются слои для объединения.

!! Картинка Исходные слои.

::: {.callout-note}
## Обратите внимание!
Последовательность отмеченны слоев в пункте "Исходные слои" будет соответствовать последовательности каналов в многоканальном изображении. Первый растр будет соответствовать каналу №1, второй растр - каналу № 2 и т.д. 
:::

Для создания многоканального изображения необходимо поставить чек-бокс в пункте **"Поместить каждый входной слой в отдельный канал"**, иначе склейка изображений произойдет в виде мозайки. "Выходной тип данных" должен соответствовать данным растровых изображений. Результатом применения инструмента станет временный многоканальный растровый слой "Результат объединения".

!! Видео - настройка последовательности каналов.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Объедините созданные в предыдущих заданиях растровые слои в многоканальное изображение: 1 канал - "Экспозиция"; 2 канал - "Крутизна", 3 канал - "Индекс топографического положения"; 4 канал - "DEM" в многоканальное изображение. Сохраните полученное изображение в папку проекта под названием "DEM_indexes".
:::


## Классификация многоканального изображения 

Созданный многоканальный растр позволяет провдить фильтрацию сразу по нескольким каналам (переменным). Для этого используется **"Растр" > "Калькулятор растров"**.

!! Дополнить.


## Конвертация растрового слоя в векторный

Использование растра из предыдущего задания для конвертации классифицированного изображения в вектор.




## Создание изолиний

Инструмент **"Растр" > "Извлечение" > "Создать изолинии..** используется для построения изолиний (горизонталей). В пункте "Исходный слой" указывается цифровая модель рельефа, пункт **"Расстояние между изолиниями"** определяет высоту сечения рельефа в метрах. Результатом применения инструмента является временный векторный слой горизонталей с атрибутом "ELEV" в котором указана высота каждой конкретной горизонтали.

!! Картинка инструмента

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Создайте слой горизонталей с высотой сечения рельефа 10 метров, по примеру выше. Сохраните полученный векторный слой на диск под названием "Горизонтали".
:::

## Оформление изолиний

!!Разная толщина и подписи горизонталей.
!!Задание, создать макет с оформленными подписями горизонталей.

Для оформления изолиний применяются "Символизация на основе правил" и "Подписи на основе правил" (вкладки "Стиль" и "Надписи" контекстного меню слоя). Символизация должна соответствовать следующим условиям: горизонтали оформляются коричневой линией; горизонтали, отметки которых кратны 50, оформляются утолщенной линией. Для второго условия применяется оператор `%` который возвращает остаток от деления. Для горизонталей, отметка которых кратна 50 метров, выражение `"ELEV" % 50` будет возвращать значение **0** ("ELEV" - поле в слое "Горизонтали" которое содержит отметку для каждой горизонтали).

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Настройте стиль слоя "Горизонтали" так, что бы горизонтали с отметками кратными 50 имели толщину линий 0.46, а все остальные горизонтали толщину 0.1. Цвет горизонталей коричневый. Для этого перейдите в контекстрое меню слоя **"Стиль" > режим "Символизация на основе правил"**.
:::

!! Рисунок с результатом выполнения задания

Подписываются горизонтали кратные 50. В этом случае используюется режим "Подписи на основе правил" а так же выражение `"ELEV" % 50 = 0` по аналогии с предыдущим заданием.
Для подписей так же настраивается "Размещение" подписей. "Режим" - параллельно, "Разрешенные позиции" - на линии. "Повтор подписей": "Интервал" - 5000, "метры в масштабе". 

!!Картинка настройки размещения подписей



::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Добавьте подписи для горизонталей, отметки которых кратны 50. Для этого перейдите в меню слоя (**"Стиль" > "Надписи" > режим "Подписи на основе правил"**) и настройте подписи.
:::

! Картника результата задания.


::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Создайте макет который должен включать раскрашенную цифровую модель рельефа, горизонтали (без подпсей) и реки из слоя "rivers". Результат должен быть сохранен в виде изображения и соответствовать рисунку ниже.
:::


!! Добавить настройка стиля для классифицированного изображения.


## Создание профиля

!! Добавить текст.



