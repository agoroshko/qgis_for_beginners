# Работа с космическими снимками

```{r}
#| echo: false

# Нумерация заданий
ch <- 8 # Номер главы
t <- 1 # Номер первого задания (task)

task_fun <- function(ch, t){
  # Функция для добавление номера к заданию
  t <<- t+1
  paste(ch, t, sep = ".")
}

# Пример заголовка задания
## Задание `r task_fun(ch, t)`

# Заметки:

# Подготовить разные снимки для зимы и лета.

# Подраздел Искуственные цвета
# Настройки яркости и контраста.
# Рассмотреть несколько комбинаций цветов. Выделение объектов по этим комбинациям (c подписями в атрибутах).
# Выделение растительности (по NDVI), полей и открытых участков (по снежному покрову - NDSI), водных объектов (по NDWI).
# Почвенные индексы для детектирования открытой почвы.

# Работа с классифицированными картами (барталев, убыль лесов и т.д.)

# !! Инструмент "Определить обЪекты" добавить!!!
```


Космические снимки Landsat доступны для анализа любому пользователю и находятся в открытом доступе на сайте геологической службы CША (USGS https://earthexplorer.usgs.gov).

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Создайте новый проект и загрузите в него растровое изображение снимка "Landsat8.tif". Файл находится по ссылке: https://disk.yandex.ru/d/iscEIWG0Bo9wCQ
:::

Характеристики каналов спутника Landsat-8 с пространственным разрешением 30 м на пиксель, приведены в таблице ниже.

```{r}
#| echo: false
#| warning: false

library(gt)

# Таблица с характеристиками каналов спутника
l8_table <- data.frame(band = 1:7,
                       vave = c("0.43-0.45",
                                "0.45-0.51",
                                "0.53-0.59",
                                "0.64-0.67",
                                "0.85-0.88",
                                "1.57-1.65",
                                "2.11-2.29"),
                       name = c("Coastal Aerosol",
                                "Blue",
                                "Green",
                                "Red",
                                "Near-infrared",
                                "SWIR1",
                                "SWIR2"))


l8_table %>% 
  gt() %>% 
  cols_label(
    band = "Номер канала",
    vave = "Диапазон длин волн, мкм",
    name = "Название канала"
  ) %>% 
  as_raw_html()
# Оформить таблицу


```

## Комбинации искуственных цветов

Снимки содержат в отдельных каналах интенсивность излучения в определенной части спектра. Благодаря тому, что улавливаемые длины волн выходят за пределы видимого диапазона, возможен лучший анализ объектов на поврехности земли. Отображение поверхности земли в искуственных цветах позволяет учитываться спектральные характеристики объектов, выходящие за приделы выдимого диапазона. Для анализа состояния растительности особенно полезен ближний инфрокрасный диапазон (NIR) в котором наблюдается существенное отражение вегетативными органами растений при их нормальном состоянии и снижение отражения при повреждении.  
Для окраски растра в естественные цвета перейдите в пункт контекстного меню панели слоев **"Свойства слоя" > "Стиль"**, в пункте "Изображение" укажите режим "Многоканальное цветное" и задайте последовательность каналов **4-3-2** (здесь и в дальнейшем последовательность каналов указывается по порядку **красный-зеленый-синий**) @fig-nat_col.

![Настройка естественных цветов снимка](./pictures/8_1_Естественные цвета.png){#fig-nat_col}

Для задания нескольких комбинаций цветов для одного слоя возможно создать его дубликат. Для этого в контекстном меню панели слоев выберите пункт "Дублировать слой". Дубликат слоя появится в панеле слоев (@fig-duble_layer).

![Настройка естественных цветов снимка](./pictures/8_2_Дублирование слоя.png){#fig-duble_layer}

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Продублируйте слой "Landsat8". Задайте в качестве стиля слоя "Landsat8 копия" комбинацию естественных цветов 4-3-2. Переименуйте слой в "Landsat8 4-3-2".
:::

Анализ растительности часто проводится в комбинации каналов 5-4-3, при этом растительность отображается оттенками красного (хвойные леса принимают более темные оттенки, чем лиственные), городская застройка зелеными цветами, лед, снег и облака — белым или светло голубым.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Продублируйте слой "Landsat8". Задайте в качестве стиля слоя "Landsat8 копия" комбинацию искуственных цветов 5-4-3. Переименуйте слой в "Landsat8 5-4-3".
:::

## Индексы

Расчет индексов производится в калькуляторе растров.

### NDVI 

Для расчета **Normalized Difference Vegetation Index (NDVI)** на основе снимка Landsat8 используются каналы b4 (red) и b5 (Near-infrared) по формуле:
$$NDVI = (b5-b4)/(b5+b4)$$
где b4 - четвертый канал снимка Landsat8;  
b5 - пятый канал снимка Landsat8.

В калькуляторе растра это выражение будет иметь следующий вид:  
`("Landsat8@5"-"Landsat8@4") / ( "Landsat8@5"+"Landsat8@4")`.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Для слоя "Landsat8" рассчитайте NDVI. Новый слой сохраните на диск под названием "Landsat8_NDVI".
:::

Диапазонам значений NDVI соответствует определенная характеристика поверхности земли (таблица ниже).

```{r}
#| echo: false

ndvi_df <- data.frame(ndvi = as.character(c(
  0.7, 0.5, 0.025, 0, -0.05, -0.25, -0.5)), 
  type = c(
  "Густая растительность", "Разряженная растительность", "Открытая почва",
  "Облака", "Снег и лед", "Вода", "Искуственные материалы (бетон, асфальт...)"
))

ndvi_df %>% 
  gt() %>% 
  cols_label(ndvi = "NDVI", type = "Характеристика поверхности") %>% 
  as_raw_html()


```

Задайте стиль отображения слоя "Landsat8_NDVI". Перейдите в **"Свойства..." слоя > "Стиль"**. В пункте "Изображение" выберите режим "Одноканальное псевдоцветное", в пункте "Интерполяция" - "Линейный", градиент - "Greens".

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Настройте стиль отображения слоя "Landsat8_NDVI" по примеру выше. Результат должен соответствовать рисунку ниже (@fig-task_ndvi).
:::

![Результат выполнения задания](./pictures/8_3_Результат задания.png){#fig-task_ndvi}

### NDWI

Normalized Difference Water Index (NDWI) позволяет отделить поверхность воды от других объектов на снимке (водная поверхность имеет значение **NDWI > 0.3**). Для расчета индекса на основе снимка "Landsat8" используются каналы b3 (Green) и b5 (Near-infrared) по формуле:


$$NDWI = (b3-b5)/(b3+b5)$$
где b3 - третий канал снимка Landsat8;  
b5 - пятый канал снимка Landsat8.

В калькуляторе растра это выражение будет иметь следующий вид:  
`("Landsat8@3"-"Landsat8@5") / ( "Landsat8@3"+"Landsat8@5")`.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Для слоя "Landsat8" рассчитайте NDWI. Новый слой сохраните на диск под названием "Landsat8_NDWI".
:::

## Классификация на основе индексов

Проведем классификацию территории, изображенной на снимке "Landsat8", на основе NDVI и NDWI. Территория будет разбита на 3 класса: 1 класс - водная поверхность, пиксели со значением NDWI > 0; 2 класс - территория занятая растительностью, пиксели со значением NDVI > 0.3; 0 класс - все оставшиеся пиксели. Для проведения классификации создайте многоканальное изображение из двух растров "Landsat8_NDVI" и "Landsat8_NDWI" (см. @sec-multichannel_img), назовите новое изображение "Landsat8_indexes" и сохраните в папку проекта.  
Используйте калькулятор растров что бы провести классификацию изображения в соответствии с указанными критериями (см. @sec-dem_classification).

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Классифицируйте многканальное изображение "Landsat8_indexes" на 3 класса по примеру выше. Сохраните результат на диск под названием "Landsat8_classified". Задайте изображению соответствующий стиль (режим "Палитра/Уникальные значения"), что бы результат соответствовал рисунку ниже (@fig-task_classif_l8).
:::

![Результат задания. Классификация изображения](./pictures/8_4_Результат классификации.png){#fig-task_classif_l8}

В результате классификации на снимке выделено 3 класса объектов: водная поврежность, растительность и остальное (дороги, здания, открытая почва, редкая растительность и др.)


## Hansen Global Forest Change

[Hansen Global Forest Change](https://developers.google.com/earth-engine/datasets/catalog/UMD_hansen_global_forest_change_2022_v1_10) - результат классификации космических снимков спутника Landsat 7 (пространственное разрешение 30 м/пиксель) начиная с 2000 года. Основной канал растрового изображения содержит пиксели со значениями от 0 до 22. Если в отдельном пикселе не обнаружена убыль леса (начиная с 2000 года) - значение пикселя 0. В случае выявления убили леса, указывается две последние цифры года, в котором эта убыль была зафиксирована (1-22).  
Для примера использования Hansen Global Forest Change построим классифицированное изображение с датами убыли лесов для каждого пикселя. Для этого в совйствах слоя "Hansen" выберите "Стиль" > режим "Палитра / Уникальные значения" и классифицируйте слой.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Классифицируйте изображение "Hansen" по примеру выше. Результат должен соответствовать изображению ниже (цвета могут не совпадать т.к. по умолчанию они выбираются случайным образом).
:::

На основе Hansen Global Forest Change рассчитайте площадь убыли лесов по годам на территории Бирюсинского участкового лесничества, Мининского лесничества (векторный слой "Birusa.gpkg"). Для этого обрежьте растр по маске участкового лесничества (см @sec-dem_crop) после чего используйте инструмент **"Отчет об уникальных значениях растрового слоя"** который находится в панеле "Инструменты анализа" ![Панель инструментов](./icons/7_1_панель инструментов.png). В пункте "Таблица уникальных значений" выберите "Создать временный слой". В появившемся слое "Таблица уникальных значений" для каждого значения растра рассчитано количество ячеек (поле "count") и суммарная площадь в $m^2$ (поле "m2"). 

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
По примеру выше рассчитайте площадь убыли лесов по годам на территории Бирюсинского участкового лесничества. Переведите пльщадь в гектары, для этго создайте новое поле "ha", тип поля - десятичное и заполните его площадью в гектарах для каждой категории. Результат выполнения задания изображен на рисунке ниже.
:::

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Разделите растр Hansen Global Forest Change на 3 класса: 0 класс - без изменений; 1 класс - изменения с 2001 по 2017 год; 2 класс - изменения с 2018 по 2022 год. Результат выполнения задания должен соответствовать изображению ниже (!!ссылка).
:::

!! Результат задания.

Классифицированные изображения MODIS.








