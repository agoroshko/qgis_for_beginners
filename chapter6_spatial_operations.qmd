# Пространственные операции

::: {.callout-note}
## Загрузите файлы!
Для выполнения заданий из раздела "Запросы" загрузите файлы по [ссылке 1](https://github.com/agoroshko/qgis_for_beginners/tree/main/files) или [ссылке 2](https://disk.yandex.ru/d/sctgkoDXQdI7Vw) и создайте новый проект:

- Создайте новую папку проекта под названием "Раздел 6" а так же новый проект в QGIS;
- Загрузите файлы в QGIS;
- Задайте систему координат проекта EPSG:32646;
- Сохраните файл проекта в папку проекта. 
:::

Панель меню **"Вектор" > "Геообработка"** содержит основные инстументы для изменения векторных объектов (@fig-geotools). 

![Инструменты геообработки](./pictures2/6_1_Инструменты геообработки.png){#fig-geotools}

Результатом применения каждого инструмента является временный векторный слой с измененной геометрией. Временные слои помечены иконкой ![1](./QGIS_icons/mIndicatorMemory.svg) справа от названия (см. @fig-temp_layer).

![Временный слой "Буферизовано" в панеле слоев](./pictures/6_2_временный слой в панеле слоев.png){#fig-temp_layer}

Если требуется сделать временный слой постоянным, в контекстном меню слоя выберите пункт **"Сохранить на диск..."** и задайте параметры сохранения, в противном случае, после закрытия проекта данные слоя будут потеряны. При попытке закрытия проекта с несохраненными временными слоями появится соответствующее предупреждение (@fig-temp_layers_warn).

![Предупреждение о несохраненных временных слоях](./pictures/6_1_Предупреждение о временных слоях.png){#fig-temp_layers_warn}

## Изменение системы координат слоя {#sec-ref_sys}

В некоторых случаях требуется изменить систему координат слоя. Например, для построения буфера (см. @sec-buffer) в метрах (а не градусах) тебуется спроецированная (плоская) система координат. Изменить систему координат векторного слоя возможно при помощи инструмента **"Вектор" > "Управление данными" > "Перепроецировать слой..."**. В пункте **"Исходный слой"** задается слой, проекцию которого необходимо изменить. Пункт **"Целевая система координат"** определяет новую систему координат. По умолчанию инстумент создает временный слой (@fig-reproject_layer).

![Инструмент "Перепроецировать слой"](./pictures/6_3_Перепроецировать слой.png){#fig-reproject_layer}

::: {#task-task_rivers_reproj .callout-tip}
Перепроецируйте слой "rivers" в систему координат "EPSG:32646 - WGS84 / UTM zone 46N". Переименуйте появившийся временный слой из "Перепроецировано" в "rivers UTM" и сохраните в папку проекта.
:::

## Создание буферной зоны{#sec-buffer}

Инструмент **"Вектор" > "Геообработка" > "Буферизация..."** создает область заданного радиуса вокруг каждой геометрии слоя (буферная зона или буфер). Единицы измерения радиуса (задается в пункте **"Расстояние"**) будут зависить от системы координат слоя. В географической системе координат радиус задается в угловой мере (градусах), что не очень удобно. Поэтому для построения буфера в линейной мере (метрах, километрах и т.д.), сначала проводят перепроецирование в "плоскую" (спроецированную) систему координат (это действие было выполнено в предыдущем @task-task_rivers_reproj), после чего строят буфер заданного радиуса. Чек-бокс **"Результат объединения..."** определяет будет результат представлен объединенной геометрией или отдельными геометриями для каждого объекта (@fig-buffer). 

![Инструмент "Буферизация"](./pictures2/6_3_Инструмент буферизации.png){#fig-buffer}

::: {#task-task_buffer .callout-tip}
Постройте буферы радиусом 100 метров вокруг рек (слой "rivers UTM"). Слою буферных зон задайте название "буфер рек 100 м". Результат выполнения задания изображен на рисунке ниже (@fig-buffer_result).

![Результат применения инструмента "Буферизация"](./pictures/6_5_результат буферизации.png){#fig-buffer_result}
:::

## Инструменты геообработки   

Часто требуется обрезать один слой по границам другого. Для выполнения такой операции применяется инструмент **"Вектор" > "Геообработка" > "Обрезать..."**. Алгоритм обрезает **"Исходный слой"** по границам **"Слоя наложения"**. В результате будут сохранены только те части **исходного слоя**, которые пересекаются со **слоем наложения** (@fig-cut). 

![Инструмент "Обрезать"](./pictures2/6_4_Инструмент обрезать.png){#fig-cut}

::: {#task-task_cut .callout-tip}
Создайте слой частей выделов, которые попадают в стометровые буферные зоны вокруг рек. Для этого, по примеру выше, примените инструмент "Обрезать..." к слоям "videl" и "буфер рек 100 м". Сохраните временный слой на диск под названием "Части выделов в водоохранной зоне". Результат выполнения задания приведен на рисунке ниже (@fig-cut2).

![Применение инструмента "Обрезать"](./pictures/6_7_части выделов в водоохранной зоне.png){#fig-cut2}
:::

Похожим на инструмент **"Обрезать"** функционалом обладает инструмент **"Вектор" > "Геообработка" > "Пересечение..."**. Однако, если первый просто обрезает по границе, инструмент пересечение так же копирует атрибуты слоя наложения в исходный слой. Воспользуемся инструментом **"Пересечение"** что бы определить к водоохранным зонам каких рек принадлежит та или иная часть выдела. На данный момент в проект имеется слой "Буфер рек 100 м" в атрибутах которого присутствует поле "name", определяющее к какой реке относится тот или иной буфер (это поле было наследовано из слоя rivers) (@fig-intersect_atribut). Используем слои "videl" и слой "Буфер рек 100 м" в инструменте "Пересечение" (@fig-intersect_tool). В настройках инструмента возможно задать поля исходного слоя и слоя наложения, которые останутся в результирующем слое (по умолчанию выбраны все поля). В исходном слое выберем поля: **"fid", "kvartal", "videl", "zapax_1_ha"** (@fig-intersect_layer1). В слое наложения выберем поле **"name"** (@fig-intersect_layer2). В результате применения инструмента в панеле слоев появится новый временный слой "Пересечение". Результат будет идентичен применению инструмента **"Обрезать"**, за исключением таблицы атрибутов, которая будет содержать выбранные поля одного и другого слоя.


::: {#fig-intersect_settings layout-ncol=2}

![Таблица атрибутов слоя "Буфер рек 100 м"](./pictures2/6_5_1_Атрибуты буфера.png){#fig-intersect_atribut}

![Окно настройки инструмента "Пересечение"](./pictures2/6_5_2_Инструмент Пересечение.png){#fig-intersect_tool}

![Сохраняемые исходные поля](./pictures2/6_5_3_Сохраняемые исходные поля.png){#fig-intersect_layer1}

![Сохраняемые поля слоя наложения](./pictures2/6_5_4_Сохраняемые поля слоя наложения.png){#fig-intersect_layer2}



Настройки инструмента "Пересечение"
:::



::: {#task-task_cut .callout-tip}

- По примеру выше, примените инструмент "Пересечение" к слоям "videl" и "Буфер рек 100 м". 
- Полученный векторный слой сохраните на диск под названием "Результат пересечения выделов и буферных зон". 
- Задайте стиль слоя так, что бы выделить цветом выделы, принадлежащие буферным зонам разных рек. Результат выполнения задания отображен на рисунках ниже (@fig-intersect_result, @fig-task_intersect).

![Таблица атрибутов слоя "Результат пересечения выделов и буферных зон"](./pictures2/6_6_2_Таблица атрибутов слоя пересечение.png){#fig-intersect_result}

![Применение инструмента "Пересечение"](./pictures2/6_6_Результат пересечения.png){#fig-task_intersect}
:::



```{r}
#| echo: false
# !!!! Добавить: буферы переменного радиуса??????
```


Инструмент **"Вектор" > "Геообработка" > "Разность..."** проводит обратную операцию: из исходного слоя вырезаются части, пересекающиеся со слоем наложения.

::: {#task-task .callout-tip}
Используя инструмент "Разность", вырежите части выделов, которые попадают в стометровые буферы вокруг рек. Для этого примените инструмент "Разность..." к слоям "videl" и "Буфер рек 100 м". Результат выполнения задания приведен на рисунке ниже (@fig-diff).

![Инструмент "Разность"](./pictures/6_8_инструмент разница.png){#fig-diff}
:::

Инструмент **"Вектор" > "Геообработка" > "Объединение по признаку..."** позволяет объединить объекты с одинаковыми атрибутами. Например, он дает возможность создать границы лесных кварталов из слоя выделов. Для этого в качестве **"Исходного слоя"** выбирают слой выделов, в пункте **"Поля классификации"** выбирают поле для объединения объектов ("kvartal") (@fig-merge_by_attr). В результате применения инструмента, границы выделов с одинаковым номером квартала будут стерты и таким образом образуют квартальную сеть.

![Настройки инструмента "Объединение по признаку"](./pictures2/6_7_Объединение по признаку.png){#fig-merge_by_attr}

::: {#task-task .callout-tip}
По примеру выше, объедините выделы в слое "videl" по полю "kvartal". В результате должен появиться новый временный слой с границами кварталов (см. @fig-merge_result). Сохраните слой на диск под названием "kvartal".

![Результат применения инструмента "Объединение по признаку"](./pictures2/6_8_Квартальная сеть.png){#fig-merge_result}
:::

```{r}
#| echo: false
# !!!!!!! Добавить задания по другим инструментам !!!
```


## Подсчет длины, площади и периметра геометрий.

Программа QGIS позволяет совершить автоматический расчет площади, периметра и длины геометрий. При таком расчете важно обратить внимание на единицы измерения величин. Единицы измерения длины (так же как периметра и площади) зависят от настроек проекта. Для их изменения перейдите в пункт меню **"Проект" > "Свойства" > во вкладке "Общие" найдите раздел "Измерения"**. Пункты **"Единицы измерения расстояния"** и **"Единицы измерения площади"** задают соответствующие единицы измерения.

::: {#task-task_measure_units .callout-tip}
Перейдите в пункт меню **"Проект" > "Свойства" > во вкладке слева "Общие" найдите раздел "Измерения"** (см. @fig-measure_units). Пункты **"Единицы измерения расстояния"** укажите "метры" в пункте **"Единицы измерения площади"** укажите "гектары". Примените изменения.

![Настройка единиц измерения проекта](./pictures2/6_9_Единицы измерения.png){#fig-measure_units}
:::

Для подсчета длины геометрий, в таблице атрибутов создают новое поле (тип поля целое или десятичное число) и заполняют его выражением `$length` которое вычисляет длину для каждой геометрии слоя.

::: {#task-length .callout-tip}
В слое **"roads"** создайте новое поле **"length_m"** (тип поля целое число). Заполните это поле длиной каждой из дорог в метрах. Сохраните изменения в слое. Cуммарная длина дорог должна составить **17 055 м** (см. @vid-length).

![Подсчет длины дорог для слоя "roads"](./videos/6_1_длина дорог.mp4){#vid-length}
:::

Периметр и площадь геометрий вычисляются аналогично при помощи функций `$perimeter` и `$area` соответственно.

::: {#task-perim .callout-tip}
В слое **"videla"** создайте новое поле **"perimeter_m"** (тип поля десятичное число). Заполните это поле значениями периметра (в метрах) для каждого выдела. Сумма периметров выделов должна составить **335 649,9 м**.
:::

Для выполнения предыдущих заданий (@task-length, @task-perim) использовались два действия:
1. Создавалось поле с нужным типом данных
2. Созданное поле заполнялось значениями функции ($length, $area и др.)
Инструмент "Калькулятор полей" позволяет совместить эти два действия: задаются параметры поля и функция, значениями которой это поле будет заполнено.

!!! Рисунок Калькулятора полей с настройками заполнения поля area_ha

::: {#task-calc_area .callout-tip}
В слое **"videla"** при помощи **калькулятора полей** создайте новое поле **"area_ha"** (тип поля десятичное число) заполненное значением площади (в гектарах) для каждого выдела. Сумма площадей выделов должна составить **1 039,8 га**.
:::

## Арифметические операции с атрибутами

После выполнения @task-calc_area в слое "videla" будут находиться два поля с площадью. Поле "s_ha" это данные площади выдела по таксационным описаниям. Второе поле "area_ha" было создано при выполнении @task-calc_area и содержит площади геометрий, рассчитанные автоматически. 
Отличаются ли эти две площади? Для сравнения двух значений создайте новое поле "diff_area" (десятичное) куда будет записана разность значений двух полей (выражение `"s_ga" -  "area"`). По разнице можно оценить насколько значения двух полей различаются.

::: {#task-task_diff_area .callout-tip}
+ В слое **"videla"** создайте поле **"diff_area"**. Заполните это поле выражением `"s_ha" - "area"` для подсчета различий между площадями. 
+ Создайте карту, где выделы с разностью по абсолютному значению более 0.3 га будут окрашены в красный цвет. Обртите внимание - разность может быть как положительной, так и отрицательной, для получения абсолютного значения используйте функцию `abs()`. 
+ Создайте новый макет и сохраните карту как изображение. Результат выполнения задания приведен на рисунке ниже (@fig-diff_03).
:::

![Выделы с ошибкой площади более 0,3 га](./pictures/6_9_разница 0,3 га.png){#fig-diff_03}

Более корректно использовать относительную разность (в процентах) а не абсолютные значения. Для этого создадим новое поле "diff_area_perc" (тип поля - десятичное) и заполним его выражением `abs("area" * 100 / "s_ga" - 100)`. Функция `abs()` возвращает абсолютное значение выражения в скобках.

::: {#task-task .callout-tip}
+ В слое **"videla"** создайте новое поле "diff_area_perc". Заполните это поле относительной разностью полей `abs("area" * 100 / "s_ga" - 100)`. 
+ Создайте карту, где выделы с разностью более 15 % (поле "diff_area_perc") будут окрашены в красный цвет.
+ Создайте новый макет и сохраните карту как изображение. Результат выполнения задания приведен на рисунке ниже (@fig-diff_15).
:::

![Выделы с ошибкой площади более 15 %](./pictures/6_10_разница 15 perc.jpg){#fig-diff_15}


## Кейс 6.1

::: {#task-task .callout-tip}
Рассчитайте запас насаждений в водоохранных зонах Караульного лесничества. Выполните следующие этапы задания:

+ Постройте буферные зоны радиусом 50 метров вокруг рек (см. @task-task_buffer).
+ Создайте новый слой, содержащий части выделов, попадающих в водоохранные зоны (см. @task-task_cut).
+ Рассчитайте площади частей выделов, попадающих в водоохранные зоны. Для этого создайте новое поле "area_buffer_ha", заполните его площадью частей выделов (в гектарах) (см. @task-calc_area).
+ Рассчитайте запас для частей выделов. Для этого создайте новое числовое поле "zapas_buffer", заполните его произведением новой площади выдела (поле "area_buffer_ha") и запаса на 1 га (поле "zapas_1ga") (см. @task-task_diff_area).
+ Сохраните таблицу с запасами в водоохранной зоне как табличный файл Excel (.xlsx). Для этого в контекстном меню слоя выберите пункт "Экспорт" > "Сохранить объекты как...", после чего укажите необходимый формат и сохраните файл в папку проекта.
+ Проведите подсчет суммарного запаса в водоохранных зонах, запас должен быть равен **15 279,11 $м^3$**.
:::



```{r}
#| echo: false

## Кейс 2
#Постройте карту с зонами такс для лесничества.


# пролоджение раздела в файле chapter.6_2_new.qmd

# Финальное задание доработать!!!!

# !!Видео выполнения задания добавить!



# !! Добавить задания на основе osm и границ лесничеств КК.
# !!! Рассчитать протяженность дорог в границах какого-либо лесничества (суммарную протяженность показать в таблице).
# !!! Найти точки пересечения рек и дорог в границах лесничества.
```


