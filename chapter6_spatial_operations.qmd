# Пространственные операции

!!! Создание нового проекта добавить

Панель меню **"Вектор" > "Геообработка"** содержит инстументы для изменения геометрий объектов. Результатом каждого инструмента является временный векторный слой с измененной геометрией. 

!!! Картинка инструментов геообработка !!!

Временные слои помечены символом ![1](./QGIS_icons/mIndicatorMemory.svg) справа от названия (@fig-temp_layer).

![Временный слой "Буферизовано" в панеле слоев](./pictures/6_2_временный слой в панеле слоев.png){#fig-temp_layer}

Содержимое временного слоя возможно сохранить выбрав в контекстном меню слоя пункт **"Сохранить на диск..."**, в противном случае, после закрытия проекта данные слоя будут потеряны. При попытке закрытия проекта с несохраненными временными слоями появится соответствующее предупреждение (@fig-temp_layers_warn).

![Предупреждение о несохраненных временных слоях](./pictures/6_1_Предупреждение о временных слоях.png){#fig-temp_layers_warn}

## Изменение системы координат слоя {#sec-ref_sys}

В некоторых случаях требуется изменить систему координат слоя. Например, для построения буфера (@sec-buffer) в метрах (а не градусах) тебуется спроецированная (плоская) система координат. Изменить систему координат векторного слоя возможно при помощи инструмента **"Вектор" > "Управление данными" > "Перепроецировать слой"**. В пункте **"Исходный слой"** задается слой, проекцию которого необходимо изменить. Пункт **"Целевая система координат"** определяет новую систему координат. По умолчанию инстумент создает временный слой (@fig-reproject_layer).

![Инструмент "Перепроецировать слой"](./pictures/6_3_Перепроецировать слой.png){#fig-reproject_layer}

::: {#task-task_rivers_reproj .callout-tip}
Перепроецируйте слой "rivers" в систему координат "EPSG:32646 - WGS84 / UTM zone 46N". Переименуйте появившийся временный слой из "Перепроецировано" в "rivers UTM" и сохраните в папку проекта.
:::

## Создание буфера{#sec-buffer}

Инструмент **"Вектор" > "Геообработка" > "Буферизация..."** создает область заданного радиуса вокруг каждой геометрии слоя. Единицы измерения радиуса (задается в пункте **"Расстояние"**) будут зависить от системы координат слоя. В географической системе координат радиус задается в угловой мере (градусах), что не очень удобно. Поэтому для построения буфера в линейной мере (метрах, километрах и т.д.), сначала проводят перепроецирование в "плоскую" (спроецированную) систему координат (это действие было выполнено в предыдущем @task-task_rivers_reproj), после чего строят буфер заданного радиуса. Чек-бокс **"Результат объединения..."** определяет будет результат представлен объединенной геометрией или отдельными геометриями для каждого объекта (@fig-buffer). 

![Инструмент "Буферизация"](./pictures/6_4_инструмент буферизация.png){#fig-buffer}

!!! Обновить рисунок выше.!!!

::: {#task-task .callout-tip}
Постройте буферы радиусом 100 метров вокруг рек (слой "rivers UTM"). Появившейся слой переименуйте в "буфер рек 100 м". Результат построения буфера изображен на рисунке ниже (@fig-buffer_result).
:::

![Результат применения инструмента "Буферизация"](./pictures/6_5_результат буферизации.png){#fig-buffer_result}

## Инструменты геообработки   

Часто требуется обрезать один слой по границам другого. Для выполнения такой операции применяется инструмент **"Вектор" > "Геообработка" > "Обрезать..."**. Алгоритм обрезает векторный слой (задается в пункте **"Исходный слой"**), используя полигоны дополнительного слоя (задается в пункте **"Слой наложения"**). В результат будут добавлены только те части объектов исходного слоя, которые пересекаются геометриями слоя наложения (@fig-cut). 



![Инструмент "Обрезать"](./pictures/6_6_инструмент отсечь.png){#fig-cut}

!!! Обновить картинку.

::: {#task-task .callout-tip}
Сохраните части выделов, которые попадают в стометровые буферы вокруг рек. Для этого, по примеру выше, примените инструмент "Отсечь..." к слоям "videla" и "буфер рек 100 м". Сохраните слой временный слой на диск под названием "Части выделов в водоохранной зоне". Результат выполнения задания приведен на рисунке ниже (@fig-cut2).
:::

![Инструмент "Отсечь"](./pictures/6_7_части выделов в водоохранной зоне.png){#fig-cut2}

!!!! Добавить описание инструмента и задание по его использованию.

Атрибуты исходного слоя остаются неизменными в отличие от инструмента **"Вектор" > "Геообработка" > "Пересечение"** в результате использования которого атрибуты результирующего слоя содержат атрибуты исходного слоя и слоя наложения 

!!!!



Инструмент **"Вектор" > "Геообработка" > "Разность..."** проводит обратную операцию. В результате из исходного слоя вырезаются области пересечения со слоем наложения.

::: {#task-task .callout-tip}
Вырежите части выделов, которые попадают в стометровые буферы вокруг рек. Для этого примените инструмент "Разность..." к слоям "videla" и "буфер рек 100 м". Результат выполнения задания приведен на рисунке ниже (@fig-diff).
:::

![Инструмент "Разность"](./pictures/6_8_инструмент разница.png){#fig-diff}
!!! Обновить рисунок !!!

Инструмент **"Вектор" > "Геообработка" > "Объединение по признаку..."** позволяет объединить объекты с одинаковыми атрибутами. Например, возможно создать границы лесных кварталов из слоя выделов. Для этого в качестве "Исходного слоя" выбирают слой выделов, в пункте "Поля классификации" выбирают поле "kvartal". (рисунок добавить)

::: {#task-task .callout-tip}
По примеру выше, объедините выделы по полю "kvartal". В результате должен появиться новый временный слой с границами кварталов. (добавить рисунок).
:::


!!! Инструмент Объединение. Добавить описание выше.

!!! Добавить задания по другим инструментам !!!

## Подсчет длины, площади и периметра геометрий.

Для подсчета длины геометрий, в таблице атрибутов создают новое поле (тип поля целое или десятичное число) и заполняют его выражением `$length` которое вычисляет длину для каждой геометрии слоя. Единицы измерения длины (так же как периметра и площади) зависят от настроек проекта. Для их изменения перейдите в пункт меню **"Проект" > "Свойства" > во вкладке слева "Общие" найдите раздел "Измерения"**. Пункты **"Единицы измерения расстояния"** и **"Единицы измерения площади"** задают соответствующие единицы измерения.

![Подсчет длины дорог для слоя "roads"](./videos/6_1_длина дорог.mp4){#vid-length}

::: {#task-task .callout-tip}
В слое **"roads"** создайте новое поле "length" (тип поля целое число). Заполните это поле длиной каждой из дорог в метрах. Сохраните изменения в слое. Cуммарная длина дорог должна составить **17055 м** (@vid-length).
:::

Периметр и площадь геометрий вычисляются аналогично при помощи функций `$perimeter` и `$area` соответственно.

::: {#task-task .callout-tip}
В слое **"videla"** создайте два новых поля "perimetr" и "area" (тип поля десятичное число). Заполните эти поля значениями периметра (в метрах) и площади (в гектарах) для каждого выдела. Сумма периметров и площадей выделов должна составить **335649,9 м и 1039,8 га** соответственно.
:::

## Арифметические операции с атрибутами

После выполнения задания предыдущего задания в слое "videla" будут находиться два поля с площадью. Поле "s_ga" это данные площади выдела по таксационным описаниям. Второе поле "area" было создано при выполнении задания. Для сравнения двух значений создайте новое поле "diff_area" (десятичное) куда будет записана разность значений двух полей (выражение `"s_ga" -  "area"`). По разнице можно оценить насколько значения двух полей различаются.

::: {#task-task .callout-tip}
+ В слое **"videla"** создайте поле **"diff_area"**. Заполните это поле выражением `"s_ga" - "area"` для подсчета различий между площадями. 
+ Создайте карту, где выдела с разностью по абсолютному значению более 0.3 га будут окрашены в красный цвет. Обртите внимание - разность может быть как положительной, так и отрицательной, для получения абсолютного значения используйте функцию `abs()`. 
+ Создайте новый макет и сохраните карту как изображение. Результат выполнения задания приведен на рисунке ниже (@fig-diff_03).
:::

![Выдела с ошибкой площади более 0,3 га](./pictures/6_9_разница 0,3 га.png){#fig-diff_03}

Более корректно использовать относительную разность (в процентах) а так же абсолютные значения. Для этого создадим новое поле "diff_area_perc" (тип поля - десятичное) и заполним его выражением `abs("area" * 100 / "s_ga" - 100)`. Функция `abs()` возвращает абсолютное значение аргумента.

::: {#task-task .callout-tip}
+ В слое **"videla"** создайте поле "diff_area_perc". Заполните это поле относительной разностью полей `abs("area" * 100 / "s_ga" - 100)`. 
+ Создайте карту, где выдела с разностью более 15 % (поле "diff_area_perc") будут окрашены в красный цвет.
+ Создайте новый макет и сохраните карту как изображение. Результат выполнения задания приведен на рисунке ниже (@fig-diff_15).
:::

![Выдела с ошибкой площади более 15 %](./pictures/6_10_разница 15 perc.jpg){#fig-diff_15}

::: {#task-task .callout-tip}
Рассчитайте запас насаждений в водоохранных зонах Караульного лесничества. Выполните следующие этапы задания:

+ Постройте буферные зоны радиусом 50 метров вокруг рек.
+ Создайте новый слой, содержащий части выделов, попадающих в водоохранные зоны.
+ Рассчитайте площади частей выделов, попадающих в водоохранные зоны. Для этого создайте новое поле "area_buffer_ha", заполните его площадью частей выделов (в гектарах).
+ Рассчитайте запас для частей выделов. Для этого создайте новое числовое поле "zapas_buffer", заполните его произведением новой площади выдела (поле "area_buffer_ha") на запас 1 га (поле "zapas_1ga").
+ Сохраните таблицу с запасами в водоохранной зоне как табличный файл Excel (.xlsx). Для этого в контекстном меню панели слоев выберите пункт "Экспорт" > "Сохранить объекты как...", после чего укажите необходимый формат и сохраните файл в папку проекта.
Суммарный запас в водоохранных зонах должен быть равен **15 279,11 $м^3$**.
:::





```{r}
#| echo: false

# пролоджение раздела в файле chapter.6_2_new.qmd

# Финальное задание доработать!!!!

# !!Видео выполнения задания добавить!



# !! Добавить задания на основе osm и границ лесничеств КК.
# !!! Рассчитать протяженность дорог в границах какого-либо лесничества (суммарную протяженность показать в таблице).
# !!! Найти точки пересечения рек и дорог в границах лесничества.
```
















