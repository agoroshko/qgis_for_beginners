# Пространственные операции с векторными объектами

```{r}
#| echo: false

# Нумерация заданий
ch <- 6 # Номер главы
t <- 1 # Номер первого задания (task)

task_fun <- function(ch, t){
  # Функция для добавление номера к заданию
  t <<- t+1
  paste(ch, t, sep = ".")
}

# Пример заголовка задания
## Задание `r task_fun(ch, t)`
```

Панель меню **"Вектор" > "Геообработка"** содержит инстументы для изменения геометрий объектов. Результатом каждого инструмента является временный векторный слой с измененной геометрией. Временные слои помечены символом ![Временный слой](./icons/6_1_временный слой.png) справа от названия (@fig-temp_layer).

![Временный слой "Буферизовано" в панеле слоев](./pictures/6_2_временный слой в панеле слоев.png){#fig-temp_layer}

Содержимое временного слоя возможно сохранить выбрав в меню слоя пункт **"Сохранить на диск..."**, в противном случае, после закрытия проекта данные слоя будут потеряны. При попытке закрытия проекта с несохраненными временными слоями появится соответствующее предупреждение (@fig-temp_layers_warn).

![Предупреждение о несохраненных временных слоях](./pictures/6_1_Предупреждение о временных слоях.png){#fig-temp_layers_warn}

## Изменение системы координат слоя {#sec-ref_sys}

В некоторых случаях требуется изменить систему координат слоя. Например, для построения буфера (@sec-buffer) в метрах (а не градусах) тебуется спроецированная (плоская) система координат. Изменить систему координат векторного слоя возможно при помощи инструмента **"Вектор" > "Управление данными" > "Перепроецировать слой"**. В пункте **"Исходный слой"** задается слой, проекцию которого необходимо изменить. Пункт **"Целевая система координат"** определяет новую систему координат. По умолчанию инстумент создает временный слой (@fig-reproject_layer).

![Инструмент "Перепроецировать слой"](./pictures/6_3_Перепроецировать слой.png){#fig-reproject_layer}

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Перепроецируйте слой "rivers" в систему координат "EPSG:32646 - WGS84 / UTM zone 46N". Переименуйте появившийся временный слой из "Перепроецировано" в "rivers UTM" и сохраните в папку проекта.
:::

## Создание буфера{#sec-buffer}

Инструмент **"Вектор" > "Геообработка" > "Буферизация..."** создает область заданного радиуса вокруг каждой геометрии слоя. Единицы измерения радиуса (задается в пункте **"Интервал"**) будут зависить от системы координат слоя. В географической системе координат радиус задается в угловой мере (градусах), что не очень удобно. Поэтому для построения буфера в линейной мере (метрах, километрах и т.д.), сначала проводят перепроецирование в "плоскую" (спроецированную) систему координат (это действие было выполнено в @sec-ref_sys), после чего строят буфер заданного радиуса. Чек-бокс **"Результат объединения"** определяет будет результат представлен объединенной геометрией или отдельными геометриями для каждого объекта (@fig-buffer). 

![Инструмент "Буферизация"](./pictures/6_4_инструмент буферизация.png){#fig-buffer}

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Постройте буферы радиусом 100 метров вокруг рек (слой "rivers UTM"). Появившейся слой переименуйте в "буфер рек 100 м". Результат построения буфера изображен на рисунке ниже (@fig-buffer_result).
:::

![Результат применения инструмента "Буферизация"](./pictures/6_5_результат буферизации.png){#fig-buffer_result}

## Пересечение полигонов    

Часто требуется обрезать один слой по границам другого. Для выполнения такой операции применяется инструмент **"Вектор" > "Геообработка" > "Отсечь..."**. Алгоритм обрезает векторный слой (задается в пункте **"Исходный слой"**), используя полигоны дополнительного слоя (задается в пункте **"Слой наложения"**). В результат будут добавлены только те части объектов исходного слоя, которые перекрываются геометриями слоя наложения. Атрибуты исходного слоя остаются неизменными в отличие от инструмента **"Вектор" > "Геообработка" > "Пересечение"** в результате использования которого атрибуты результирующего слоя содержат атрибуты исходного слоя и слоя наложения.

!! Результат показан на рисунке

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Сохраните части выделов, которые попадают в стометровые буферы вокруг рек. Для этого примените инструмент "Отсечь..." к слоям "videla" и "буфер рек 100 м".
:::

Инструмент **"Вектор" > "Геообработка" > "Разница"** проводит обратную операцию. В результате из исходного слоя вырезаются области пересечения со слоем наложения.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Вырежите части выделов, которые попадают в стометровые буферы вокруг рек. Для этого примените инструмент "Разница..." к слоям "videla" и "буфер рек 100 м". Результат выполнения задания приведен на рисунке ниже.
:::

!! Применение инструмента рисунок.


## Подсчеты длины, площади и периметра геометрий.

Для подсчета длины геометрий, в таблице атрибутов создают новое поле (тип поля целое или десятичное число), его заполняют выражением "$length" которое вычисляет длину для каждой геометрии слоя. Единицы измерения длины (так же как периметра и площади) зависят от настроек проекта. Для их изменения перейдите в пункт меню **"Проект" > "Свойства" > во вкладке слева "Общие" найдите раздел "Измерения"**. Пункты "Единицы измерения расстояния" и "Единицы измерения площади" задают соответствующие единицы измерения.

Видео добавления поля length

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
В слое "roads" создайте новое поле "length" (тип поля целое число). Заполните это поле длиной каждой из дорог в метрах.
:::

Периметр и площадь геометрий вычисляются аналогично при помощи функций "$perimetr" и "$area" соответственно.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
В слое "videla" создайте два новых поля "perimetr" и "area" (тип поля десятичное число). Заполните эти поля значениями периметра и площади (в гектарах) для каждого выдела.
:::

После выполнения задания `r task_fun(ch, t)` в слое "videla" будут находиться два поля с площадью. Поле "s_ga" это данные площади выдела по таксационным описаниям. Второе поле "area" было создано при выполнении задания `r task_fun(ch, t)`. Для сравнения двух значений создайте новое поле "diff_area" (десятичное) куда будет записана разность значений двух полей (выражение **"s_ga" -  "area"**). По разнице можно оценить насколько значения двух полей совпадают.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
В слое "videla" создайте поле "diff_area". Заполните это поле разностью полей "s_ga" - "area" (по примеру выше). 

Создайте карту, где выдела с разностью по абсолютному значению более 0.3 га будут окрашены в красный цвет. Обртите внимание - разность может быть как положительной, так и отрицательной.
:::

Пример полученной карты.

Более корректно использовать относительную разность (в процентах) а так же абсолютные значения. Для этого создадим новое поле "diff_area_perc" (тип поля десятичное) и заполним его выражением **abs("area" * 100 / "s_ga" - 100)**. Функция abs() возвращает абсолютное значение аргумента.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
+ В слое "videla" создайте поле "diff_area_perc". Заполните это поле относительной разностью полей **abs("area" * 100 / "s_ga" - 100)** (по примеру выше). 
+ Создайте карту, где выдела с разностью более 30 % (поле "diff_area_perc") будут окрашены в красный цвет. Результат изображен на рисунке ниже (!Рисунок)
:::

!!Рисунок с картой!! Лежит отдельным файлом


::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Проведите анализ запаса насаждений в водоохранных зонах Караульного лесничества. Выполните следующие этапы задания:
+ Постройте буферные зоны радиусом 100 метров вокруг рек.
+ Создайте новый слой, содержащий части выделов, попадающих в водоохранные зоны.
+ Рассчитайте площади частей выделов. Для этого создайте новое поле "area_new", заполните его площадью частей выделов (в гектарах).
+ Рассчитайте запас для частей выделов. Для этого создайте новое числовое поле "zapas_buffer", заполните его произведением новой площади выдела на запас 1 га (поле "zapas_1ga").
+ Сохраните таблицу с запасами в водоохранной зоне как табличный файл Excel (.xlsx).
:::


!!Видео выполнения задания добавить!



!! Добавить задания на основе osm и границ лесничеств КК.
!!! Рассчитать протяженность дорог в границах какого-либо лесничества (суммарную протяженность показать в таблице).
!!! Найти точки пересечения рек и дорог в границах лесничества.










