# Привязка растра

::: {.callout-note}
## Загрузите файлы!
Для выполнения заданий из этого раздела загрузите файлы по [ссылке](https://github.com/agoroshko/qgis_for_beginners/tree/main/files/ch1_%D0%9F%D1%80%D0%B8%D0%B2%D1%8F%D0%B7%D0%BA%D0%B0%20%D1%80%D0%B0%D1%81%D1%82%D1%80%D0%B0)
:::

Основой для создания плана лесонасаждений является сканированная копия плана лесонасаждений части Мининского лесничества, Караульного участкового лесничества Красноярского края. 
Для начала запустим программу QGIS. Для этого необходимо выбрать ярлык QGIS Desktop из папки QGIS на рабочем столе или в меню пуск. После открытия программы создается новый проект, для этого нужно перейти в пункт меню **Проекты > Создать** (@fig-makeproj).

![Создание проекта](./pictures/1_create_proj.png){#fig-makeproj}

Теперь можно приступить к привязке растра. Привязка растра означает определение для каждой точки растрового изображение координат в той или иной  системе координат. Топографические карты удобно привязывать по координатной сетке в прямоугольной зональной или географической системе координат (@fig-topomap).

![Топографическая карта с координатной сеткой](./pictures/2_map.png){#fig-topomap}

Планы лесонасаждений обычено не имеют координатной сетки, поэтому привязку осуществляют по квартальным столбам или хорошо опознаваемым точкам (реки, дороги и т.д.).

## Загрузка векторного слоя

Планы лесонасаждений не имеют координатной сетки. При таких условиях привязку возможно осуществить по космическим снимкам, например с помощью плагина "QuickMapServices", или по твердо опознаваемым точкам с уже известными координатами (например квартальных столбов). В нашем случае, растровое изображение будет привязываться к существующему векторному слою квартальной сети Караульного участкового лесничества. Для этого перейдите в меню **"Слой" > "Добавить слой" > "Добавить векторный слой..."** (@fig-addfile).

![Рисунок 3 - Добавление векторного слоя](./gif/1_add_file.gif){#fig-addfile}

Появится диалоговое окно в котором нажмите на **...** в пункте **"Векторный набор данных"**. Укажите расположение файла **"Квартальная сеть Караульное.shp"** после чего выберите **"Открыть"**.

::: {.callout-note}
## Обратите внимание!
Папка содержит несколько файлов с одинаковым названием но разными расширениями: "Квартальная сеть Караульное**.dbf**", "Квартальная сеть Караульное**.prj**", "Квартальная сеть Караульное**.shx**" и др. Такой тип файлов называется шейп-файлом (Shapefile). Хотя физически на диске это несколько файлов, при загрузке в ГИС они будут представлены как один векторный слой. Выбирать для загрузки необходимо только один файл с расширением **".shp"!** Подробнее о шейп-файлах можно прочитать по ссылке <https://ru.wikipedia.org/wiki/Shapefile>.
:::

В результате будет загружен векторный слой границ кварталов Караульного участкового лесничества. Для удобства добавим номера кварталов на карту. Функция добавления подписей будет рассмотрена более подробно в последующих разделах. Сейчас нажимаем правой кнопкой мыши на слой **"квартальная сеть Караульное"** в панеле слоев. Выберите пункт **Свойства... > Надписи**. В верхней части окна меняем выпадающую вкладку с **"Без подписей"** на **"Обычные подписи"**. В пункте **"Значение"** выбираем поле **"kvartal"** (в этом поле содержатся номера кварталов). После этого нужно сохранить изменения (**Применить**) и нажать **ОК** (@fig-addlabels).

![Добавление подписей к векторному слою](./gif/2_add_labels.gif){#fig-addlabels}

::: {#task-task .callout-tip}
Загрузите векторный слой "квартальная сеть Караульное.shp" и добавьте номера лесных кварталов по примеру выше.
:::

## Навигация по карте

Для перемещения по карте используется инструмент **Прокрутка карты** ![прокрутка карты](./QGIS_icons/mActionPan.svg) (так же этот инстумент активируется нажатием колесика мыши). **Масштаб карты** изменяется прокруткой колесика мышки. Более плавное изменение масштаба возможно при нажатой кавише **Ctrl и прокрутке колескика мышки**. Слева находится панель слоев, в которой отображаются все задействованные в проекте слои. Контекстное меню панели слоев (@fig-contextmenulayers) вызывается левым щелчком мыши и позволяет провети настройку отдельного слоя. Это меню часто используется, рассмотрим его основные элементы:

![Добавление подписей к векторному слою](./pictures/17_Контекстное меню панели слоев.png){#fig-contextmenulayers}

- "Увеличить до слоя" ![Увеличить до слоя](./QGIS_icons/mActionZoomToLayer.svg) - инструмент позволяет переместить слой в центр окна программы. Чаще всего применяется для быстрой навигации или если вы "потерялись" на карте и видите только белый экран.
- "Показывать количество объектов" - когда активирован, добавляет счетчик количества объектов напротив слоя в панеле слоев.
- "Показать подписи" ![Показать подписи](./QGIS_icons/mActionLabeling.svg) - позволяет быстро включить или отключить подписи объектов слоя. Стиль подписей настраивается в свойствах слоя.
- "Переименовать слой" позволяет изменить название слоя в панеле слоев.
- "Дублировать слой" ![Дублировать слой](./QGIS_icons/mActionDuplicateLayer.svg) создает дубликат слоя. При этом изменения в слое-оригинале будут отображаться в слое-копии и наоборот т.к. файл-источник для слоев остается общим. Однако для копии и оригинала возможно настроить отличающиеся стили отображения.
- "Удалить слой" ![Удалить слой](./QGIS_icons/mActionRemoveLayer.svg) удаляет слой из панели слоев, при этом файл-источник не удаляется.
- "Переместить в конец", "Переместить в начало" перемещает слой в конец или начало списка в панеле слоев. Порядок в списке влияет на порядок отображения слоев.
- "Открыть таблицу атрибутов" ![Открыть таблицу атрибутов](./QGIS_icons/mActionOpenTable.svg) - открывает таблицу атрибутов слоя.
- "Режим редактирования" ![Режим редактирования](./QGIS_icons/mActionToggleEditing.svg) переводит слой в режим редактирования.
- "Фильтр" настраивает фильтрацию объектов по значениям таблицы атрибутов.
- "Видимость в приделах масштаба..." слой отображается только при заданном диапазоне масштабов.
- "Экспорт" позволяет сохранить слой в файл. Возможны разные форматы сохранения: .shp, .gpkg, .gpx, .xlsx и др.
- "Стили" дает доступ к быстрому изменению стиля отображения объектов а так же к возможности копировать настройки стиля одного слоя и применить их к другому слою.
- "Свойства..." наиболее часто используемый пункт. Позволяет настроить слой, включая стиль отображения, надписи, систему координат и др.

::: {#task-task .callout-tip}
Измените положение карты и масштаб. Изучите контекстное меню панели слоев на примере загруженного ранее слоя "Квартальная сеть Караульное".
:::

## Добавление контрольных точек

::: {.callout-caution icon=false title="Дополнительные ресурсы:"}
- [Картетика - Все что нужно знать о привязке растров;](https://cartetika.ru/tpost/ae1ph1lcj1-vse-chto-nuzhno-znat-o-privyazke-rastrov?utm_source=telegram&utm_medium=post&utm_campaign=text)
- [NextGIS - Привязка растров.](https://docs.nextgis.ru/docs_ngqgis/source/raster_ref.html)
:::

Теперь все приготовления завершены и можно приступать к самой привязки растра. Для начала необходимо выбрать изображение, которое будет привязываться. В папке **планы лесонасаждений** находится несколько сканированных изображений. Выберите одно из них, и сразу определите 1 квартал, привязку которого будете осуществлять. Выбранный квартал не должен быть обрезан по границе изображения. Для примера привязка осуществлялась для изображения "3.jpg" квартал 46. После этого в QGIS перейдите во вкладку **Слой > Привязка растров...** (@fig-addlabels).

![Окно привязки растров](./gif/3_georef.gif){#fig-georef}

Откроется окно **"Привязка растров"** которое состоит из двух областей разделенных горизонтальной чертой. В верхней области будет отображаться растровое изображение и контрольные точки, в нижней, которая называется **"Контрольные точки"**, появится таблица с характеристиками контрольных точек. Для загрузки растра выберите иконку **"Открыть растр..."** ![1](./QGIS_icons/mActionAddRasterLayer.svg) после чего укажите растр для привязки. Растр привязывается путем расстановки контрольных точек с известными координатами. Для работы с контрольными точками применяют инструменты **"Добавить точку"** ![1](./QGIS_icons/georeferencer/mActionAddGCPPoint.svg), **"Удалить точку"** ![1](./QGIS_icons/georeferencer/mActionDeleteGCPPoint.svg), **"Переместить точку"** ![1](./QGIS_icons/georeferencer/mActionMoveGCPPoint.svg), которые выполняют соответствующие действия. Для добавления контрольных точек активируйте инструмент **"Добавить точку"**. Контрольные точки расставляются в местах квартальных столбов. Больше подробностей о привязке растровых изображений можно найти на форуме [gis-lab.info](https://gis-lab.info/qa/georef-qgis.html#.D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_QGIS_.D0.B8_.D0.BC.D0.BE.D0.B4.D1.83.D0.BB.D1.8F_.D0.BF.D1.80.D0.B8.D0.B2.D1.8F.D0.B7.D0.BA.D0.B8).  
Поставив точку на карте, появится диалоговое окно, которое позволяет задать координаты точки вручную или использовать координаты этой точки с уже привязанной карты. Выберите пункт **"С карты"** ![1](./icons/1_с карты.png), после чего откроется основное окно программы, где необходимо выбрать ту же точку на векторном слое, который мы загрузили ранее. Таким образом устанавливается соответствие между уже имеющим привязку векторным слоем лесных кварталов и растровым изображением без привязки. Контрольные точки расставляются по всем видимым на растровом изображении квартальным столбам. Чем таких точек больше, тем точнее получится привзяка (@fig-points).

![Добавление контрольных точек](./gif/4_georef_points.gif){#fig-points}

После расставления всех контрольных точек необходимо задать параметры трансформации (иконка **Параметры трансформации** ![1](./icons/1_параметры трансформации.png)). В открывшемся окне выбрать **"Тип трансформации" > "Линейный"**» и нажать **ОК** (@fig-privazka). Теперь в нижней части окна привязки растров появилось числовое значение невязки для каждой точки, в верхней части эта невязка отображается в виде красных линий, соединенных с контрольными точками. Чем меньше значения невязки, тем точнее привязана карта. Невязки измеряются в пикселях изображения, значения меньше 5 единиц вполне допустимы для нашей работы. В случае больших значений, контрольные точки с максимальной невязкой можно удалить или переместить так, что бы уменьшить невязку. Так же невязка зависит от типа трансформации изображения, при изменении которого невязки будут пересчитаны и могут измениться как в большую, так и в меньшую сторону.

![Настройка параметров трансформации](./pictures/3_Параметры трансформации.png){#fig-privazka}

В программе доступно несколько типов трансформации изображения. Типы линейный и Гельмерта не искажают изображения. При выборке чекбокса **"Только создать world-файл (линейная трансформация)"** в результате привязки образуется новый файл с расширением **.wld** исходное изображение остается без изменений. В нашем случае, вероятно, лучшим образом подойдет **проективный** тип трансформации. Основная цель — уменьшить невязки насколько это возможно. Если выбран тип трансформиции — проективная, необходимо указать **Output file**. В результате привязки будет создана искаженная копия растра, директорию для сохранения которой нужно выбрать. Так же полезно будет поставить чекбокс **"Использовать 0 для прозрачности при необходимости"**» что позволяет сделать кромку искаженного изображения прозрачной, вместо черного цвета. При активированном чекбоксе **"Сохранить контрольные точки"** программа сохранит контрольные точки в отдельный файл с расширением **.points** который можно будет подгрузить в окне привязки растров. При повторной привязке растра контрольные точки не придется расставлять повторно. Активированный чекбокс **Load in project when done** загружает привязанное изображение в главное окно программы после завершения привязки. Когда мы добились допустимой невязки, начинаем привязку растра, нажав на иконку **Начать привязку** ![1](./icons/2_начать привязку.png). После этого привязанный растр появится в основном окне программы. Окно с привязкой растра можно закрыть, сохранив контрольные точки.

::: {#task-task .callout-tip}
Привяжите одно изображение из папки "планы лесонасаждений" по квартальным столбам. В процессе выберите подходящий тип трансформации изображения (с минимальными невязками) и сохраните контрольные точки.
:::

## Видимость слоев

После того, как в проекте появилось первое изображение, стоит остановиться на описании инструментов навигации по карте и некоторых других возможностях программы.
Панель инструментов проекта	позволяет **создать проект ![1](./QGIS_icons/mActionFileNew.svg), открыть проект ![1](./QGIS_icons/mActionFileOpen.svg), сохранить проект ![1](./QGIS_icons/mActionFileSaveAs.svg), создать макет ![1](./QGIS_icons/mActionNewComposer.svg) и показать менеджер макетов** ![1](./QGIS_icons/mActionComposerManager.svg). Проектом называется файл, который связывает набор слоев с заданными настройками стиля и отображения. Этот файл имеет расширение **.qgs** или **.qgz**. После сохранения проекта все настройки отображения слоев будут содержаться в нем. Однако, файл проекта не содержит сами слои, которые находятся каждый в отдельном файле. Этот файл только объединяет нужные слои в единую систему с заданными параметрами отображения. Если пути к файлам, входящим в проект, или их названия будут изменены, программа не сможет обнаружить эти слои и сообщит об этом в окне с предупреждением @fig-layererror.

![Предупреждение о недостающих слоях](./pictures/16_Недостающие слои.png){#fig-layererror}

::: {.callout-note}
## Обратите внимание!
В дальнейшем создавайте для каждого нового проекта отдельную директорию (директория проекта) и сохраняйте в нее все файлы, относящиеся к этому проекту. Такой подход позволит не запутаться в большом количестве файлов а так же легко перенести весь проект на другой компьютер, если это потребуется. Помните, файл проекта содержит только пути к файлам!
:::

Порядок слоев в панеле слоев влияет на порядок отображения этих слоев в главном окне программы (@fig-panel). Слои расположенные выше будут закрывать собой последующие слои. Обычно растровое изображение используют как "подложку" и располагают последним. Использование прозрачности при оформлении векторных слоев позволяет им не перекрывать друг друга и отображать больше информации на экране. На текущем этапе панель слоев содержит векторный слой с квартальной сетью Караульного участкового лесничества и привязанный растр (@fig-panel).

![Панель слоев](./pictures/5_панель слоев.png){#fig-panel}

Для визуальной оценки точности привязки, переместим растровый слой на второе место, заливку векторного слоя квартальной сети сделаем прозрачной а границы слоя более толстыми и яркими. Для этого перетащим растровый слой в панеле слоев на второе место, перейдем в свойства векторного слоя: **"Свойства..." > "Стиль"**; выберем пункт "Простая заливка"; изменим "Цвет заливки" на "Прозрачная заливка", "Цвет обводки" на более яркий цвет и увеличим толщину обводки до 0,66 (@fig-vizcheck).

![Изменение порядка слоев](./gif/7_viz_check.gif){#fig-vizcheck}

После настройки стиля одновременно видны границы векторного слоя и расположенный за ним растровый слой.

::: {#task-task .callout-tip}
Проведите визуальную оценку точности привязки растрового изображения по примеру выше. Совпадают ли границы кварталов векторного и растрового слоя?
:::

## Модуль QuickMapServices

Программа QGIS позволяет расширить набор функций за счет устанавливаемых модулей. Одним из таких модулей является "**QuickMapServices**" который дает возможность подгрузить источники картографической информации (Google maps, Яндекс карты, OpenStreetMap и др.) напрямую в проект в виде отдельного слоя (подложки). Для установки этого модуля перейдите в панель **"Модули" > "Управление модулями..."**. В открывшемся окне, во вкладке **"Все"** в строке поиска введите название модуля **"QuickMapServices"**, выберите модуль и установите его ("Установить модуль"). После установки новый пункт появится в панеле **"Интернет" > "QuickMapServices"** ![1](./QGIS_icons/mActionAddWmsLayer.svg). При выборе одной из карт, она появится в панеле слоев в виде растрового слоя, а в окно программы будет загружено изображение соответствующей карты (@fig-qms).

![Изменение порядка слоев](./gif/16_QMS.gif){#fig-qms}

::: {.callout-note}
## Обратите внимание!
Некоторые карты могуть работать не корректно.
:::

Обновить перечень доступных карт можно перейдя в настройки модуля (**"Интернет" > "QuickMapServices" > "Настройки"**) и во вкладке "Загрузить сервисы" выберите пункт "Получить дополнительные источники данных". "QuickMapServices" лишь один из доступных модулей, расширяющих функции QGIS. Аналогичным способом возможно установить и другие модули.

::: {#task-task .callout-tip}
Добавьте карту "Google Satellite" из модуля QuickMapServices в панель слоев.
:::
