# Пространственная привязка растра

При создании геоинформационной системы "с нуля" часто пользуются уже существующими картографическими изображениями местности (планы, карты), переведенными в цифровой вид путем сканирования или фотографирования. Такие изображения не имеют пространственной привязки к местности т.е. невозможно сказать какому участку на поверхности планеты соответствует тот или иной пиксель изображения и, как следствие, невозможно применение простейших инструментов анализа, например, расчет длин и площадей изображенных объектов. Для полноценного использования такого изображения в геоинформационной системе требуется выполнить операцию **пространственной привязки растра (georeferencing)** т.е. задать соответствие между каждым пикселем изображения и соответствующим ему участком на поверхности земли. Такое соответствие задается при помощи **контрольных точек** и **трансформации** растра. Существует **два** основных случая привязки картографического изображения:

- карта **имеет** коордианатную сетку - контрольные точки расставляются в узлах координатной сетки;
- карта **не имеет** координатной сетки - контрольные точки расставляются по характерным точкам с известными координатами.

Привязка растров по координатной сетке рассмотрена в подразделе Х, привязка по характерным точкам в подразделе Y.

::: {.callout-note}
## Загрузите файлы!
Для выполнения заданий из этого раздела загрузите файлы по [ссылке](https://github.com/agoroshko/qgis_for_beginners/tree/main/files/ch1_%D0%9F%D1%80%D0%B8%D0%B2%D1%8F%D0%B7%D0%BA%D0%B0%20%D1%80%D0%B0%D1%81%D1%82%D1%80%D0%B0)
:::

## Организация файлов и создание проекта

Перед началом работы следует определиться с правилами организации файлов на компьютере. Для кадого нового проекта создается новая папка - **папка проекта**, которая содержит все файлы, относящиеся к этому проекту в том числе и **файл проекта** - файл с разрешением **.qgz** который позволяет сохранить проект со всеми текущими настройками оформления. Таким образом, сохранив текущий проект в **файл проекта** и открыв его позже, вы сможете продолжить работу с того места, на котором остановились.

::: {.callout-note}
## Обратите внимание!
Файл проекта содержит данные оформления (цвет, стиль линий и т.д.), но **не содержит данные слоев, только пути к файлам**. Если исходные файлы будут переименованы или перемещены, программа не сможет их найти и при открытии проекта появится окно с предупреждением (@fig-missing_layers).

![Окно "Недостающие слои"](./pictures2/1_1_Недостающие слои.png){#fig-missing_layers}
:::

Создайте **папку проекта** под названием **"Проект 1 Пространственная привязка"** и скопируйте в нее файлы, полученные по ссылке выше (если файлы находятся в архиве - распакуйте его). Сохраняйте в эту папку все файлы относящиеся к этому проекту. Такая организация файлов позволит отделить файлы одного проекта от другого а так же легко пенесести весь проект на другой компьютер без риска потери файлов (для этого достаточно скопировать папку проекта целиком).

::: {#task-task .callout-tip}
Создайте папку проекта под названием **"Проект 1 Пространственная привязка"** и скопируйте в нее файлы, полученные по ссылке выше.
:::

Так же следует сохранить файл проекта в созданную папку проекта. Для этого запустите программу QGIS и нажмите на иконку **"Сохранить проект"** ![сохранить проект](./QGIS_icons/mActionFileSave.svg) в левом верхнем углу. Выберите для сохранения папку проекта и задайте имя файла: **"Проект 1 Пространственная привязка"**. Как следствие, в папке проекта появится новый файл "Проект 1 Пространственная привязка**.qgz"** при открытии которого запустится программа QGIS с сохраненным состоянием проекта. Регулярно сохраняйте изменения в проекте при работе с программой!

!!Добвить gif!!

::: {#task-task .callout-tip}
По примеру выше, запустите программу QGIS и сохраните файл проекта в папку проекта.
:::


## Добавление векторного слоя

Основное окно программы QGIS условно можно разделить на 3 области: сверху расположены пункты меню и панели инструментов **(1)**, слева - панель слоев **(2)**, основное простанство занято областью карты **(3)**. В правом нижнем углу отображается система координат проекта, текущий масштаб и координаты курсора **(4)**. Нумерация элементов окна отображена на рисунке ниже (@fig-panels).

![Элементы основного окна программы](./pictures2/1_2_Панели окна программы.png){#fig-panels}

Для загрузки векторного слоя в программу, перейдите в пункт меню **"Слой" > "Добавить слой" > "Добавить векторный слой..."** (или используйте сочетание клавиш Ctrl + Shift + V) (@fig-addfile).

![Добавление векторного слоя](./gif/1_add_file.gif){#fig-addfile}

Появится диалоговое окно в котором нажмите на **...** в пункте **"Векторный набор данных"**. Укажите расположение файла **"Квартальная сеть.shp"** в папке проекта, после чего нажмите **"Открыть"**. В результате будет загружен векторный слой границ кварталов Караульного участкового лесничества.

::: {.callout-note}
## Обратите внимание!
Папка содержит несколько файлов с одинаковым названием но разными расширениями: "Квартальная сеть**.dbf**", "Квартальная сеть**.prj**", "Квартальная сеть**.shx**" и др. Такой тип файлов называется шейп-файлом (Shapefile). Хотя физически на диске это несколько файлов, при загрузке в ГИС они будут представлены как один векторный слой. Выбирать для загрузки необходимо только один файл с расширением **".shp"!** Подробнее с особенностями шейп-файлов возможно ознакомиться по [ссылке](https://ru.wikipedia.org/wiki/Shapefile).
:::


!! Видео - добавление векторного слоя !!



Для удобства навигации добавьте номера кварталов на карту (функция добавления подписей объектов будет рассмотрена более подробно в последующих разделах: @sec-simple_labels). Для добавления подписей нажмите правой кнопкой мыши на слой **"Квартальная сеть"** в панеле слоев. Выберите пункт **"Свойства..." > "Надписи"**. В верхней части окна поменяйте выпадающую вкладку с **"Без подписей"** на **"Обычные подписи"**. В пункте **"Значение"** выберите поле **"kvartal"** (в этом поле содержатся номера кварталов). После этого нужно сохранить изменения (**Применить > ОК**) (@fig-addlabels).

!!!Заменить на видео!!!
![Добавление подписей к векторному слою](./gif/2_add_labels.gif){#fig-addlabels}

Для более реалистичного отображения объектов так же поменяйте систему координат проекта. Для этого нажмите на иконку ![СК](./QGIS_icons/mIconProjectionEnabled.svg) в правом нижнем углу. В появившемся окне, в строке **"Поиск"**, введите число **32646**, выберите систему координат **"WGS 84 / UTM zone 46N"** и нажмите **ОК**. Изображение в основном окне программы изменится, согласно заданной системе координат.


!! Добавить видео изменения СК проекта !!


::: {#task-task .callout-tip}
По примеру выше, загрузите в проект векторный слой "Квартальная сеть", добавьте номера лесных кварталов и задайте новую систему координат проекта.
:::



## Навигация по карте

В текущем проекте загружен единственный векторный слой "Квартальная сеть" который отображает границы кварталов на территории Караульного участкового лесничества. Основным средством навигации является инструмент **"Прокрутка карты"** ![Прокрутка карты](./QGIS_icons/mActionPan.svg), который позволяет передвигать карту (так же этот инстумент активируется нажатием колесика мыши).


!! Анимация

**Колесико мыши** позволяет менять масштаб. Для более плавного изменения масштаба используйте колесико мыши с зажатой клавишей **Ctrl**. Текущее значение масштаба возможно увидеть и задать в окне **"Масштаб"** в правом нижнем углу.


!! Анимация

 Слева находится панель слоев, в которой отображаются все задействованные в проекте слои. Контекстное меню панели слоев (@fig-contextmenulayers) вызывается левым щелчком мыши и позволяет провети настройку отдельного слоя. Это меню часто используется, рассмотрим его основные элементы:

![Добавление подписей к векторному слою](./pictures/17_Контекстное меню панели слоев.png){#fig-contextmenulayers}


 Слева находится панель слоев, в которой отображаются все задействованные в проекте слои, для каждого из которых указаны: название слоя, цвет отображения объектов (а так же тип геометрии объектов) и **чек-бокс отключающий видимость слоя**. Важнейшим инструментом является **контекстное меню слоя**, позволяющее задать индивидуальные настройки для каждого слоя. Оно вызывается правым кликом мыши на выбранном слое и содержит следующие инструменты:

- **"Увеличить до слоя"** ![Увеличить до слоя](./QGIS_icons/mActionZoomToLayer.svg) - инструмент позволяет переместить слой в центр окна программы. Чаще всего применяется для быстрой навигации или если вы "потерялись" на карте и видите только белый экран.
- **"Показывать количество объектов"** - когда активирован, добавляет счетчик количества объектов напротив слоя в панеле слоев.
- **"Показать подписи"** ![Показать подписи](./QGIS_icons/mActionLabeling.svg) - позволяет быстро включить или отключить подписи объектов слоя.
- **"Переименовать слой"** - позволяет изменить название слоя в панеле слоев.
- **"Дублировать слой"** ![Дублировать слой](./QGIS_icons/mActionDuplicateLayer.svg) - создает дубликат слоя. При этом изменения в слое-оригинале будут отображаться в слое-копии и наоборот т.к. файл-источник для слоев остается общим. Однако для копии и оригинала возможно настроить различные стили отображения.
- **"Удалить слой"** ![Удалить слой](./QGIS_icons/mActionRemoveLayer.svg) - удаляет слой из панели слоев, при этом **файл-источник удален не будет**.
- **"Переместить в конец"**, "Переместить в начало" - перемещает слой в конец или начало списка в панеле слоев. Порядок в списке влияет на порядок отображения слоев в главном окне программы (пункт появляется только если в проекте больше одного слоя).
- **"Открыть таблицу атрибутов"** ![Открыть таблицу атрибутов](./QGIS_icons/mActionOpenTable.svg) - открывает таблицу атрибутов слоя.
- **"Режим редактирования"** ![Режим редактирования](./QGIS_icons/mActionToggleEditing.svg) - переводит слой в режим редактирования.
- **"Фильтр"** настраивает фильтрацию объектов по значениям таблицы атрибутов.
- **"Видимость в приделах масштаба..."** - позволяет настроить отображение слоя при определенном диапазоне масштаба.
- **"Экспорт"** позволяет сохранить слой в файл. Возможны разные форматы сохранения: .shp, .gpkg, .gpx, .xlsx и др.
- **"Стили"** дает доступ к быстрому изменению стиля отображения объектов а так же к возможности копировать настройки стиля одного слоя и применить их к другому слою.
- **"Свойства..."** наиболее часто используемый пункт. Позволяет настроить слой, включая стиль отображения, надписи, систему координат и др.

Некоторые примеры использования инструментов **контекстного меню слоя** представлены ниже ().

!! Видео демонстрации инструментов (изменение цвета)

::: {#task-task .callout-tip}
Измените положение карты и масштаб. Изучите контекстное меню панели слоев на примере загруженного ранее слоя "Квартальная сеть Караульное".
:::


## Привязка по координатной сетке

::: {#cau-georef .callout-caution icon=false title="Дополнительные ресурсы:"}
- [Картетика - Все что нужно знать о привязке растров;](https://cartetika.ru/tpost/ae1ph1lcj1-vse-chto-nuzhno-znat-o-privyazke-rastrov?utm_source=telegram&utm_medium=post&utm_campaign=text)
- [NextGIS - Привязка растров.](https://docs.nextgis.ru/docs_ngqgis/source/raster_ref.html)
:::

Координатную сетку плана или карты часто используют для географической привязки изображения. QGIS позволяет осуществить привязку как в географической, так и в спроецированной системе координат. Привязка изображения осуществляется путем расстановки контрольных точек и указания их координат, таким образом создается соответстие между координатами отдельных пикселей изображения и географическими координатами. При помощи трансформации это соответствие экстраполируется на все изобржаение. В результате каждый пиксель изображения будет иметь привязку к географическим координатам.

Для примера осуществим географическую привязку изображения "Национальный парк Столбы.png". Карта имеет координатную сетку в географической системе координат **WGS84 (EPSG:4326)**. Для привязки растра используется инструмент, находящийся в меню **"Слой" > "Привязка растров..."** ![Привязка растров](./QGIS_icons/georeferencer/mGeorefRun.svg). В открывшемся окне выберите иконку **"Открыть растр..."** ![1](./QGIS_icons/mActionAddRasterLayer.svg) после чего в папке проекта укажите файл **"Национальный парк Столбы.png"** (@fig-georefwindow).

![Окно привязки растров](./pictures2/1_4_Окно привязки растра.png){#fig-georefwindow}

::: {#task-task .callout-tip}
По примеру выше откройте окно привязки растра и загрузите растровое изображения "Национальный парк Столбы.png" из папки проекта. Результат должен соответствовать рисунку выше (@fig-georefwindow).
:::

Окно инструмента "Привязка растров" разделено на 2 части: в верхней отображается растровое изображение, в нижней - характеристики контрольных точек. Для добавления контрольных точек используется инструмент **"Добавить точку"** ![1](./QGIS_icons/georeferencer/mActionAddGCPPoint.svg), для удаления - **"Удалить точку"** ![1](./QGIS_icons/georeferencer/mActionDeleteGCPPoint.svg), для перемещения - **"Переместить точку"** ![1](./QGIS_icons/georeferencer/mActionMoveGCPPoint.svg). Перемещение по карте осуществляется при помощи инструмента **"Перемещение"** ![1](./QGIS_icons/mActionPan.svg) или путем удержания **клавиши пробел** (последний способ часто удобнее). Масштаб изменяется прокруткой колесика мыши, так же как в основном окне программы.  
Для добавления контрольных точек активируйте инструмент **"Добавить точку"** ![1](./QGIS_icons/georeferencer/mActionAddGCPPoint.svg) и нажмите на пересечение линий координатной сетки. В открывшемся окне введите координаты добавленной точки, укажите систему координат **WGS84 (EPSG:4326)** после чего нажмите **ОК**. 

::: {.callout-note}
## Обратите внимание!
Формат ввода координат указан в верхней части окна (@fig-addcoords). Для географических систем координат предусмострен формат ввода ГМС - градусы минуты секунды (числа разделяются пробелом, доли секунд - точкой) или ДГ - десятичные градусы (целая часть отделяется от дробной точкой). Координаты в формате ГМС: **92 12 13.25** (92 градуса 12 минут 13,25 секунд). Координаты в формате ДГ: **92.521135** (92,521135 градуса). Координаты в спроецированной системе указываются в метрах, целая часть отделяется от дробной точкой, например, **268699.48**.

![Окно ввода координат](./pictures2/1_3_Ввод координат.png){#fig-addcoords}
:::

После добавления первой контрольной точки появится отметка на привязываемом изображении с номером точки (ID). В нижней части окна появится строка с характеристиками точки, которые состоят из номера точки (столбец ID) и соответствия между координатами привязываемого изображения (X / Y источника) и введенными географическими координатами (X / Y назначения) (@fig-georeffirst). Аналогичным образом добавляют последующие контрольные точки.

![Первая контрольная точка](./pictures2/1_5_Добавление первой точки привязки.png){#fig-georeffirst}

::: {.callout-note}
## Обратите внимание!
Количество конрольных точек зависит от качества изображения и выбранного типа трансформации (см. @cau-georef). Минимальное количество точек - 2, однако, для получения невязки, следует добавить **по меньшей мере 3 точки**. Чем хуже качество привязываемого изображения, тем больше контрльных точек понадобится для точной привязки. Точки следует добавлять равномерно по всей площади изображения.
:::

::: {#task-task .callout-tip}
По примеру выше добавьте **5** контрольных точек (4 по углам изображения и 1 в центре).
:::

После добавления контрольных точек, напротив каждой из них появится значение невязки а так же значение средней ошибки в правом нижнем углу окна (@fig-cont_points). Перейдите в **"Параметры трансформации"** ![1](./QGIS_icons/propertyicons/settings.svg) и убедитесь что в пункте **"Target CRS"** (целевая система координат) указана система координат добавленных контрольных точек (**WGS84 - EPSG:4326**), иначе невязка будет рассчитана не корректно (по умолчанию в этом пункте указана СК проекта) (@fig-transform_params).  

::: {#fig-georef_points layout-ncol=2}

![Контрольные точки](./pictures2/1_6_Контрольные точки.png){#fig-cont_points}

![параметры трансформации](./pictures2/1_7_Параметры трансформации.png){#fig-transform_params}

Невязка и параметры трансформации изображения

:::

**Невязка** (ошибка) - показатель несоответствия между координатами контрольных точек и локальными координатами изображения, а так же мера точности привязки изображения. Для уменьшения невязки сначала подбирается подходящий **тип трансформации** (показывающий наименьшую **среднюю ошибку**) после чего отдельные точки с максимальной невязкой удаляют (отключают) или корректируют их местоположения. Для подбора оптимального типа трансформации, в окне **"Параметры трансформации"** ![1](./QGIS_icons/propertyicons/settings.svg) поочередно выбирают разный **"Тип трансформации"** (@fig-transform_params). Для каждого нового типа трансформации невязки точек и средняя ошибка будут пересчитаны. В конечном итоге, выбирается тип трансформации с наименьшей средней ошибкой.  

Для изображений хорошего качества чаще всего применяют тип трансформации **"линейная"** или **"Гельмерта"**. **"Проективный"** тип хорошо подходит для сфотографированных под углом карт. Остальные типы трансформации используют для изображений плохого качества (см. @cau-georef).

::: {#task-task .callout-tip}
Выберите оптимальный тип трансформации (с минимальной средней ошибкой).  
Примечание: некоторые типы трансформации требуют больше 5 контрольных точек, их использование будет невозможно (невязка точек не может быть рассчитана и отобразит значение "н/д").
:::

После выбора подходящего типа трансформации анализируют невязки отдельных точек. Числовое значение невязки отображается в столбце **"Невязка"** (единицы измерения пиксели или единицах карты). Графически невязка отображается в виде красных линий, соединяющих контрольную точку и местоположение, где эта контрольная точка должна находиться. Точки с невязкой значительно большей чем средняя удаляют, для этого достаточно снять чек-бокс в первом столбце таблицы **"Контрольные точки"**, после чего невязка для остальных точек (и средняя ошибка) будут пересчитаны. В случае с координатной сеткой возможно уменьшить невязку путем более точного позиционирования контрольных точек, разместив их точнее на перекрестиях координатной сетки.

!! Видео

::: {#task-task .callout-tip}
Выберите инструмент **"Переместить точку"** ![1](./QGIS_icons/georeferencer/mActionMoveGCPPoint.svg) и скорректируйте положение отдельных контрольных точек так, что бы невязка каждой не превышала 1 пиксель. Для этого переместите контрольные точки по пути красной линии невязки.
:::

Получив приемлемые значения невязки, проводят настройки в окне **"Параметры трансформации"** (@fig-transform_params). В пункте **"Output file"** указывают путь и название выходного файла. Привязку растра активируют, нажав на иконку **"Начать привязку растра"** ![1](./QGIS_icons/mActionStart.svg). В результате в папке проекта появится модифицированный растровый файл, который так же будет добавлен в панель слоев. После успрешного завершения операции окно **"Привязка растров"** можно закрыть.


!! Передискретизация косячит !!!
!! Разобраться с изображением !!!



::: {#task-task .callout-tip}
Завершите привязку растрового изображения. В панеле слоев должен появиться новый растровый слой "Национальный парк Столбы_modified".
:::

::: {.callout-note}
## Обратите внимание!
- При трансформации "Линейная" и "Гельмерта" возможно вместо нового растрового изображения создать файл с расширением **.wld**, который будет содержать параметры привязки изображения. Для этого достаточно активировать чек-бокс в пункте **"Только создать world-файл..."**.  
- Во время привязки контрольные точки сохраняются в файл с расширением **.points** (чек-бокс "Сохранить контрольные точки). Их так же возможно сохранить или загрузить нажатием на иконки **"Сохранить контрольные точки как..."** ![1](./QGIS_icons/georeferencer/mActionSaveGCPpointsAs.svg) и **"Загрузить контрольные точки..."** ![1](./QGIS_icons/georeferencer/mActionLoadGCPpoints.svg) соответственно.  
- Кроме привязки растровых изображений, доступна привязка векторных слоев, для загрузки которых используется иконка "Открыть вектор" ![1](./QGIS_icons/mActionAddOgrLayer.svg).
:::


### Инструменты измерения










!!! Строка 65 в прошлом файле !!!

## Привязка по характерным точкам 







Основой для создания плана лесонасаждений является сканированная копия плана лесонасаждений части Мининского лесничества, Караульного участкового лесничества Красноярского края. 
Для начала запустим программу QGIS. Для этого необходимо выбрать ярлык QGIS Desktop из папки QGIS на рабочем столе или в меню пуск. После открытия программы создается новый проект, для этого нужно перейти в пункт меню **Проекты > Создать** (@fig-makeproj).

![Создание проекта](./pictures/1_create_proj.png)

Теперь можно приступить к привязке растра. Привязка растра означает определение для каждой точки растрового изображение координат в той или иной  системе координат. Топографические карты удобно привязывать по координатной сетке в прямоугольной зональной или географической системе координат (@fig-topomap).

![Топографическая карта с координатной сеткой](./pictures/2_map.png){#fig-topomap}

Планы лесонасаждений обычено не имеют координатной сетки, поэтому привязку осуществляют по квартальным столбам или хорошо опознаваемым точкам (реки, дороги и т.д.).

## Загрузка векторного слоя

Планы лесонасаждений не имеют координатной сетки. При таких условиях привязку возможно осуществить по космическим снимкам, например с помощью плагина "QuickMapServices", или по твердо опознаваемым точкам с уже известными координатами (например квартальных столбов). В нашем случае, растровое изображение будет привязываться к существующему векторному слою квартальной сети Караульного участкового лесничества. Для этого перейдите в меню **"Слой" > "Добавить слой" > "Добавить векторный слой..."** (@fig-addfile).

![Рисунок 3 - Добавление векторного слоя](./gif/1_add_file.gif)

Появится диалоговое окно в котором нажмите на **...** в пункте **"Векторный набор данных"**. Укажите расположение файла **"Квартальная сеть Караульное.shp"** после чего выберите **"Открыть"**.

::: {.callout-note}
## Обратите внимание!
Папка содержит несколько файлов с одинаковым названием но разными расширениями: "Квартальная сеть Караульное**.dbf**", "Квартальная сеть Караульное**.prj**", "Квартальная сеть Караульное**.shx**" и др. Такой тип файлов называется шейп-файлом (Shapefile). Хотя физически на диске это несколько файлов, при загрузке в ГИС они будут представлены как один векторный слой. Выбирать для загрузки необходимо только один файл с расширением **".shp"!** Подробнее о шейп-файлах можно прочитать по ссылке <https://ru.wikipedia.org/wiki/Shapefile>.
:::

В результате будет загружен векторный слой границ кварталов Караульного участкового лесничества. Для удобства добавим номера кварталов на карту. Функция добавления подписей будет рассмотрена более подробно в последующих разделах. Сейчас нажимаем правой кнопкой мыши на слой **"квартальная сеть Караульное"** в панеле слоев. Выберите пункт **Свойства... > Надписи**. В верхней части окна меняем выпадающую вкладку с **"Без подписей"** на **"Обычные подписи"**. В пункте **"Значение"** выбираем поле **"kvartal"** (в этом поле содержатся номера кварталов). После этого нужно сохранить изменения (**Применить**) и нажать **ОК** (@fig-addlabels).

![Добавление подписей к векторному слою](./gif/2_add_labels.gif){#fig-addlabels}

::: {#task-task .callout-tip}
Загрузите векторный слой "квартальная сеть Караульное.shp" и добавьте номера лесных кварталов по примеру выше.
:::

## Навигация по карте

Для перемещения по карте используется инструмент **Прокрутка карты** ![прокрутка карты](./QGIS_icons/mActionPan.svg) (так же этот инстумент активируется нажатием колесика мыши). **Масштаб карты** изменяется прокруткой колесика мышки. Более плавное изменение масштаба возможно при нажатой кавише **Ctrl и прокрутке колескика мышки**. Слева находится панель слоев, в которой отображаются все задействованные в проекте слои. Контекстное меню панели слоев (@fig-contextmenulayers) вызывается левым щелчком мыши и позволяет провети настройку отдельного слоя. Это меню часто используется, рассмотрим его основные элементы:

![Добавление подписей к векторному слою](./pictures/17_Контекстное меню панели слоев.png){#fig-contextmenulayers}

- "Увеличить до слоя" ![Увеличить до слоя](./QGIS_icons/mActionZoomToLayer.svg) - инструмент позволяет переместить слой в центр окна программы. Чаще всего применяется для быстрой навигации или если вы "потерялись" на карте и видите только белый экран.
- "Показывать количество объектов" - когда активирован, добавляет счетчик количества объектов напротив слоя в панеле слоев.
- "Показать подписи" ![Показать подписи](./QGIS_icons/mActionLabeling.svg) - позволяет быстро включить или отключить подписи объектов слоя. Стиль подписей настраивается в свойствах слоя.
- "Переименовать слой" позволяет изменить название слоя в панеле слоев.
- "Дублировать слой" ![Дублировать слой](./QGIS_icons/mActionDuplicateLayer.svg) создает дубликат слоя. При этом изменения в слое-оригинале будут отображаться в слое-копии и наоборот т.к. файл-источник для слоев остается общим. Однако для копии и оригинала возможно настроить отличающиеся стили отображения.
- "Удалить слой" ![Удалить слой](./QGIS_icons/mActionRemoveLayer.svg) удаляет слой из панели слоев, при этом файл-источник не удаляется.
- "Переместить в конец", "Переместить в начало" перемещает слой в конец или начало списка в панеле слоев. Порядок в списке влияет на порядок отображения слоев.
- "Открыть таблицу атрибутов" ![Открыть таблицу атрибутов](./QGIS_icons/mActionOpenTable.svg) - открывает таблицу атрибутов слоя.
- "Режим редактирования" ![Режим редактирования](./QGIS_icons/mActionToggleEditing.svg) переводит слой в режим редактирования.
- "Фильтр" настраивает фильтрацию объектов по значениям таблицы атрибутов.
- "Видимость в приделах масштаба..." слой отображается только при заданном диапазоне масштабов.
- "Экспорт" позволяет сохранить слой в файл. Возможны разные форматы сохранения: .shp, .gpkg, .gpx, .xlsx и др.
- "Стили" дает доступ к быстрому изменению стиля отображения объектов а так же к возможности копировать настройки стиля одного слоя и применить их к другому слою.
- "Свойства..." наиболее часто используемый пункт. Позволяет настроить слой, включая стиль отображения, надписи, систему координат и др.

::: {#task-task .callout-tip}
Измените положение карты и масштаб. Изучите контекстное меню панели слоев на примере загруженного ранее слоя "Квартальная сеть Караульное".
:::

## Добавление контрольных точек

::: {.callout-caution icon=false title="Дополнительные ресурсы:"}
- [Картетика - Все что нужно знать о привязке растров;](https://cartetika.ru/tpost/ae1ph1lcj1-vse-chto-nuzhno-znat-o-privyazke-rastrov?utm_source=telegram&utm_medium=post&utm_campaign=text)
- [NextGIS - Привязка растров.](https://docs.nextgis.ru/docs_ngqgis/source/raster_ref.html)
:::

Теперь все приготовления завершены и можно приступать к самой привязки растра. Для начала необходимо выбрать изображение, которое будет привязываться. В папке **планы лесонасаждений** находится несколько сканированных изображений. Выберите одно из них, и сразу определите 1 квартал, привязку которого будете осуществлять. Выбранный квартал не должен быть обрезан по границе изображения. Для примера привязка осуществлялась для изображения "3.jpg" квартал 46. После этого в QGIS перейдите во вкладку **Слой > Привязка растров...** (@fig-addlabels).

![Окно привязки растров](./gif/3_georef.gif){#fig-georef}

Откроется окно **"Привязка растров"** которое состоит из двух областей разделенных горизонтальной чертой. В верхней области будет отображаться растровое изображение и контрольные точки, в нижней, которая называется **"Контрольные точки"**, появится таблица с характеристиками контрольных точек. Для загрузки растра выберите иконку **"Открыть растр..."** ![1](./QGIS_icons/mActionAddRasterLayer.svg) после чего укажите растр для привязки. Растр привязывается путем расстановки контрольных точек с известными координатами. Для работы с контрольными точками применяют инструменты **"Добавить точку"** ![1](./QGIS_icons/georeferencer/mActionAddGCPPoint.svg), **"Удалить точку"** ![1](./QGIS_icons/georeferencer/mActionDeleteGCPPoint.svg), **"Переместить точку"** ![1](./QGIS_icons/georeferencer/mActionMoveGCPPoint.svg), которые выполняют соответствующие действия. Для добавления контрольных точек активируйте инструмент **"Добавить точку"**. Контрольные точки расставляются в местах квартальных столбов. Больше подробностей о привязке растровых изображений можно найти на форуме [gis-lab.info](https://gis-lab.info/qa/georef-qgis.html#.D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_QGIS_.D0.B8_.D0.BC.D0.BE.D0.B4.D1.83.D0.BB.D1.8F_.D0.BF.D1.80.D0.B8.D0.B2.D1.8F.D0.B7.D0.BA.D0.B8).  
Поставив точку на карте, появится диалоговое окно, которое позволяет задать координаты точки вручную или использовать координаты этой точки с уже привязанной карты. Выберите пункт **"С карты"** ![1](./icons/1_с карты.png), после чего откроется основное окно программы, где необходимо выбрать ту же точку на векторном слое, который мы загрузили ранее. Таким образом устанавливается соответствие между уже имеющим привязку векторным слоем лесных кварталов и растровым изображением без привязки. Контрольные точки расставляются по всем видимым на растровом изображении квартальным столбам. Чем таких точек больше, тем точнее получится привзяка (@fig-points).

![Добавление контрольных точек](./gif/4_georef_points.gif){#fig-points}

После расставления всех контрольных точек необходимо задать параметры трансформации (иконка **Параметры трансформации** ![1](./icons/1_параметры трансформации.png)). В открывшемся окне выбрать **"Тип трансформации" > "Линейный"**» и нажать **ОК** (@fig-privazka). Теперь в нижней части окна привязки растров появилось числовое значение невязки для каждой точки, в верхней части эта невязка отображается в виде красных линий, соединенных с контрольными точками. Чем меньше значения невязки, тем точнее привязана карта. Невязки измеряются в пикселях изображения, значения меньше 5 единиц вполне допустимы для нашей работы. В случае больших значений, контрольные точки с максимальной невязкой можно удалить или переместить так, что бы уменьшить невязку. Так же невязка зависит от типа трансформации изображения, при изменении которого невязки будут пересчитаны и могут измениться как в большую, так и в меньшую сторону.

![Настройка параметров трансформации](./pictures/3_Параметры трансформации.png){#fig-privazka}

В программе доступно несколько типов трансформации изображения. Типы линейный и Гельмерта не искажают изображения. При выборке чекбокса **"Только создать world-файл (линейная трансформация)"** в результате привязки образуется новый файл с расширением **.wld** исходное изображение остается без изменений. В нашем случае, вероятно, лучшим образом подойдет **проективный** тип трансформации. Основная цель — уменьшить невязки насколько это возможно. Если выбран тип трансформиции — проективная, необходимо указать **Output file**. В результате привязки будет создана искаженная копия растра, директорию для сохранения которой нужно выбрать. Так же полезно будет поставить чекбокс **"Использовать 0 для прозрачности при необходимости"**» что позволяет сделать кромку искаженного изображения прозрачной, вместо черного цвета. При активированном чекбоксе **"Сохранить контрольные точки"** программа сохранит контрольные точки в отдельный файл с расширением **.points** который можно будет подгрузить в окне привязки растров. При повторной привязке растра контрольные точки не придется расставлять повторно. Активированный чекбокс **Load in project when done** загружает привязанное изображение в главное окно программы после завершения привязки. Когда мы добились допустимой невязки, начинаем привязку растра, нажав на иконку **Начать привязку** ![1](./icons/2_начать привязку.png). После этого привязанный растр появится в основном окне программы. Окно с привязкой растра можно закрыть, сохранив контрольные точки.

::: {#task-task .callout-tip}
Привяжите одно изображение из папки "планы лесонасаждений" по квартальным столбам. В процессе выберите подходящий тип трансформации изображения (с минимальными невязками) и сохраните контрольные точки.
:::

## Видимость слоев

После того, как в проекте появилось первое изображение, стоит остановиться на описании инструментов навигации по карте и некоторых других возможностях программы.
Панель инструментов проекта	позволяет **создать проект ![1](./QGIS_icons/mActionFileNew.svg), открыть проект ![1](./QGIS_icons/mActionFileOpen.svg), сохранить проект ![1](./QGIS_icons/mActionFileSaveAs.svg), создать макет ![1](./QGIS_icons/mActionNewComposer.svg) и показать менеджер макетов** ![1](./QGIS_icons/mActionComposerManager.svg). Проектом называется файл, который связывает набор слоев с заданными настройками стиля и отображения. Этот файл имеет расширение **.qgs** или **.qgz**. После сохранения проекта все настройки отображения слоев будут содержаться в нем. Однако, файл проекта не содержит сами слои, которые находятся каждый в отдельном файле. Этот файл только объединяет нужные слои в единую систему с заданными параметрами отображения. Если пути к файлам, входящим в проект, или их названия будут изменены, программа не сможет обнаружить эти слои и сообщит об этом в окне с предупреждением @fig-layererror.

![Предупреждение о недостающих слоях](./pictures/16_Недостающие слои.png){#fig-layererror}

::: {.callout-note}
## Обратите внимание!
В дальнейшем создавайте для каждого нового проекта отдельную директорию (директория проекта) и сохраняйте в нее все файлы, относящиеся к этому проекту. Такой подход позволит не запутаться в большом количестве файлов а так же легко перенести весь проект на другой компьютер, если это потребуется. Помните, файл проекта содержит только пути к файлам!
:::

Порядок слоев в панеле слоев влияет на порядок отображения этих слоев в главном окне программы (@fig-panel). Слои расположенные выше будут закрывать собой последующие слои. Обычно растровое изображение используют как "подложку" и располагают последним. Использование прозрачности при оформлении векторных слоев позволяет им не перекрывать друг друга и отображать больше информации на экране. На текущем этапе панель слоев содержит векторный слой с квартальной сетью Караульного участкового лесничества и привязанный растр (@fig-panel).

![Панель слоев](./pictures/5_панель слоев.png){#fig-panel}

Для визуальной оценки точности привязки, переместим растровый слой на второе место, заливку векторного слоя квартальной сети сделаем прозрачной а границы слоя более толстыми и яркими. Для этого перетащим растровый слой в панеле слоев на второе место, перейдем в свойства векторного слоя: **"Свойства..." > "Стиль"**; выберем пункт "Простая заливка"; изменим "Цвет заливки" на "Прозрачная заливка", "Цвет обводки" на более яркий цвет и увеличим толщину обводки до 0,66 (@fig-vizcheck).

![Изменение порядка слоев](./gif/7_viz_check.gif){#fig-vizcheck}

После настройки стиля одновременно видны границы векторного слоя и расположенный за ним растровый слой.

::: {#task-task .callout-tip}
Проведите визуальную оценку точности привязки растрового изображения по примеру выше. Совпадают ли границы кварталов векторного и растрового слоя?
:::

## Модуль QuickMapServices

Программа QGIS позволяет расширить набор функций за счет устанавливаемых модулей. Одним из таких модулей является "**QuickMapServices**" который дает возможность подгрузить источники картографической информации (Google maps, Яндекс карты, OpenStreetMap и др.) напрямую в проект в виде отдельного слоя (подложки). Для установки этого модуля перейдите в панель **"Модули" > "Управление модулями..."**. В открывшемся окне, во вкладке **"Все"** в строке поиска введите название модуля **"QuickMapServices"**, выберите модуль и установите его ("Установить модуль"). После установки новый пункт появится в панеле **"Интернет" > "QuickMapServices"** ![1](./QGIS_icons/mActionAddWmsLayer.svg). При выборе одной из карт, она появится в панеле слоев в виде растрового слоя, а в окно программы будет загружено изображение соответствующей карты (@fig-qms).

![Изменение порядка слоев](./gif/16_QMS.gif){#fig-qms}

::: {.callout-note}
## Обратите внимание!
Некоторые карты могуть работать не корректно.
:::

Обновить перечень доступных карт можно перейдя в настройки модуля (**"Интернет" > "QuickMapServices" > "Настройки"**) и во вкладке "Загрузить сервисы" выберите пункт "Получить дополнительные источники данных". "QuickMapServices" лишь один из доступных модулей, расширяющих функции QGIS. Аналогичным способом возможно установить и другие модули.

::: {#task-task .callout-tip}
Добавьте карту "Google Satellite" из модуля QuickMapServices в панель слоев.
:::
