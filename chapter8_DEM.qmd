# Цифровая модель рельефа

Цифровая модель рельефа (ЦМР) или Digital elevation model (DEM) - растровое изображение в каждой ячейке которого записана средняя высота поверхности земли. В этом разделе используется цифровая модель ASTER GDEM с пространственным разрешением 30 метров на пиксель.

## Загрузка растровых данных.

Загрузка растровых данных производится через пункт **"Слой" > "Добавить слой" > "Добавить растровый слой"** или перетаскиванием файла растра в окно программы.

::: {.callout-note}
## Загрузите файлы!
Для выполнения последующих заданий загрузите файлы по [ссылке 1](https://disk.yandex.ru/d/xbXVOp86ipOVgA):

- Создайте новую папку проекта под названием "DEM" а так же новый проект в QGIS.
- Распакуйте архив и загрузите в программу QGIS слои "videl.gpkg", "uch_lesn.gpkg" и растровое изображение "DEM.tif".
- Сохраните проект в папку проекта.
:::

## Визуализация

Настройки отображения растра устанавливаются в контекстном меню слоя **"Свойства.." > "Стиль"**. В пункте **"Изображение"** настраивается режим отображения. Для количественных данных используются режимы **"Одноканальное серое"** и **"Одноканальное псевдоцветное"**. Классифицированные изображения визуализируют при помощи режима **"Палитра / Уникальные значения"**. Для многоканальных растров используют режим **"Многоканальное цветное"**. Режимы **"Теневой рельеф"** и **"Изолинии"** применяются для цифровых моделей рельефа.

![Настройка стиля отображения растра "DEM"](./videos/7_1_градиент.mp4){#vid-gradient}

::: {#task-task .callout-tip}
Для растрового слоя "DEM" измените стиль отображения.  По примеру выше примените режим "Одноканальное псевдоцветное", задайте градиент "Magma" (@vid-gradient).
:::

## Классификация одноканального изображения {#sec-dem_classification}

Инструмент **"Растр" > "Калькулятор растров..."** позволяет проводить арифметические операции с растровыми изображениями. Для составления выражений используются каналы растров и арифметические операторы. Калькулятор растров так же используется для классификации изображения т.е. разбиения его на классы.  
Для примера, воспользуемся инструментом **"Калькулятор растров"** и разобьем (классифицируем) растровый слой "DEM" на 2 класса. Первый класс будет иметь метку 0, в него войдут все пиксели с высотой до 250 метров. Второму классу будет присвоена метка 1, он будет содержать пиксели с высотой большей или равной 250 метров.  
Что бы провести классификацию записывают выражение `"DEM@1"  >= 250` в **"Калькуляторе растров"**. В результате каждый пиксель изображения проверяется на соответсвтие условию. Пикселям, соответсвтующим условию, присваивается значение 1, не соответствующим - 0. Созданный растр будет содержать пиксели только с двумя значениями: 0 и 1 (высота до 250 и более 250 метров соответственно, см. @vid-classification2).


![Классификация растрового изображения "DEM"](./videos/7_2_классификация на 2 класса.mp4){#vid-classification2}

::: {#task-task .callout-tip}
Ориентируясь на пример выше, проведите классификацию растра "DEM" на 2 класса: класс с меткой 0 должен содержать пиксели до 300 метров; класс с меткой 1 должен содержать пиксели с высотой больше или равной 300 метрам. Результат выполнения задания приведен на рисунке ниже (см. @fig-two_classes_task).

![Результат выполнения задания, черные пиксели имеют высоту < 300 м, белые >= 300 м](./pictures2/8_1_Задание бинарная классификация.png){#fig-two_classes_task}
:::

Аналогичным образом возможно разбить (классифицировать) растр на несколько классов. В следующем примере растр цифровой модели рельефа **"DEM"** будет разбит на 3 класса. Класс 1 - значения от 0 до 200 м, класс 2 - от 200 до 400 м, класс 3 - от 400 до 600 м. Как и в предыдущем задании (см. @fig-two_classes_task) классификация осуществляется при помощи инструмента **"Калькулятор растров"**.  
Упомянутую классификацию можно осуществить с помощью следующего выражения: `("DEM@1"  > 0  AND "DEM@1"  < 200)*1 + ("DEM@1"   >=  200  AND "DEM@1"  < 400)*2 +  ("DEM@1"   >=  400  AND "DEM@1" < 600)*3`. Для объяснения действия выражения, рассмотрим его по частям. Часть выражения `("DEM@1"  > 0  AND "DEM@1"  < 200)` объединяет в себе два предиката, объединенных оператором `AND` (**И**). Выражение будет принимать значение 1 для пикселей со значением высоты от 0 до 200 м (когда **И** одно **И** другое условие истинны). Во всех остальных случаях выражение будет принимать значение 0. Множитель рядом с выражением задает метку класса (**1** - в этой части выражения).  
Аналогично во 2 класс выбираются пиксели с высотой от 200 до 400 м (часть выражения (`"DEM@1"   >=  200  AND "DEM@1"  < 400)*2`) и в 3 класс попадают пиксели с высотой от 400 до 600 м (часть выражения `("DEM@1"   >=  400  AND "DEM@1" < 600)*3`). В результате каждому пикселю будет присвоена метка класса (1, 2 или 3).


::: {.callout-note}
## Обратите внимание!
Чаще всего классы кодируются целыми значениями. Хотя со значениями классов возможно производить арифметические операции, необходимо помнить, что это качественный показатель, объединяющий пиксели с общими свойствами. Для корректной работ с классифицированными изображениями требуется легенда - таблица объединяющая метки классов и типы закодированных объектов.
:::

::: {#task-task .callout-tip}
Классифицируйте раст "DEM" по 3 классам, как показано выше. К полученному изображению примените стиль отображения "Палитра / Уникальные значения". Результат должен соответствовать изображению ниже (@fig-classification_task).

![Результат классификации изображения](./pictures/7_1_DEM_3_class.jpg){#fig-classification_task}
:::

## Обрезка растра по границе векторного слоя {#sec-dem_crop}

Часто требуется ограничить растровое изображение границами векторного слоя. Для выполнения этой операции возможно использовать два инструмента (они находятся во вкладке **"Растр" > "Извлечение"**): **"Обрезать растр по охвату..."** и **"Обрезать растр по маске..."**. Первый обрезает растр по границе наименьшего прямоугольника, в который попадает геометрия, второй - по границе собственно геометрии (полигона).  
При использовании инструмента **"Обрезать растр по охвату..."** в пункте "Исходный слой" задается растр, который необходимо обрезать. "Охват обрезки" задается двумя парами координат (левый нижний и правый верхний углы прямоугольника), которые возможно:

- заполнить вручную;
- "Рассчитать из слоя" (в этом случае необходимо выбрать слой); 
- задать "Текущий охват карты"; 
- "Указать на карте" напрямую (@fig-crop_by_videla). 

![Окно инструмента "Обрезать растр по охвату"](./pictures/7_1_Обрезка по охвату.png){#fig-crop_by_videla}

В результате применения инструмента появится новый временный растровый слой "Кадрированый (по охвату)". Для сохранения временного слоя на диск в контекстном меню выберите пункт **"Экспорт" > "Сохранить как"** формат **"GeoTIFF"**.

::: {#task-task .callout-tip}
Обрежьте растр "DEM" по охвату слоя "videl". Сохраните новый растр в папку проекта под названием "DEM_crop_extend".
:::

При использовании инструмента **"Обрезать растр по маске..."** в качестве "Исходного слоя" указывается растровое изображение, которое должно быть обрезано. В пункте "Слой маски" указывается векторный слой, по границам которого будет проведена обрезка. Чек-бокс **"Только выделенные объекты"** позволяет провести обрезку по границам выделенных объектов векторного слоя (@fig-crop_by_uchlesn).

![Окно инструмента "Обрезать растр по маске"](./pictures/7_2_Обрезка растра по маске.png){#fig-crop_by_uchlesn}

В результате применения инструмента появится новый временный растровый слоя "Кадрированный (по маске)".

::: {#task-task .callout-tip}
Обрежьте растр "DEM" по границе Караульного участкового лесничества (слой "uch_lesn"), используя инструмент **"Обрезать растр по маске..."**. Сохраните временный слой в папку проекта под названием "DEM_crop_mask".
Примечание: в слое "uch_lesn" находится несколько участковых лесничеств.
:::

## Зональная статистика

Зональная статистика предполагает разделение территории на несколько зон для каждой из которых извлекается значение из растрового слоя. При этом должна быть выбрана функция для агрегирования значений пикселей внутри каждой зоны. Это может быть среднее значение, медиана и др.  
Для выбора инструмента **"Зональная статистика"** активируйте **"Панель инструментов"** ![Панель инструментов](./icons/7_1_панель инструментов.png), в пункте **"Анализ растров"** выберите **"Зональная статистика"**. В открывшемся окне пункт **"Исходный слой"** определяет векторный полигональный слой с зонами, в пункте **"Растровый слой"** задается растровое изображение из которого будут извлечены значения для каждой зоны. Пункт **"Статистики для расчета"** позволяет выбрать несколько статистик, которые будут добавлены в атрибутивную информацию векторного слоя для каждой зоны (среднее, медиана и т.д.).  
В следующем примере была рассчитана максимальная, минимальная и средняя высота для каждого выдела. В инструменте **"Зональная статистика"**, пункте **"Исходный слой"** указывается векторный слой выделов ("videl"), в пункте растровый слой - слой "DEM", префикс поля ввода - "dem_". В пункте **"Статистики расчета"** указываются: **"Количество"; "Среднее"; "Минимум"; "Максимум"**. После выполнения появится временный векторный слой под названием "Зональная статистика" с рассчитанными показателями высоты для каждого выдела (поле "dem_count" - количество пикселей растрового слоя, попадающих в выдел; "dem_mean" - средняя высота для выдела; "dem_min" - минимальная высота для выдела; "dem_max" - максимальная высота для выдела) (@vid-zonal_stat).

![Настройка стиля отображения растра "DEM"](./videos/7_3_зональная статистика.mp4){#vid-zonal_stat}

::: {#task-task .callout-tip}
1. Руководствуясь примером выше, добавьте в слой выделов среднюю, максимальную и минимальную высоту над уровнем моря.
2. Окрасьте выделы, которые имеют среднюю высоту более 400 м, в красный цвет (режим стиля - "Символизация на основе правил")
3. Создайте макет и сохраните изображение, которое должно соответствовать рисунку ниже (@fig-task_dem_mean).

![Результат выполнения задания](./pictures/7_3_Выдела с высотой более 400.png){#fig-task_dem_mean}
:::

## Расчет топографических индексов.

::: {.callout-note}
## Обратите внимание!
Использующийся в этом разделе инструмент для расчета крутизны склона не корректно работает с растрами в географической системе координат (WGS84), поэтому для выполнения последующих заданий перепроецируйте цифровую модель рельефа в систему координат UTM (EPSG:32646 - WGS 84 / UTM zone 46N) и сохраните на диск под названием DEM_UTM. При выполнении последующих заданий используйте этот растр для расчета экспозиции и крутизны склона а так же TPI!  
Для перепроецирования растра в другую систему координат используется инструмент **"Растр" > "Проекции" > "Деформация (перепроецирование)..."**. В качестве исходного слоя выбирается цифровая модель рельефа (слой "DEM"), в пункте "Целевая система координат" задается EPSG:32646 - WGS 84 / UTM zone 46N. В пункте "Перепроецировано" указывается папка для сохранения растрового слоя (папка проекта) и название "DEM_UTM.tif" (@fig-dem_reproject).
:::

![Перепроецирование растра DEM](./pictures/7_7_Перепроецирование растра DEM.png){#fig-dem_reproject}

::: {#task-task .callout-tip}
Перепроецируйте растр "DEM" в систему коорданат EPSG:32646 - WGS 84 / UTM zone 46N. Сохраните растр на диск под названием "DEM_UTM.tif".
:::

На основе цифровой модели рельефа возможен расчет экспозиции и крутизны склона а так же топографических индексов TPI, TRI и др. Для примера рассчитаем экспозицию, крутизну и TPI.  
Для расчета экспозиции склона перейдите в пункт **"Растр" > "Анализ" > "Экспозиция..."**. В качестве исходного слоя выберите цифровую модель рельефа (слой "DEM_UTM"). Новый растр возможно сохранить сразу на диск, а не в виде временного слоя, для этого в пункте **"Экспозиция"** выберите **"Сохранить в файл..."** и укажите директорию проекта и название файла **"aspect.tif"**. После применения инструмента в панеле слоев появится новый слой "aspect" в каждой ячейке которого будет указана экспозиция склона в виде азимута (угол, отсчитываемый от северного направления географического меридиана). Равнинные участки будут иметь значние -9999, если не отмечен чек-бокс "Возвращать 0 в плоских областях..." (@fig-aspect).

![Инструмент "Экспозиция"](./pictures/7_4_Экспозиция.png){#fig-aspect}

::: {#task-task .callout-tip}
Рассчитайте экспозицию склона по примеру выше.
:::

Для расчета крутизны склона на основе цифровой модели рельефа используется инструмент **"Растр" > "Анализ" > "Крутизна..."**. В качестве исходного слоя выбирается цифровая модель рельефа (слой "DEM_UTM"), результат выполнения сохраните на диск под названием "slope.tif". В результате будет создан растровый слой, в каждой ячейке которого указана крутина склона в градусах (@fig-slope). 

![Инструмент "Крутизна"](./pictures/7_5_Крутизна.png){#fig-slope}

::: {#task-task .callout-tip}
Рассчитайте крутизну склона по примеру выше.
:::

## Создание многоканального изображения {#sec-multichannel_img}

Несколько изображений с одинаковыми пространственным разрешением, охватом и системой координат возможно объединить в одно многоканальное изображение. Таким образом в каждом пикселе изображения будет содержаться несколько переменных в виде отдельных каналов (слоев). Такая практика часто используется в мультиспектральных изображениях, получаемых со спутников.  
Для объединения нескольких изображений в одно многоканальное используется инструмент **"Растр" > "Прочее" > "Результат объединения..."**. В пункте "Исходные слои" отмечаются слои для объединения.

::: {.callout-note}
## Обратите внимание!
Последовательность отмеченны слоев в пункте "Исходные слои" будет соответствовать последовательности каналов в многоканальном изображении. Первый растр будет соответствовать каналу №1, второй растр - каналу № 2 и т.д. 
:::

Для создания многоканального изображения необходимо поставить чек-бокс в пункте **"Поместить каждый входной слой в отдельный канал"**, иначе склейка изображений произойдет в виде мозайки. "Выходной тип данных" должен соответствовать данным растровых изображений. Результатом применения инструмента станет многоканальный растровый слой "DEM_indexes" (@vid-dem_multi).

![Cоздание многоканального изображения](./videos/7_4_многоканальное изображение.mp4){#vid-dem_multi}

::: {#task-task .callout-tip}
Объедините созданные в предыдущих заданиях растровые слои в многоканальное изображение: 1 канал - "aspect"; 2 канал - "slope", 3 канал - "DEM_UTM" в многоканальное изображение. Сохраните полученное изображение в папку проекта под названием "DEM_indexes".
:::

## Классификация многоканального изображения {#sec-multichannel_img_classif}

Созданный многоканальный растр "DEM_indexes" позволяет провдить фильтрацию сразу по нескольким каналам (переменным). Для этого используется **"Растр" > "Калькулятор растров"** который уже применялся для классификации растра "DEM" в предыдущем разделе (@sec-dem_classification). В пункте "Каналы растра" отображаются растровые слои проекта в виде названия и номера канала отделенных символом "@", которые возможно использовать в вырежении для классификации по нескольким каналам. Например, для выделения участков земли на высоте более 300 м и крутизной более 30 градусов используется выражение: `"DEM_indexes@2">30 AND "DEM_indexes@3">300` (2 канал - "slope", 3 канал - "DEM_UTM"). Аналогично задается условие для выбороа участков на высоте от 200 до 300 метров с уклоном менее 20 градусов: `"DEM_indexes@2"< 20 AND "DEM_indexes@3" > 200 AND "DEM_indexes@3" < 300` (@fig-multi_classification).

![Классификация многоканального изображения](./pictures/7_7_классификация многоканального растра.png){#fig-multi_classification}

::: {#task-task .callout-tip}
Используя многоканальный растр "DEM_indexes", выделите участки с южной экспозицией склона (от 135 до 225 градусов) находящиеся на высоте до 300 метров. Сохраните новый растровый слой под названием "DEM_classification.tif". Результат выполнения задания представлен на рисунке ниже (@fig-task_multi_classification).
:::

![Результат выполнения задания по классификации (пиксели, соответствующие условию, окрашены в белый)](./pictures/7_8_результат задания классификации.png){#fig-task_multi_classification}

## Создание изолиний

Инструмент **"Растр" > "Извлечение" > "Создать изолинии..** используется для построения изолиний (горизонталей). В пункте "Исходный слой" указывается цифровая модель рельефа, пункт **"Расстояние между изолиниями"** определяет высоту сечения рельефа в метрах. Результатом применения инструмента является временный векторный слой горизонталей с атрибутом "ELEV" в котором указана высота каждой конкретной горизонтали (@fig-make_izos).

![Инструмент "Создать изолинии"](./pictures/7_9_Создать изолинии.png){#fig-make_izos}

::: {#task-task .callout-tip}
Создайте слой горизонталей с высотой сечения рельефа 20 метров, по примеру выше. Сохраните полученный векторный слой на диск под названием "Изолинии".
:::

## Оформление изолиний

Для оформления изолиний применяются режимы "Символизация на основе правил" и "Подписи на основе правил" (вкладки "Стиль" и "Надписи" контекстного меню слоя). Символизация должна соответствовать следующим условиям: 

- горизонтали оформляются линиями коричневого цвета; 
- горизонтали, отметки которых кратны 100 (каждая пятая горизонталь), оформляются утолщенной линией.  

Для второго условия применяется оператор `%` который возвращает остаток от деления. Для горизонталей, отметка которых кратна 100 метров, выражение `"ELEV" % 100` будет возвращать значение **0** ("ELEV" - поле в слое "Горизонтали" которое содержит отметку для каждой горизонтали) (@fig-make_izos_style).

![Создание стиля горизонталей](./pictures/7_10_Оформление горизонталей.png){#fig-make_izos_style}

::: {#task-task .callout-tip}
Настройте стиль слоя "Горизонтали" так, что бы горизонтали с отметками кратными 100 имели толщину линий 0.4, а все остальные горизонтали толщину 0.1. Цвет горизонталей коричневый. Для этого перейдите в контекстрое меню слоя **"Стиль" > режим "Символизация на основе правил"** (@fig-make_izos_task).
:::

![Результат выполнения задания по построению горизонталей](./pictures/7_11_Горизонтали.png){#fig-make_izos_task}

Подписываются горизонтали кратные 100 м. В этом случае используюется режим "Подписи на основе правил" а так же выражение `"ELEV" % 100 = 0` по аналогии с предыдущим заданием, но для подписей (@fig-izos_labels).
Так же настраивается **"Размещение"** подписей:

- **"Режим"** - параллельно; 
- **"Разрешенные позиции"** - на линии; 
- **"Повтор подписей"** - "Интервал" 10 000, "метры в масштабе". 

![Результат выполнения задания по построению горизонталей](./pictures/7_12_Подписи горизонталей.png){#fig-izos_labels}

::: {#task-task .callout-tip}
Добавьте подписи для горизонталей, отметки которых кратны 100. Для этого перейдите в контекстное меню слоя (**"Стиль" > "Надписи" > режим "Подписи на основе правил"**) и настройте подписи (@fig-izos_labels_task).
:::

![Результат выполнения задания (подписи горизонталей)](./pictures/7_13_Подписи горизонталей результат задания.png){#fig-izos_labels_task}







