# Добавление атрибутивной информации

С каждым объектом связан набор атрибутов, которые характеризуют тот или иной объект. Так, слой "Дороги" содержит атрибуты **id** и **name**, а слой выделов: **id** и **videl**. Атрибуты объектов отдельного слоя представлены в виде таблицы, где каждая строка - отдельный объект, а каждый столбец (который называется полем) - та или иная характирстика. Таким образом объекты одного слоя могут быть классифицированы в зависимости от их характеристик (например тип покрытия дороги или преобладающая порода выдела). Таблица атрибутов открывается нажатием правой кнопки мыши в панеле слоев - **Открыть таблицу атрибутов** (@fig-attrtable).

![Таблица атрибутов слоя "выдела"](./gif/17_Таблица атрибутов.gif){#fig-attrtable}

::: {.callout-tip}
## Задание
Откройте таблицу атрибутов слоя "выдела".
:::

При выделении строки в таблице атрибутов, связанная с ним геометрия будет подсвечена желтым цветом на карте, и наоборот (@fig-attrtablecon).

![Связь объектов с таблицей атрибутов](./gif/19_Выделение объектов.gif){#fig-attrtablecon}

Инструменты таблицы атрибутов по большей части дублируют инструменты основного окна программы ![инструменты таблицы атрибутов](./icons/10_Инструменты таблицы атрибутов.png). Они позволяют переключиться в **режим редактирования** слоя, **сохранить изменения**, **удалить выбранные объекты**, инструменты выделения объектов, инструменты по добавлению и удалению полей (**Новое поле** и **Удалить поле**), инструмент **Реаргонизовать колонки** для измнения порядка полей в таблице и другие.

## Создание и удаление полей

Создание новых полей возможно как при создании нового слоя, так и в дальнейшем в таблице атрибутов. Для однозначной индентификации каждого выдела в приделах участкового лесничества необходим не только номер выдела (это поле было добавлено при создании слоя "выдела" и заполнено в процессе оцифровки) но и номер квартала. Для добавления нового поля переведите слой в **Режим редактирования** (первая иконка в таблице атрибутов) и выберите инструмент **Новое поле**. Введите имя поля: "kvartal"; тип: "Целое число", размер: "2" (в таком случае поле сможет содержать только двухзначные числа, масимальный номер квартала может быть 99) (@fig-fieldkv).

![Настройки нового поля](./pictures/7_Настройки поля квартал.png){#fig-fieldkv}

::: {.callout-note}
## Обратите внимание!
Имена полей всегда вводятся на латинице без пробелов, для разделения слов можно использовать нижнее_подчеркивание. Использование других символов в имени поля может создать непредвиденные проблемы!
:::

После нажатия **ОК** в таблице атрибутов появится новое пустое поле **kvartal**.  
Для удаления полей используется инструмент **Удалить поле** (слой должен находиться в режиме редактирования). Воспользуемся этим инструментом что бы удалить поле **id**. В появившемся окне выберите удаляемое поле и нажмите ОК. Так же возможно выделить несколько полей сразу и удалить их.

::: {.callout-tip}
## Задание
В слоей "выдела" добавьте новое поле **kvartal**, как показано выше, и удалите поле **id**. Используйте инструмент **Реорганизовать колонки** что бы поменять порядок полей (**kvartal** затем **videl**). После чего сохраните изменения в слое. В результате таблица атрибутов слоя должна соответствовать рисунку ниже (@fig-videlatable).
:::

![Таблица атрибутов слоя "выдела"](./pictures/8_Таблица атрибутов выдела.png){#fig-videlatable}

При добавлении нового поля важно обращать внимание не только на **Имя** поля, но и на **Тип** данных поля, который определяет какой тип информации будет содержать поле. Для .shp файлов доступны следующие типы полей: **Целое число (integer 32 или 64 бита)**, размер поля определяет сколько символов может вмещать поле;  **Десятичное число (real)**, размер определяет общее число символов (включая дробную часть), точность - количество знаков после запятой; **Текст (string)** позволяет хранить надписи, количество символов так же определяется параметром **Размер**. При создании нового поля важно задать правильный тип поля и размер, изменить эти параметры в последствии будет не просто. Соответственно, если поле будет содержать порядковые номера объектов, следует выбрать тип **Целое число (integer 32 или 64 бита)**, если в поле будет записана длина или площадь - **Десятичное число (real)** с необходимой настройкой размера и точности, в случае названий объектов следует использовать тип **Текст (string)** необходимого размера.

## Ввод атрибутивной информации

Существует несколько способов добавления атрибутивной информации.Так, возможно заполнить таблицу вручную, как в любом табличном редакторе, или прикрепить уже существующую таблицу по ключевому полю. Так же возможно рассчитать новые атрибуты из уже имеющихся или из свойств геометрий объектов (например длина, площадь и т.д.). Для ввода информации вручную достаточно открыть таблицу атрибутов слоя, перевести слой в режим редактирования и заполнить нужные колонки как это делается в любом табличном редакторе.

::: {.callout-tip}
## Задание
Заполните вручную поле "kvartal" у первых пяти выделов. Номер кваратала для остальных выделов будет заполнен другим способом.
:::

Поскольку все значения поля **kvartal** будут одинаковыми, есть способ заполнить все значения сразу, используя **Редактор выражений** панель ниструментов которого появляется при переводе слоя в режим редактирования.

![Редактор выражений](./gif/20 Редактор выражений.gif){#fig-redactor}

**Редактор выражений** имеет расширенный режим, для перехода в который необходимо нажать на иконку ![Расширенный режим редактора выражений](./icons/11_Редактор выражений расширенный.png). Этот режим позволяет создавать сложные выражения, рассчитывать длины и площади объектов и многое другое. Мы более подробно познакомимся с этим режимом в последующих разделах. Для начала заполним поле **kvartal**. Для этого в редакторе выражений слева от равно выбирается поле, к которму будет применяться выражение, которое записывается справа от равно. Применить выражение можно ко всем объектам слоя (пункт **Обновить все**) или только к выделенным в данный момент (пункт **Обновить выделенные**). Слева укажем обновляемое поле (**kvartal**), справа - номер квартала, и выберем **Обновить все**. После того, как поле будет заполнено номером квартала сохраним изменения. Аналогичным способом возможно изменить атрибуты только у выделенных объектов (пункт **Обновить выделенные**), смотри @sec-pickobj.

![Заполнение поля "kvartal"](./gif/21_Заполнение поля квартал.gif){#fig-fieldkv}

::: {.callout-tip}
## Задание
Заполните поле "kvartal" как показано выше.
:::

## Объединение таблиц по ключевому полю

В случае когда существует отдельно слой геометрий объектов и атрибутивные описания (в виде "плоской" таблицы), рационально провести операцию объединения таблиц так, что бы к каждому объекту была присоединена соответствующая атрибутивная характеристика. Основное условие для проведения такой операции - наличие в обоих таблицах уникального ключевого поля (**key**) которое бы однозначно характеризовало каждый объект в одной и другой таблице. Далее в этом разделе будут использоваться данные 21 квартала Караульного участкового лесничества (файл **"выдела.shp"**), которые представлены контурами 477 выделов с двумя атрибутами: номер кваратала (**kvartal**) и номер выдела (**videl**). Таксационная характеристика содержится в отдельной таблице **"таксационные описания.xlsx"**, которая имеет одинаковые поля с векторным слоем (**kvartal** и **videl**) а так же таксационную характеристику для каждого выдела.

::: {.callout-tip}
## Задание
Загрузите векторный слой "выдела.shp" и файл "таксационные описания.xlsx" по **ссылке**. Создайте отдельную папку для нового проекта и сохраните туда загруженные файлы. Создайте новый пустой проект в QGIS и добавьте в него векторный слой "выдела.shp" после чего сохраните проект в папку проекта. Все файлы должны находиться в отдельной папке проекта.
:::

### Импорт таблицы

Программа QGIS позвояет загружать не только векторные и растровые данные (shp-файлы, GeoPackage, tif. и др.) но и обычные "плоски таблицы" которые могут быть созданы в любом табличном редакторе (Excal, Libreoffice Calc и др.). Один из способов загрузки таких таблиц - сохранение в формат **.csv (Comma-Separated Values)** и последующий экспорт в QGIS. CSV - [формат для представления табличных данных в виде текста](https://ru.wikipedia.org/wiki/CSV). Каждая строка в файле - строка в таблице, столбцы внутри строки отделяются друг от друга специальным символом - разделителем (delimiter). Несмотря на название формата, разделителем не обязательно должна быть запятая, более того, основное условие выбора символа-разделителя: он не должен встречаться в значениях таблицы. Если в таблице встерчаются дробные числа, где целая часть отделена запятой, нельзя использовать в качестве разделится запятую. Для того, что бы избежать непредвиденных проблем, часто в качестве разделителя используют символ табуляции (Tab). Выбрать разделитель можно при сохранении таблицы в формат **.csv** в любом табличном редакторе @fig-savecsv. После сохранения **.csv** файла в QGIS выберите пункт меню **Слой** > **Добавить слой** > **Добавить слой из текста с разделителями...**, проведите соответствующие настройки и загрузите таблицу. Такой способ позволяет более детально настроить параметры импортируемой таблицы, типы данных столбцов и т.д.  
Более простым способом является загрузка **.xlsx** файла напрямую в QGIS. Для этого перетяните файл **.xlsx** в окно программы, после чего таблица появится в панеле слоев. Если в файле несколько листов, появится панель с выбором. Изменения, произведенные в QGIS, будут сохранены в файл и наоборот.

![Импотр файла .xlsx](./gif/22_импорт Excel файла.gif){#fig-fieldkv}

::: {.callout-tip}
## Задание
Загрузите таблицу таксационных описаний в QGIS.
:::

### Создание ключевого поля

Уникальный индентификатор любого выдела состоит из названия лесничества, названия участкового лесничества, номера квартала и, собственно номера выдела. Такой ключ будет уникален для любого выдела. В нашем случае используются выдела на территории одного участкового лесничества, поэтому первые две составляющие ключа (лесничество и участковое лесничество) можно пропустить. Таким образом, ключ для связи между таблицами будет состоять из двух составляющих, разделенных нижним_подчеркиванием: номер квартала_номер выдела (**27_1**). Такое поле с ключем (**key**) необходимо создать как в атрибутивной таблице векторного слоя, так и в таблице таксационных описаний.  
Для создания ключевого поля, перейдите в таблицу атрибутов слоя "выдела" и создайте новое поле (Имя: **key**, Тип: **Текст**, Размер: **5**) @fig-makekeyfield.

![Создание ключевого поля](./pictures/9_создание ключевого поля.png){#fig-makekeyfield}

В панеле редактора выражений, слева от равно, выберите поле **key** и перейдите в расширенный режим редактора выражений ![Расширенный режим редактора выражений](./icons/11_Редактор выражений расширенный.png). В появившемся окне в левой части записывается выражение, в средней части - список доступных функций, в правой части - справка по этим функциям. В левой части окна запишите выражение, которое объединяет поля квартал и выдел с разделителем в виде нижнего подчеркивания (например для квартала 38 выдела 25 ключ будет выглядеть так: **38_25**) @fig-constructkeyfield. Во вкладке **Поля и значения** в центральной части редактора выражений, представлены все поля таблицы атрибутов. При двойном клике на поле, оно появится в панеле слева.

![Заполнение ключевого поля](./pictures/10_заполнение ключевого поля.png){#fig-constructkeyfield}

Результат выражения отображается в левом нижнем углу окна (**Просмотр:**). Если выражение составлено не корректно, вместо результата выражения будет отображаться надпись "Ошибочное выражение". В этом случае следует найти и устранить ошибку. После написания выражения, нажмите **ОК** а затем **Обновить все**. Перед обновлением поля убедитесь что слева от равно указано поле **key** иначе есть риск перезаписать данные другого поля. В результате поле **key** должно быть заполнено сочетаниями квартал_выдел для каждого выдела @fig-fillkeyfield.

![Обновление ключевого поля](./pictures/11_Обновление ключевого поля.png){#fig-fillkeyfield}

Сохраните изменения в слое и создайте поле **key** в таблице с таксационными описаниями аналогичным образом.

::: {.callout-tip}
## Задание
Создайте и заполните поле **key** в слоях "выдела" и "таксационные описания".
:::

### Объединение таблиц

После того как поле key создано в двух таблицах, его можно использовать для связи строк таблиц между собой. Для этого перейдите в **Свойства...** слоя "выдела" > **Связи** > **Добавить новую связь** ![добавить новую связь](./icons/12_добавить новую связь.png). В пункте **Присоединить слой** выберите слой таблицы таксационных описаний, **Связываемое поле** - **key**, **Целевое поле** - **key**. После нажатия **ОК** - **Применить** в атрибутивной таблие слоя "выдела" появится присоединенная таксационная характеристика @fig-jointables. В настройках связи так же можно выбрать присоединяемые поля (столбцы таблицы, которые будут присоединены к векторному слою) или задать пользовательский префикс имени поля (общее название, которое будет добвалено перед именами присоединяемых столбцов).

![Настройка связи таблиц](./pictures/14_связь таблиц.png){#fig-jointables}

::: {.callout-tip}
## Задание
Присоедините к векторному слою "выдела" таблицу таксационных характеристик. В качестве префикса имени поля используйте "tax_". Результат объединения представлен на рисунке ниже @fig-jointablesfinal.
:::

![Объединенная таблица атрибутов](./pictures/15_прикрепленная таблица.png){#fig-jointablesfinal}

Слой с присоединенной атрибутивной информацией можно сохранить как новый векторный слой и использовать в дальнейшей работе. Для этого в панеле слоев перейдите в меню выбранного слоя > **Экспорт** > **Сохранить объекты как...**. В новом окне "Сохранить векторный слой как..." выберите формат **Shape-файл ESRI**. Для выбора папки сохранения файла в поле **"Имя файла"** нажмите **...** и укажите папку проекта. После чего нажмите **ОК**, новый слой появится в панеле слоев.

::: {.callout-tip}
## Задание
Сохраните в папку проекта векторный слой "выдела" с прикрепленной атрибутивной информацией в файл под названием "выдела2".
:::


