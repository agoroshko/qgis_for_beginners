# Атрибутивная информация

С каждым объектом связан набор атрибутов, которые характеризуют тот или иной объект. Так, слой "Дороги" содержит атрибуты **id** и **name**, а слой выделов: **id** и **videl**. Атрибуты объектов отдельного слоя представлены в виде таблицы, где каждая строка - отдельный объект, а каждый столбец (который называется полем или атрибутом) - та или иная характирстика. Таким образом объекты, кроме положения в пространстве и формы, могут иметь количественные и качественные характеристики (например тип покрытия дороги или средний возраст насаждения в выделе). Таблица атрибутов открывается нажатием правой кнопки мыши в панеле слоев **> "Открыть таблицу атрибутов"** ![1](./QGIS_icons/mActionOpenTable.svg) (@vid-open_attr_table).

![Открытие таблицы атрибутов слоя](./videos/3_1_Открыть таблицу атрибутов.mp4){#vid-open_attr_table}

::: {#task-task .callout-tip}
Откройте таблицу атрибутов слоя "Выделы".
:::

При выделении строки в таблице атрибутов, связанная с ним геометрия будет подсвечена желтым цветом на карте, и наоборот (см. @sec-pickobj).
Инструменты таблицы атрибутов по большей части дублируют инструменты основного окна программы (@fig-attr_table_tools). В режиме редактирования доступно большее количество инструментов а так же появляется дополнительная строка для массового редактирования атрибутов (@fig-attr_table_tools2).

::: {#fig-attr_table_tools layout-nrow=2}

![Инструменты таблицы атрибутов](./pictures2/3_1_Таблица атрибутов_1.png){#fig-attr_table_tools1}

![Инструменты таблицы атрибутов в режиме редактирования](./pictures2/3_2_Таблица атрибутов_2.png){#fig-attr_table_tools2}

Таблица атрибутов
:::

Они позволяют переключить слой в **"Режим редактирования"** ![1](./QGIS_icons/mActionToggleEditing.svg), **сохранить изменения** ![1](./QGIS_icons/mActionSaveAllEdits.svg), **удалить выбранные объекты** ![1](./QGIS_icons/mActionDeleteSelected.svg), инструменты выделения объектов, инструменты по добавлению и удалению полей (**"Новое поле"** ![1](./QGIS_icons/mActionNewAttribute.svg) и **"Удалить поле"** ![1](./QGIS_icons/mActionDeleteAttribute.svg)), инструмент **"Реаргонизовать колонки"** ![1](./QGIS_icons/mActionEditTable.svg) для измнения порядка полей в таблице и другие.

## Создание и удаление полей

Создание новых полей возможно как при создании нового слоя, так и в дальнейшем в таблице атрибутов. Для однозначной индентификации каждого выдела в приделах участкового лесничества необходим не только номер выдела (это поле было добавлено при создании слоя "выдела" и заполнено в процессе оцифровки) но и номер квартала. Для добавления нового поля переведите слой в **Режим редактирования** ![1](./QGIS_icons/mActionToggleEditing.svg) и выберите инструмент **Новое поле** ![1](./QGIS_icons/mActionNewAttribute.svg). Введите имя поля: **"kvartal"**; тип: **"Целое число"**, размер: **2** (в таком случае поле сможет содержать только двухзначные числа, масимальный номер квартала может быть 99) (@fig-fieldkv).

![Настройки нового поля](./pictures/7_Настройки поля квартал.png){#fig-fieldkv}

::: {.callout-note}
## Обратите внимание!
Имена полей всегда вводятся на латинице без пробелов, для разделения слов можно использовать нижнее_подчеркивание. Использование других символов в имени поля может создать непредвиденные проблемы!
:::

После нажатия **ОК** в таблице атрибутов появится новое пустое поле **"kvartal"**.  
Для удаления полей используется инструмент **"Удалить поле"** ![1](./QGIS_icons/mActionDeleteAttribute.svg) (слой должен находиться в режиме редактирования). Воспользуемся этим инструментом что бы удалить поле **id**. В появившемся окне выберите удаляемое поле и нажмите ОК. Так же возможно выделить несколько полей сразу и удалить их.

::: {#task-task .callout-tip}
В слой **"выдела"** добавьте новое поле **kvartal**, как показано выше, и удалите поле **id**. Используйте инструмент **Реорганизовать колонки** ![1](./QGIS_icons/mActionEditTable.svg) что бы поменять порядок полей (**kvartal** затем **videl**). После чего сохраните изменения в слое. В результате таблица атрибутов слоя должна соответствовать рисунку ниже (@fig-videlatable).

![Таблица атрибутов слоя "выдела" после выполнения задания](./pictures/8_Таблица атрибутов выдела.png){#fig-videlatable}
:::

При добавлении нового поля важно обращать внимание не только на **Имя** поля, но и на **Тип данных**, который определяет какой тип информации может содержать поле. Для .shp файлов доступны следующие типы полей: 

- **Целое число (integer 32 или 64 бита)**, размер поля определяет сколько символов может вмещать поле;
- **Десятичное число (real)**, размер определяет общее число символов (включая дробную часть), точность - количество знаков после запятой; 
- **Текст (string)** позволяет хранить надписи, количество символов так же определяется параметром **"Размер"**. 

При создании нового поля важно задать правильный тип поля и размер, изменить эти параметры в последствии будет не просто. Соответственно, если поле будет содержать порядковые номера объектов, следует выбрать тип **Целое число (integer 32 или 64 бита)**, если в поле будет записана длина или площадь - **Десятичное число (real)** с необходимой настройкой размера и точности, в случае названий объектов следует использовать тип **Текст (string)** необходимого размера.

::: {#task-task .callout-tip}
!!!Добавить задание на создание полей разных типов и их различия
:::

## Ввод атрибутивной информации

Существует несколько способов добавления атрибутивной информации. Так, возможно заполнить таблицу атрибутов вручную, как в любом табличном редакторе, или прикрепить уже существующую таблицу по ключевому полю. Так же возможно рассчитать новые атрибуты из уже имеющихся или из свойств геометрий объектов (например длина, площадь, периметр и т.д.). Для ввода информации вручную достаточно открыть таблицу атрибутов слоя, перевести слой в режим редактирования и заполнить нужные колонки как это делается в любом табличном редакторе.

::: {#task-task .callout-tip}
Заполните вручную поле "kvartal" у первых **пяти** выделов. Номер кваратала для остальных выделов будет заполнен другим способом.
:::

Поскольку все значения поля **kvartal** будут одинаковыми, есть способ заполнить все значения сразу, используя **Редактор выражений** панель ниструментов которого появляется при переводе слоя в режим редактирования.

![Редактор выражений](./gif/20 Редактор выражений.gif){#fig-redactor}

**Редактор выражений** имеет расширенный режим, для перехода в который необходимо нажать на иконку ![1](./QGIS_icons/mIconExpression.svg). Этот режим позволяет создавать сложные выражения, рассчитывать длины и площади объектов и многое другое. Мы более подробно познакомимся с этим режимом в последующих разделах. Для начала заполним поле **"kvartal"**. Для этого в редакторе выражений слева от равно выбирается поле, к которму будет применяться выражение, справа - выражение. Применить выражение можно ко всем объектам слоя (пункт **"Обновить все"**) или только к выделенным в данный момент (пункт **"Обновить выделенные"**). Слева укажите обновляемое поле (**"kvartal"**), справа - номер квартала, и веберите пункт **"Обновить все"**. После того, как поле будет заполнено номером квартала сохарните изменения (иконка ![1](./QGIS_icons/mActionSaveAllEdits.svg)). Аналогичным способом возможно изменить атрибуты только у выделенных объектов (пункт **"Обновить выделенные"**, см. @sec-pickobj).

![Заполнение поля "kvartal"](./gif/21_Заполнение поля квартал.gif){#fig-fieldkv}

::: {#task-task .callout-tip}
Заполните поле "kvartal" по примеру выше.
:::

## Объединение таблиц по ключевому полю

::: {.callout-note}
## Загрузите файлы!
Для выполнения последующих заданий из этого раздела загрузите файлы по [ссылке](https://github.com/agoroshko/qgis_for_beginners/tree/main/files/ch3_%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B0%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B9%20%D0%B8%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%86%D0%B8%D0%B8)
:::

В случае когда существуют отдельно слой геометрий объектов и атрибутивные описания (в виде "плоской" таблицы), рационально провести операцию объединения таблиц так, что бы к каждому объекту была присоединена соответствующая атрибутивная характеристика. Основное условие для проведения такой операции - наличие в обеих таблицах уникального ключевого поля (**key**) которое бы однозначно характеризовало каждый объект в одной и другой таблице. Далее в этом разделе будут использоваться данные 21 квартала Караульного участкового лесничества (файл **"выдела.shp"**), которые представлены контурами 477 выделов с двумя атрибутами: номер кваратала (**kvartal**) и номер выдела (**videl**). Таксационная характеристика содержится в отдельной таблице **"таксационные описания.xlsx"**, которая имеет одинаковые поля с векторным слоем (**kvartal** и **videl**) а так же таксационную характеристику для каждого выдела.

::: {#task-task .callout-tip}
Загрузите файлы "выдела.shp" и "таксационные описания.xlsx". Создайте новый проект и загрузите туда слой выделов (@sec-vectorization). Сохраните файл проекта.
:::

### Импорт таблицы

Программа QGIS позвояет загружать не только векторные и растровые данные (shp-файлы, GeoPackage, tif. и др.) но и обыкновенные таблицы которые могут быть созданы в любом табличном редакторе (Excal, Libreoffice Calc и др.). Один из способов загрузки таких таблиц - сохранение в формат **.csv (Comma-Separated Values)** и последующий экспорт в QGIS (см. @sec-csv). Более простым способом является загрузка **.xlsx** файла напрямую в QGIS. Для этого перетяните файл **.xlsx** в окно программы, после чего таблица появится в панеле слоев. Если в файле несколько листов, появится панель с выбором. Изменения, произведенные в QGIS, будут сохранены в файл и наоборот.

![Импорт файла .xlsx](./gif/22_импорт Excel файла.gif){#fig-fieldkv}

::: {#task-task .callout-tip}
Загрузите таблицу таксационных описаний в QGIS.
:::

### Создание ключевого поля

Уникальный индентификатор любого выдела состоит из названия лесничества, названия участкового лесничества, номера квартала и, собственно номера выдела. Такой ключ будет уникален для любого выдела. В нашем случае используются выдела на территории одного участкового лесничества, поэтому первые две составляющие ключа (лесничество и участковое лесничество) можно пропустить. Таким образом, ключ для связи между таблицами будет состоять из двух составляющих, разделенных нижним_подчеркиванием: номер квартала_номер выдела (**27_1**). Такое поле с ключем (**key**) необходимо создать как в атрибутивной таблице векторного слоя, так и в таблице таксационных описаний.  
Для создания ключевого поля, перейдите в таблицу атрибутов слоя "выдела" и создайте новое поле (Имя: **key**, Тип: **Текст**, Размер: **5**) @fig-makekeyfield.

![Создание ключевого поля](./pictures/9_создание ключевого поля.png){#fig-makekeyfield}

В панеле редактора выражений, слева от равно, выберите поле **key** и перейдите в расширенный режим редактора выражений ![1](./QGIS_icons/mIconExpression.svg). В появившемся окне в левой части записывается выражение, в средней части - список доступных функций, в правой части - справка по этим функциям. В левой части окна запишите выражение, которое объединяет поля квартал и выдел с разделителем в виде нижнего подчеркивания (например для квартала 38 выдела 25 ключ будет выглядеть так: **38_25**) @fig-constructkeyfield. Во вкладке **Поля и значения** в центральной части редактора выражений, представлены все поля таблицы атрибутов. При двойном клике на поле, оно появится в панеле слева.

![Заполнение ключевого поля](./pictures/10_заполнение ключевого поля.png){#fig-constructkeyfield}

Результат выражения отображается в левом нижнем углу окна (**Просмотр:**). Если выражение составлено не корректно, вместо результата выражения будет отображаться надпись "Ошибочное выражение". В этом случае следует найти и устранить ошибку. После написания выражения, нажмите **ОК** а затем **Обновить все**. Перед обновлением поля убедитесь что слева от равно указано поле **key** иначе есть риск перезаписать данные другого поля. В результате поле **key** должно быть заполнено сочетаниями квартал_выдел для каждого выдела @fig-fillkeyfield.

![Обновление ключевого поля](./pictures/11_Обновление ключевого поля.png){#fig-fillkeyfield}

Сохраните изменения в слое и создайте поле **key** в таблице с таксационными описаниями аналогичным образом.

::: {#task-task .callout-tip}
Создайте и заполните поле **key** в слоях "выдела" и "таксационные описания".
:::

### Объединение таблиц

После того как поле key создано в двух таблицах, его можно использовать для связи строк таблиц между собой. Для этого перейдите в **"Свойства..."** слоя "выдела" > **"Связи"** > **"Добавить новую связь"** ![1](./QGIS_icons/symbologyAdd.svg). В пункте **"Присоединить слой"** выберите слой таблицы таксационных описаний, **"Связываемое поле"** - **"key"**, **"Целевое поле"** - **"key"**. После нажатия **"ОК"** > **"Применить"** в атрибутивной таблие слоя "выдела" появится присоединенная таксационная характеристика @fig-jointables. В настройках связи так же можно выбрать присоединяемые поля (столбцы таблицы, которые будут присоединены к векторному слою) или задать пользовательский префикс имени поля (общее название, которое будет добвалено перед именами присоединяемых столбцов).

![Настройка связи таблиц](./pictures/14_связь таблиц.png){#fig-jointables}

::: {#task-task .callout-tip}
Присоедините к векторному слою "выдела" таблицу таксационных характеристик. В качестве префикса имени поля используйте "tax_". Результат объединения представлен на рисунке ниже (@fig-jointablesfinal).

![Фрагмент объединенной таблицы атрибутов после выполнения задания](./pictures/15_прикрепленная таблица.png){#fig-jointablesfinal}
:::

Слой с присоединенной атрибутивной информацией можно сохранить как новый векторный слой и использовать в дальнейшей работе. Для этого в панеле слоев перейдите в контекстное меню выбранного слоя > **Экспорт** > **Сохранить объекты как...**. В новом окне "Сохранить векторный слой как..." выберите формат **Shape-файл ESRI**. Для выбора папки сохранения файла в поле **"Имя файла"** нажмите **...** и укажите папку проекта. После чего нажмите **ОК**, новый слой появится в панеле слоев.

::: {#task-task .callout-tip}
Сохраните в папку проекта векторный слой "выдела" с прикрепленной атрибутивной информацией в файл под названием "выдела2".
:::
