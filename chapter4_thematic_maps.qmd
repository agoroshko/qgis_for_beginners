# Cоздание тематических карт

```{r}
#| echo: false

# Нумерация заданий
ch <- 4 # Номер главы
t <- 1 # Номер первого задания (task)

task_fun <- function(ch, t){
  t <<- t+1
  
  paste(ch, t, sep = ".")
}

# Пример заголовка задания
## Задание `r task_fun(ch, t)`
```

::: {.callout-note}
Для выполнения заданий из этого раздела загрузите файлы по [ссылке](https://github.com/agoroshko/qgis_for_beginners/tree/main/files/%D1%81h4_C%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%82%D0%B5%D0%BC%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D1%85%20%D0%BA%D0%B0%D1%80%D1%82)
:::

Важной частью географических информационных систем является возможность визуализации информации. Графический анализ позволяет устранить ошибки данных или выявить закономерности. Раздел посвящен возможностям визуализации в программе QGIS. Для выполнения заданий из этого раздела загрузите необходимые файлы. Обратите внимание, загруженные файлы сохранены в формате .gpkg (GeoPackage). Особенности этого формата рассмотрены в приложении (@sec-gpkg).  
Исходные данные представлены четырьмя слоями, которые содержат информацию о части Караульного лесничества: kvartala.gpkg - границы кварталов; videla.gpkg - границы лесных выделов с таксационными характеристиками; roads.gpkg - дороги; rivers.gpkg - реки. Перечисленные слои будут использоваться для создания тематических карт.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Создайте новую папку проекта а так же новый проект в QGIS и загрузите файлы в программу. Сохраните проект в папку проекта. 
:::

## Система координат проекта

Системы координат подразделяются на географические и спроецированные (местные системы координат не рассматриваются в этом пособии). Геогрифические системы рассматривают землю как объемную фигуру (эллипсоид), спроецированные делят поврехность зелмли на равные части (зоны) и рассматривают каждую зону как проекцию на плоскость. Как следствие, различаются единицы измерения координат. Положение точки в географической системе координат определеяется в угловой мере (градусы, минуты и секунды) по широте и долготе. В спроецированной системе координат положение точки определяется на плоскости (декардова система координат) и выражается в километрах по оси Х и У. Среди географических систем координат наиболее распространена **WGS 84 (EPSG:4326)**, на основе которой построена спроецированная система координат **UTM (EPSG:32xxx)**. Система координат UTM делит поверхность земли по экватору на 60 зон а так же на северное и южное полушарие. Например, система координат **WGS 84 / UTM zone 46N (EPSG:32646)** представляет 46 зону северного полушария (буква N в названии зоны указывает на полушарие). Для интернет-карт повсеместно распространено использование системы **WGS 84 / Pseudo-Mercator (EPSG:3857)** которая так же называется Web Mercator, которая была разработана компаний Google и является одновременно географической (для мелкого масштаба) и спроецированной (для крупного масштаба).

::: {.callout-note}
## Обратите внимание!
Систему координат **WGS 84 / Pseudo-Mercator (EPSG:3857)** удобно сипользовать в качестве системы координат проекта, но не следует создавать слои в этой системе координат. Для этих целей используйте WGS 84 или UTM.
:::

В программе QGIS реализовано перепроецирование "на лету" (on fly). Векторные слои могут иметь различные системы координат, но в основном окне программы они отображаются согласованно - в одной и той же **системе координат проекта**. Для изменения системы координат проекта выберите **"Проект" > "Свойства" > "СК"** или нажмите на символ в правом нижнем углу ![СК](./icons/13_СК.png). После чего появится окно с настройками системы координат @fig-proj_crs.

![Настройка системы координат проекта](./pictures/18_Система координат проекта.png){#fig-proj_crs}

У каждой системы координат существует уникальный номер **EPSG**, который удобно использовать для поиска. Изображение в правом нижнем углу окна показывает область применения системы координат на поверхности земли. Текущее положение основного окна карты отображено перекрестием а область применения - красной заливкой, что особенно удобно при выборе нужной зоны спроецированной системы координат. После выбора нужной системы координат проекта нажмите **"Применить" > "ОК"**, изображение в главном окне программы изменится согласно выбранной системе координат.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
1. Какая зона UTM подходит вашему проекту? Выберите подходящую систему координат из следующих: 
- WGS 84 / UTM zone 45N (EPSG:32645); 
- WGS 84 / UTM zone 46N (EPSG:32646); 
- WGS 84 / UTM zone 46S (EPSG:32746). 
2. Задайте систему координат проекта WGS 84 / Pseudo-Mercator (EPSG:3857).
:::

Координаты положения курсора отображаются посередине в нижней части главного окна программы, рядом с текущим масштабом. Формат отображаемых координат настраивается в меню **"Проект" > "Свойства..." > "Общие" > "Отображение координат..."**. Географические координаты могут быть отображены в десятичных градусах, градусах и минутах или градусах, минутах и секундах (пункт "Coordinate format"). Так же настраиваются единицы измерения: метры или градусы (degrees) и точность координат.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Измените формат отображаемых координат в нижней части экрана. Формат отображения координат должен быть следующим: ![Координаты](./icons/14_координаты.png)
:::

## Обычные подписи {#sec-simple_labels}

Подписи объектов существенно увеличивают информативность карты. Они настраиваются отдельно для каждого слоя в меню **"Свойства..." > "Надписи"**. Существует несколько режимов отображения подписей: **"Без подписей", "Обычные подписи", "Подписи на основе правил", "Препятствие для подписей"**. В этом и слдующем подразделах будут рассмотрены "Обычные подписи" и "Подписи на основе правил". Рассмотрим подписи объектов на примере слоя "kvartala" (проект с этим слоем был создан в начале раздела). При настройке "Обычных подписей" основным параметром является **"Значение"**, которым будет подписан каждый объект в этом слое. Слой лесных кварталов содержит поле "kvartal" в котором записан номер квартала для каждого объекта. В этом не сложно убедиться, если открыть таблицу атрибутов слоя. Именно это поле указывается в пункте **"Значение"**. Таким образом каждый квартал получает подпись из соответствующего поля атрибутивной таблицы - номер квартала @fig-labels.

![Подписи слоя "kvartala"](./gif/23_Подписи.gif){#fig-labels}

Остальные настройки не влияют на содержание подписей, только на их оформление. Внесенные изменения сразу отображаются в верхней части окна под названием "Образец текста". Пункт "Текст" позволяет настроить шрифт, размер и цвет текста. "Форматирование" настраивает регистр, отступы, перенос подписей по строкам, форматы чисел. Крайне полезными настройками является "Буферизация" и "Фон", позволяющие строить буфер (по умолчанию белого цвета) вокруг подписей, так повышается их видимость на фоне других объектов. Пункт "Размещение" настраивает положение подписей относительно объекта. Чаще всего подписи размещают на некотором расстоянии от точечных объектов или внутри полигонов. "Отрисовка" позволяет задать масштаб карты для отображения подписей. При большом количестве подписей они могут накладываться друг на друга. В этом случае по умолчанию часть подписей не будет видна, что бы изменить это поведение перейдите в пунк **"Настройки размещения подписей"** в правом верхнем углу окна и поставьте чек-бокс "Показывать все подписи для всех слоев (включая наложения)" @fig-labels2.

![Наложение подписей](./gif/24_наложение подписей.gif){#fig-labels2}

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Измените подписи слоя "kvartala". Установите шрифт - Liberation Sans, размер - 20, цвет текста - зеленый, буфер вокруг подписей - белый.
:::

В некоторых случаях требуется отобразить подписи сразу из нескольких полей, например номер выдела и площадь. Настроить такую подпись возможно в редакторе выражений ![Редактор выражений](./icons/11_Редактор выражений расширенный.png) (левый верхний угол окна). Создадим подписи объектов слоя "videla" из полей "videl" (номер выдела) и "s_ga" (площадь в гектарах) разделенных тире. Перейдите в окно "Редактор выражений" в центральной части в пункте "Поля и значения" найдите поля "videl" и "s_ga". После двойного клика они будут перенесены в левую часть окна, где и формируется выражение. Разделите их символом "Сцепление строк" ![Сцепление строк](./icons/15_сцепление строк.png) что бы получилось следующее выражение: `"videl" || ' - ' || "s_ga"` (@fig-concatenate). Результатом выражения отображается в нижнем левом угул окна, пункт "Просмотр:". Если в этом пункте отображается надпись "Ошибочное выражение" следует исправить выражение.

![Создание подписи из нескольких полей](./pictures/19_Объединение полей.png){#fig-concatenate}

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Создайте подписи слоя "videla" из полей "videl" и "el_lesa" (преобладающая порода) по примеру выше.
:::

## Подписи на основе правил {#sec-labels_by_rules}

Использование режима "Обычные подписи" удобно, когда все объекты слоя должны быть подписаны одинаково. Если же часть объектов должна остаться без подписей или подписи должны изменяться по условию - применяют режим "Подписи на основе правил". Рассмотрим работу с этим режимом на примере слоя "videla" который содержит границы выделов и таксационную характеристику каждого из них. Основной настройкой здесь является задание логического правила, согласно которому будут отобраны объекты. Перейдите в режим "Подписи на основе правил" и добавьте новое правило нажав на символ ![Добавить правило](./icons/12_добавить новую связь.png). В верхней части окна "Edit Rule" задается правило, в нижней - настраивается подпись. Рассмотрим врхнюю часть окна, поскольку настройка подписи была рассмотрена выше (@sec-simple_labels).  
В пункте "Описание" вводится название правила. У каждого правила может быть два режима "Поиск" и "Иначе для всех остальных объектов". Второй пункт используется, когда создано несколько правил и требуется добавить подписи для всех остальных объектов. Для создания правила используется окно "Конструктор выражений" ![Конструктор выражений](./icons/11_Редактор выражений расширенный.png). Логические условия задаются на основе атрибутов объектов. Для примера составим выражение в котором будут подписаны лесные выдела с площадью более 4 га: `"s_ga" > 4`. Функция "Проверка" позволяет узнать количество объектов, попадающих под это условие @fig-labels_rules. Более подробно создание логических выражений будет рассмотрено в @sec-queries.

![Создание подписей на основе правил](./gif/25_подписи на основе правил.gif){#fig-labels_rules}

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Создайте подписи слоя "videla". Добавьте номер выдела только для тех выделов, в которых средний возраст насаждения более 100 лет (средний возраст - поле "A_let").
:::

## Настройки стиля объектов

Одним из ключевых имнструментов визуализиции пространственных данных является раскраска объектов цветом. Все объекты слоя могут быть окрашены одинаково или, в зависимости от значений атрибутов, иметь разные цвета. В программе QGIS настройка стиля отображения объектов производится в контекстном меню панели слоев **"Свойства..." > "Стиль"**. Существует несколько режимов отображения объектов: **"Без отрисовки"** объекты будут не видны но надписи объектов будут отображаться; **"Простая символика"** задает единый стиль для всех объектов слоя; "Символизация по уникальным значениям" позволяет задать стиль отображения в зависимости от значений качественного атрибута (преобладающая порода, класс бонитета и т.д.); **"Символизация по диапазонам значений"** задает стиль в зависимости от количественного атрибута (средний возраст насаждения, средний диаметр, запас и т.д.). **"Символизация на основе правил"** позволяет задать гибкие правила для отображения стиля объектов по нескольким атрибутам. Настройка символики несколько видоизменяется в зависимости от типа геометрии слоя. Для точек будет задаваться стиль маркера, для линий - стиль линии, для полигонов - стиль заливки. Особенности геометрий объектов отражаются на особенностях их отображения. Упомянутые выше режимы отображения объектов рассмотрены далее на примере полигонального слоя "videla" из созданного ранее проекта.

## Простая символика

В режиме "Простая символика" все объекты отображаются в одном стиле, который может быть простым (состоит из одного слоя) так и сложным (состоящим из двух и более слоев). По умолчанию единственным слоем является "Простая заливка". Комбинируя несколько простых слоев возможно создать сложный стиль отображения.

### Простая заливка

![Простая заливка](./pictures/20_Простая заливка.png){#fig-simple_fill}

Тип слоя "Простая заливка" (@fig-simple_fill) позволяет настоить основных два цвета: "Цвет заливки" и "Цвет обводки". Стиль заливки может быть сплошной, без заливки или разными видами штриховки. Для обводки объектов настраивается толщина и стиль (сплошная, без обводки и штриховка).

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Измените "Цвет заливки" и "Цвет обводки" слоя "videla" по вашему усмотрению.
:::

Комбинируя несколько слоев создаются сложные заливки. Для этого добавьте еще один слой нажав на символ ![Добавить слой](./icons/12_добавить новую связь.png) в правом верхнем углу. Верхний слой будет перекрывать нижний, поэтому он должен быть полупрозрачным или залит штриховкой. После настройки изображение в квадрате слева изменится, в соответствии с новым стилем штриховки @fig-two_layers.

![Комбинирование двух слоев заливки](./gif/26_два_слоя.gif){#fig-two_layers}

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Объедините два слоя заливки по примеру выше. Настройки выберите самостоятельно.
:::

Аналогичным образом применяются и комбинируются другие типы слоев.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Выберите любой тип слоя кроме "Простая заливка", настройте его по своему усмотрению и оцените результат.
:::

## Символизация по уникальным значениям

Признаки (характеристики) объектов подразделяются на два больших класса: **количественные и качественные**. Количественные признаки это числовые измерения характеристик объекта (например средний возраст, средняя высота, средний диаметр древостоя), качественные - принадлежность к той или иной категории (преобладающая порода, тип леса, класс бонитета).  
Для отображения **качественных** признаков используется **символизация по уникальным значениям**, при этом каждому уникальному значению задается определенный стиль. Для примера раскрасим слой выделов по преобладающей породе (поле "el_lesa"). Перейдите в пункт **"Свойства слоя" > "Стиль" > "Символизация по уникальным значениям"**, в пункте "Значение" указывается поле для классификации ("el_lesa"). После нажатия "Классифицировать" каждому уникальному значению поля будет присвоен определенный стиль. По умолчанию для раскраски применяются случайные цвета ("Random colors"), определенный набор цветов задается в пункте "Градиент" (@fig-unique_values).

![Символизация по уникальным значениям преобладающей породы](./videos/vid_4_Уникальные значения.mp4){#fig-unique_values}

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Выберите слой "videla" и примените режим символизации по уникальным значениям для типа леса (поле "tip_lesa").
:::

## Символизация по диапазонам значений

Для **количественных** признаков применяется режим **символизация по диапазонам значений**. Диапазон значений признака разбивается на интервалы каждый из которых окрашивается согласно выбранному градиенту цвета. В пункте "Значение" выбирается поле с количественными значениями, в пункте "Градиент" задается градиент цвета который может быть выбран из предустановленного списка или создан вручную по двойному клику.  
Ключевым моментом является разбиение числовой переменной на классы (интервалы), которое определяется режимом ("Fixed Interval", "Logarithmic Scale" и др.) с возможностью выбора количества классов. Увеличение количества классов приводит к более подробному отображению изменений переменной. Способ разбиения на классы часто определяется распределением переменной, которое изображено во вкладке "Диаграмма рассеяния". После установки всех параметров и нажатия "Классифицировать", интервалы и соответствующие им стили отображения появятся на экране в виде таблицы со столбцами "Знак", "Значения" и "Легенда" (@fig-diapazon_values). 

![Символизация по диапазонам значений площади выдела](./pictures/4_1_Диапазоны значений.png){#fig-diapazon_values}

В столбце "Знак" возможно отключить видимость отдельного интервала или изменить стиль. В столбце "Значения" отображааются границы интервала, которые возможно изменить вручную. Столбец "Легенда" отображает подписи в легенде, которые так же возможно изменить вручную. 

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Примените режим символизации по диапазонам значений для среднего возраста (поле "A_let") слоя "videla" как показано на рисунке ниже (@fig-diapazon_values_task).
:::

![Пример символизации по диапазонам значений](./pictures/4_2_Диапазоны значений задание.png){#fig-diapazon_values_task}

## Cимволизация на основе правил {#sec-rules}

**Символизация на основе правил** по принципу своей работы схожа с режимом "Подписи на основе правил" (@sec-labels_by_rules) и позволяет гибко настроить группировку объектов по стилю. В основе этого режима лежат логические выражения, которые разбивают множество объектов на группы для каждой из которых задается свой стиль отображения. 

![Cимволизация на основе правил по среднему возрасту и преобладающей породе](./pictures/4_3_символизация на основе правил.png){#fig-rules_viz}

Логические выражения (правила) добавляются при помощи символа **"Добавить правило"**. В пункте **"надпись"** задается называние для правила. В пункте **"Поиск"** задается логическое правило, которое определяет группу объектов, для которых будет задан стиль отображения. Пункт "Иначе для всех остальных объектов" позволяет задать стиль для объектов, не входящих ни в одну группу. Настройка **"В пределах масштаба"** позволяет применять стиль только для определенного диапазона масштаба. В пункте **"Знак"** задается стиль отображения.  
Для примера окрасим сосняки более 100 лет и менее 100 лет в разные цвета. Для остальных выделов оставим видимыми только контуры. Первое правило будет иметь вид 
`"el_lesa" = 'С' AND  "A_let" < 100` (выбор выделов с преобладающей породой сосна И средним возрастом менее 100 лет). Второе правило вида `"el_lesa" = 'С' AND  "A_let" >= 100` задает стиль для сосняков со средним возрастом большим или равным 100 лет. В третьем правиле выбирается пункт **"Иначе для всех остальных объектов"** и задается стиль для всех объектов не попавших в первые два правила (@fig-rules_viz).

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Повторите пример визуализации по преобладающей породе и возрасту, котороый размещен выше. Результат должен соответствовать рисунку ниже. (@fig-rules_viz_task)
:::

![Результат символизации по преоблаюадей породе и возрасту](./pictures/4_4_символизация по правилам задание.png){#fig-rules_viz_task}


## Создание и заполнение макета

После задания соответствующего стиля объектов переходят к созданию карты. Кроме самого изображения земной поверхности карты и планы могут содержать легенду, координатную сетку, указатель на север, масштаб или масштабную линейку. В главном окне программы задается требуемый стиль отображения карты после чего карта оформляется в пункте меню **"Проект" > "Создать макет..."** вводится название макета и открывается новое окно с белым прямоугольником, который является листом будующей карты. Новые элементы добавляются в меню **"Добавить элемент"**, основные инструменты редактирования макета расположены в панеле слева. Добавленные элементы макета и их свойства отображаются в панеле справа "Элементы" и "Свойства элемента".  
Основным элементом макета является карта, которая добавляется в меню **"Добавить элемент" > "Добавить карту"** после чего выделяется область на белом листе, куда карта будет добавлена.

::: {.callout-note}
## Обратите внимание!
Печать карты производится только в границах белого листа. Элементы выходящие за эти границы не будут напечатаны.
:::

После добавления карты новый элемент с названием "Карта 1" появится в панеле "Элементы". Панель "Свойства элемента" позволяет изменять настройки добавленной карты (масштаб, систему координат и т.д.). Область, занятая картой, изменяется при помощи инструмента "Выделить/переместить элемент", предвигать карту внутри области возможно при помощи инструмента "Перемещение содержимого элемента" (@fig-maket).

![Использование макета для создания карты](./videos/4_2_макет.mp4){#fig-maket}

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Создайте новый макет. Добавьте карту так, что бы она занимала приблизительно 80% площади листа.
:::

Аналогичным образом добавляется масштабная линейка и другие элементы. Для этого перейдите в пункт "Добавить элемент" и выберите необходимый (так же добавить большинство элементов макета возможно при помощи панели слева).

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Добавьте в макет масштабную линейку, указатель "север-юг" и надпись "План лесонасаждений".
:::

Для настройки свойств определенного элемента его необходимо выделить в панеле "Элементы" после чего свойства появятся в окне "Свойства элемента". После оформления карты обычно сохраняют в виде изображения. Для этого перейдите в пункт **"Макет" > "Экспорт в изображение"** и сохраните результат в папку проекта.

::: {.callout-tip}
## Задание `r task_fun(ch, t)`
Добавьте координатную сетку на карту (система координат EPSG:4326 - WGS84). В свойствах масштабной линейки измените единицы измерения на километры. У надписи "План лесонасаждений" увеличьте размер шрифта до 30. Сохраните карту в виде изображения. Пример итоговой карты приведен на рисунке ниже (@fig-maket_task).
:::

![Пример плана лесонасаждений](./pictures/4_5_макет задание.png){#fig-maket_task}

Макет со всеми добаленными элементами сохраняется в файле проекта. При необходимости внесения изменений достаточно открыть сохраненный макет, внести изменения и сохранить карту повторно.

## Создание плана лесонасаждений

В лесном хозяйстве широко используются планы лесонасаждений (добавить определение). Такие планы окрашиваются на основе сочетания преобладающей породы и группы возраста: молодняки; средневозрастные; приспевающие; спелые и перестойные. Создать такую классификацию возможно используя стиль **"Символизация на основе правил"** с вложенными условиями.

!!Рисунок плана лесонасаждений

Легенда планов часто представлена в виде матрицы, где по вертикали указывается преобладающая порода, а по горизонтали - класс возраста. Каждому сочетанию "порода-класс возраста" соответствует определенный оттенок цвета.

!!Рисунок - пример матричной легенды

Так же каждый выдел подписывается в виде дроби, где в числителе указывается номер выдела, в знаменателе - площадь в гектарах. Такие подписи возможно создать с использованием HTML-тегов.

!!Рисунок - подписи выделов в виде дроби.

В QGIS существует возможность сохранять настройки отображения слоя(стили, подписи и др.) в отдельный файл с расшерением **".qml"** а так же использовать их повторно в новых проектах. Перечисленные выше настройки плана лесонасаждений были сохранены в файл "style.qml". Для создания плана лесонасаждений достаточно применить их к слою "videla", для этого перейдите в свойства слоя > "Стиль" > "Форма" > "Загрузить стиль". В открывшемся окне "Управление стилями" выберите и загрузите файл стиля (style.qml). В результате к слою "videla" будут применены сохраненные ранее стили и подписи объектов.

!!Видео добавить о применении стиля.

### Исследование стилей отображения









