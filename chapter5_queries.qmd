# Запросы {#sec-queries}


::: {.callout-note}
## Загрузите файлы!
Для выполнения заданий из раздела "Запросы" загрузите файлы по [ссылке 1](https://github.com/agoroshko/qgis_for_beginners/tree/main/files) или [ссылке 2](https://disk.yandex.ru/d/IuXJbTCAmIZvaw) и создайте новый проект:

- Создайте новую папку проекта под названием "Раздел 5" а так же новый проект в QGIS;
- Загрузите файлы в QGIS;
- Задайте систему координат проекта EPSG:32646;
- Сохраните файл проекта в папку проекта. 
:::


Распространенной задачей в геоинформационных системах является поиск объектов по характеристикам (атрибутам) и пространственному положению. Для решения этой задачи используются логические выражения (предикаты) которые отделают искомые объекты от всех остальных по заданному условию. Аналогичные выражения уже использовались в @sec-sec-labels_by_rules. Инструменты поиска объектов размещены в **"Панели выбора объектов"** ![Панель выбора объектов](./pictures2/5_1_Панель выбора объектов.png) в главном окне программы. Некоторые инструменты панели скрыты во вкладках (@fig-choices).

![Инструменты панели выбора объектов](./pictures/5_7_Выбор объектов.png){#fig-choices}

::: {.callout-note}
## Обратите внимание!
Если панель выбора объектов не активна, перейдите в меню **"Вид" > "Панели инструментов"** и поставьте чек-бокс напротив пункта **"Панель выбора объектов"**.
:::

## Выбор объектов по значению

Простой способ выбора объектов по атрибутам реализуется при помощи инструмента **"Выбрать объекты по значению..."** ![1](./QGIS_icons/mIconFormSelect.svg) который активируется при помощи горячей клавиши **F3** или выбором из **"панели выбора объектов"**. Рассмотрим возможности инструмента на примере слоя **"videla"**.


::: {.callout-note}
## Обратите внимание!
Инструмент **"Выбрать объекты по значению..."** ![1](./QGIS_icons/mIconFormSelect.svg) применяется к тому слою, который выделен в панеле слоев на момент использования инструмента. Сначала выберите в панеле слой, после чего активируйте инструмент **"Выбрать объекты по значению..."** ![1](./QGIS_icons/mIconFormSelect.svg).
:::

В открывшемся окне представлен список полей слоя для каждого из которых возможно задать определенный фильтр. По умолчанию для всех полей активирован режим **"Исключить поле"** т.е. поле не участвует в фильтрации. Для текстовых полей дополнительная настройка **"Case sensetive"** включает чувствительность к регистру (прописные и заглавные буквы будут считаться разными символами). Список доступных логических операций различен для текстовых и числовых полей (@fig-choice_1, @fig-choice_2).

![Выбор объектов по значению для числового поля](./pictures2/5_2_Операторы для числового поля.png){#fig-choice_1}

![Выбор объектов по значению для текстового поля](./pictures2/5_2_Операторы для текстового поля.png){#fig-choice_2}

Фильтр настраивается путем введения порогового значения в необходимое поле и выбора логической операции (равно, больше, меньше и т.д.). Все объекты удовлетворяющие условию будут выбраны. Фильтрация по нескольким полям объединяется оператором **"И"** т.е. будут выбраны только те объекты, которые удовлетворяют **всем** введенным условиям. После задания условия нажмите на иконку **"Выбрать объекты"** в нижней части окна. В основном окне программы выбранные объекты будут выделены желтым цветом. Фильтр для отбора выделов с преобладающей породой сосна **и** возрастом более 100 лет приведен на рисунке ниже (@fig-choice_3).

![Выбор выделов со средним возрастом более 100 лет и преобладающей породой сосна](./pictures2/5_2_Выбор объектов.png){#fig-choice_3}

Все выделенные объекты будут так же подсвечены синим цветом в таблице атрибутов, открыв которую можно убедиться в правильности выполнения запроса. Для примера, выберем все выделы со средним возрастом более 150 лет.

::: {.callout-note}
## Обратите внимание!
Для того что бы быстро найти выделенные объекты в таблице атрибутов, можно воспользоваться инструментом "Переместить выделенные в начало" ![1](./QGIS_icons/mActionSelectedToTop.svg), так все выделенные объекты будут отображаться в начале таблицы.
:::

::: {#task-task_t1 .callout-tip}
При помощи инструмента "Выбор объектов по значению", выберите выделы с преобладающей породой береза (поле "el_lesa"), типом леса "ВРТ" (поле "tip_lesa") и средним возрастом более 80 лет (поле "A_let"). В результате должно быть выбрано **42 выдела**.
:::

Выполнив @task-task_t1, объекты будут выделены желтым цветом. Новый запрос заменит результаты предыдущего, однако, выделенные объекты возможно сохранить как отдельный векторный слой, для этого перейдите в пункт меню **«Правка» > «Копировать объекты»**, после чего перейдите снова в пункт **«Правка» > «Вставить объекты как» > «Создать векторный слой...»**. Сохраните новый слой в рабочую папку проекта. Cозданный слой будет содержать только выделенные объекты.

::: {#task-task .callout-tip}
Сохраните выделенные объекты из предыдущего задания как новый векторный слой.
:::

Аналогично составляются другие запросы. Для числовых полей может оказаться полезным условие **"Между (включительно)"**, задающее диапазон значений, которым должны соответствовать объекты (минимальное и максимальное значение). Например, запрос для выбора выделов со средним возрастом от 60 до 90 лет представлен на рисунке ниже (@fig-choice_between). Обратите внимание на то, что карйние значения диапазона (т.е. 60 и 90) так же попадают в выборку.

![Выбор выделов со средним возрастом от 60 до 90 лет включительно](./pictures2/5_2_Оператор между.png){#fig-choice_between}

::: {#task-task .callout-tip}
Выберите выделы со средней высотой (поле "H_m") от min до 15 и от 20 до max. Для этого, по аналогии с условием "Между (включительно)" используйте условие "Вне диапазона (включительно)". В результате выборка должна составить **320 выделов**.
:::

Кроме опции **"Выбрать объекты"** ![1](./QGIS_icons/mIconFormSelect.svg) доступны варианты модификации уже созданной выборки, режимы **"Добавить к текущей выборке"** ![1](./QGIS_icons/mIconSelectAdd.svg) и **"Удалить из текущей выборки"** ![1](./QGIS_icons/mIconSelectRemove.svg) позволяют соответственно добавить объекты к уже существующей выборке или удалить из нее, **"Фильтровать текущее выделение"** ![1](./QGIS_icons/mIconSelectIntersect.svg) применяет фильтр к ранее выбранным объектам (@fig-choice_mode).

![Варианты модификации выборки](./pictures2/5_3_Модификация текущей выборки.png){#fig-choice_mode}

![Пример работы режима "Фильтровать текущее выделение"](./videos/5_1_Модификация выборки.mp4){#vid-filter_chlice}


::: {#task-task .callout-tip}
Выберите 20 - 30 случайных выделов, используя инструмент "Выбор объектов" ![1](./QGIS_icons/mActionSelectRectangle.svg). Отфильтруйте полученную выборку так, что бы остались выделы со средним возрастом более 100 лет (поле "A_let"). Для этого используйте инструмент **"Выбрать объекты по значению"**, задайте условия фильтра, после чего используйте режим **"Фильтровать текущее выделение"** ![1](./QGIS_icons/mIconSelectIntersect.svg) (см. @vid-filter_chlice). Сохраните результат выполнения задания как новый векторный слой.
:::

## Выбор объектов по выражению

Более гибкие возможности выбора объектов предоставляет инструмент **"Выбрать объекты по выражению..."** ![1](./QGIS_icons/mIconExpressionSelect.svg) (@fig-choice_query).


!!! Добавить картинку панели с инструментом!!!


![Окно инструмента "Выбрать объекты по выражению..."](./pictures2/5_4_Выбор объектов по выражению.png){#fig-choice_query}

В левой части окна записывается логическое выражение (предикат), в средней части выбираются логические операторы и поля, участвующие в выражении (наиболее часто используемые категории **"Операторы"** и **"Поля и значения"**). В правой части окна выводится справка. Иконка **"Выбрать объекты"** активирует выбор объектов по заданному выражению. Операторы для количественных и качественных переменных различаются. Для запросов к количественным переменным (площадь выдела, средний возраст и т.д.) применяются операторы: **равно (=), не равно (<>), больше (>), меньше (<), больше или равно (>=), меньше или равно (<=)**. Для запросов к качественным переменным (элемент леса, тип леса и т.д.) используют операторы **IS, IS NOT, IN**.  
Например:

- выражение для выбора выделов с площадью более 5 га: `"s_ha" > 5`;
- выражение для выбора выделов с типом леса "ВКТ": `"tip_lesa"  IS  'БРТ'`; 
- выражение для выбора выделов где преобладающая порода НЕ сосна: `"el_lesa" IS NOT 'С'`.

::: {.callout-note}
## Обратите внимание!
В конструкторе выражений названия полей записываются в двойных кавычках (`"s_ga"`), текст в одинарных (`'БРТ'`), числа записывают без кавычек.  
Поисковые запросы чувствительны к регистру и языку ввода. Часто к ошибкам приводит запись буквы `'С'` латиницей (внешне она не отличима от кириллицы), поэтому при поиске сосны в поле "el_lesa" порода записывается кириллицей с заглавной буквы - `'С'`.
:::

::: {#task-task .callout-tip}
При помощи инструмента "Выбрать объекты по выражению" ![1](./QGIS_icons/mIconExpressionSelect.svg) выберите выдела первой группы возраста (поле "gr_vozr"). В таблице атрибутов выдела первой группы возраста (молодняки) имеют значение 1 в соответствующем поле. В результате запроса должно быть выбрано **9 выделов**.
:::

Пропущенные значения кодируются значением **NULL**. При поиске пропущенных значений в качестве оператора используется `IS` вместо знака равенства. Например, для поиска выделов с пропущенным средним возрастом, следует использовать выражение: `"A_let" IS NULL`.

::: {#task-task .callout-tip}
При помощи инструмента "Выбрать объекты по выражению..." ![1](./QGIS_icons/mIconExpressionSelect.svg) выберите выделы в которых пропущен запас на 1 га (поле "zapas_1_ha"). В результате должно быть выбрано **74 выдела**.
:::

Отдельная группа операторов позволяет объединить несколько условий в одно выражение, соединяя их одним из операторов: **И (AND); ИЛИ (OR)**. Отдельно стоит рассмотреть оператор **NOT**, который меняет результат любого оператора на противоположный. Все перечисленные операторы могут принимать только два значения: правда или ложь. Если для конкретного объекта всё выражение принимает значение правда — этот объект соответствует условиям и попадает в выборку.  
Для выбора выделов со средним возрастом от 50 до 70 лет конструируется следующее выражение: `"A_let" > 50 AND "A_let" < 70`. В этом случае было записано два условия соединенных через оператор **AND (И)**. Такое выражение выбирает объекты, которые соответствуют **И** первому **И** второму условию.

::: {#task-task .callout-tip}
При помощи инструмента "Выбрать объекты по выражению..." ![1](./QGIS_icons/mIconExpressionSelect.svg) выберите выделы со средним диаметром больше 40 см (поле "DBH_cm") **И** преобладающей породой сосна. В результате должен быть выбран **21 выдел.**
:::

Для объединения нескольких условий так же применяется оператор **ИЛИ (OR)** который используется когда объект должен удовлетворять **хотя бы одному** условию. Например, для выбора выделов со средней высотой более 30 м **ИЛИ** возрастом более 100 лет используется выражение: `"H_m" > 30 OR "A_let" > 100`. В результате будут выбраны выдела со средней высотой более 30 м или с возрастом более 100 лет.

::: {#task-task .callout-tip}
При помощи инструмента "Выбрать объекты по выражению..." ![1](./QGIS_icons/mIconExpressionSelect.svg) выберите выделы с преобладающей породой осина **ИЛИ** выделы старше 140 лет. В результате должно быть выбрано **38 выделов.**
:::

Для выбора нескольких значений качественной переменной используется оператор **IN** после которого в круглых скобках указывается список значений. Если значение атрибута объекта соответствует хотя бы одному значению из списка - он попадает в выборку. Выбор выделов с типами леса ВКТ, ЗМ, КТП производится выражением: `"tip_lesa" IN ('ВКТ', 'ЗМ', 'КТП')`.

::: {#task-inquery .callout-tip}
При помощи инструмента "Выбрать объекты по выражению..." ![1](./QGIS_icons/mIconExpressionSelect.svg) выберите выделы с преобладающей породой береза, осина, липа (используйте оператор `IN`) и возрастом более 60 лет (т.е. средний возраст каждого выдела должен быть больше 60 лет). В результате должно быть выбрано **137 выделов.**
:::


## Выбор объектов по пространственному положению


Выбор объектов по пространственному положению производится инструментом **"Выбрать по расположению"** ![1](./QGIS_icons/algorithms/mAlgorithmSelectLocation.svg) который позволяет выбрать объекты одного слоя по пространственным отношениям к объектам другого слоя (@fig-spat_query).

![Окно инструмента "Выбрать по расположению"](./pictures2/5_5_Выбор по расположению с реками.png){#fig-spat_query}

В пункте **"Выбрать объекты слоя"** назначается слой из которого выбираются объекты по условию пространственного отношения с другим слоем, которое задается в пункте **"по отношению к объектам слоя"**. Необходимые пространственные отношения отмечаются чек-боксами в пункте **"Где объект (геометрический предикат)"**. Пункт **"Изменить текущую выборку"** позволяет **"создать новую выборку"** или модифицировать уже выбранные объекты (см @fig-change_query).

::: {#task-task .callout-tip}
Используя инструмент **"Выбрать по расположению"**, выберите только те выделы, которые пересекаются реками (слой "rivers"). Сохраните выбранные выделы как отдельный слой. В результате должно быть выбрано **64 выдела** (см. @vid-quary_by_location)
:::

::: {.callout-note}
## Обратите внимание!
Для просмотра количества выбранных выделов откройте таблицу атрибутов. Выбранные выделы будут подсвечены синим цветом. Для более удобного подсчета используйте инструмент **"Переместить выделенные в начало"** ![1](./QGIS_icons/mActionSelectedToTop.svg).
:::

![Выбор объектов по расположению](./videos/5_2_Выделение по положению.mp4){#vid-quary_by_location}

Пункт **"Изменить текущую выборку"** позволяет **"создать новую выборку"** (по умолчанию) или модифицировать уже существующую: **"добавить к текущей выборке", "выбрать в текущей выборке", "удалить из текущей выборки"**. Последние 3 пункта позволяют объединить несколько пространственных запросов или комбинировать пространственный запрос с выбором по атрибутам (@fig-change_query).

![Режимы модификации текущей выборки](./pictures2/5_6_Изменить текущую выборку.png){#fig-change_query}

::: {#task-task .callout-tip}
Выберите выделы которые пересекаются реками и дорогами. Для этого объедините два пространственных запроса (пересечение с реками и пересечение с дорогами). В результате должен быть выбран **151 выдел**. Сохраните выбранные выделы как новый векторный слой.
:::

::: {#task-task .callout-tip}
Выберите выделы которые пересекаются реками и преобладающая порода в которых НЕ сосна. Для этого объедините пространственный запрос с запросом по атрибутам. В результате должно быть выбрано **19 выделов.** Сохраните выбранные объекты как новый векторный слой.
:::

