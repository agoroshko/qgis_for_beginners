# Векторизация {#sec-vectorization}

Векторизация изображения — перевод из растрового формата в векторный. При этом все объекты отображаются в виде точек, линий или полигонов, для каждого объекта заполняется атрибутивная информация (преобладающая порода, тип леса и т.д.).

Исходными данным для выполнения заданий этого раздела являются геопривязанные изображения из раздела 1 "Пространственная привязка растра". Так же вы можете загрузить геопривязанные изображения для выполнения заданий по ссылке ниже.

::: {#nte-download_ch2 .callout-note}
## Загрузите файлы!
Для выполнения заданий из этого раздела используйте проект с геопривязанными изображениями, созданный в результате выполнения заданий раздела 1. Так же вы можете загрузить геопривязанные изображения по  [ссылке](https://github.com/agoroshko/qgis_for_beginners/tree/main/files/ch1_%D0%9F%D1%80%D0%B8%D0%B2%D1%8F%D0%B7%D0%BA%D0%B0%20%D1%80%D0%B0%D1%81%D1%82%D1%80%D0%B0) и создать новый проект.
:::

## Добавление точечных объектов

Точками обозначаются объекты, не имеющие длину или площадь (колодцы, горные вершины и др.). Для примера используем геопривязанное изображение **"Национальный парк столбы"** что бы оцифровать некоторые скалы и добавить им названия. Для этого создадим новый точечный векторный слой с атрибутом **"name"** в который запишем названия скал.

### Создание векторного слоя

Для создания векторного слоя перейдите в меню **"Слой" > "Создать слой" > "Создать слой Shapefile..."**. В поле имя файла нажмите на иконку **"..."**, после чего выберите папку для сохранения файла и введите название (например "Скалы", в зависимости от содержания слоя).

::: {.callout-note}
## Обратите внимание!
При создании нового векторного слоя всегда явно указывайте путь его сохранения. Для этого в поле **"Имя файла"** нажмите **"..."**, выберите папку для сохранения и затем введите название файла. **Всегда сохраняйте файл в папку проекта!**
:::

В поле **"Тип геометрии"** необходимо выбрать какой тип геометрии будет содержать слой. Один слой может содержать объекты **только** одного типа: точка, линия или полигон. Поскольку будут оцифрованы точечные объекты (вершины скал) зададайте **"Тип геометрии" - "Точка"**.
При создании нового слоя возможно сразу задать перечень полей (атрибутов), в которые будут записываться **непространственные** характеристики объектов (название, тип покрытия дороги, средний возраст насаждения в выделе и др.). Дополнительные поля можно добавить или удалить в любой момент после создания векторного слоя в контекстном меню панели слоев **"Открыть таблицу атрибутов"**. При создании атрибута задается **тип** и **размер**. **Тип** данных определяет характер информации, который может содержать поле, **размер** определяет максимальное количество символов. Шейп-файлы содержат следующие основные типы данных:

- **Текст (string)** - текстовое поле, может содержать цифры, буквы и др. символы (максимальное количество символов определяется настройкой "Размер");
- **Целое число (integer)** - целочисленное поле, может содержать только целые числа (максимальное количество знаков определяется настройкой "Размер");
- **Десятичное число (double)** - может содержать дробные числа (максимальное количество знаков определяется настройкой "Размер", максимальное количество знаков после запятой определятеся настройкой "Точность").

::: {.callout-note}
## Обратите внимание!
Всегда обращайте внимание на тип создаваемого поля! В поля типа "Целое число" или "Десятичное число" нельзя будет записать текстовые символы а к полю типа "Текст" нельзя применить арифметические операции, даже если оно содержит исключительно числа!
:::

Для записи названий скал создадим новое поле. В области "Новое поле" введите "Имя" - **"name"**, «Тип» – **"Текст"**, размер можно оставить без изменений (80 символов). После нажатия на иконку **"Добавить в список полей"** ![1](./QGIS_icons/mActionNewAttribute.svg), поле с заданными параметрами появится в области **"Список полей"**. Теперь слой содержит два поля: **"id"** (создается по умолчанию) и только что добавленное поле **"name"** в которое будут записываться названия объектов.  Так же есть возможность удалить поле при помощи иконки **"Удалить поле"** ![1](./QGIS_icons/mActionDeleteAttribute.svg) (@fig-point_layer). 


![Окно "Создать слой"](./pictures2/2_1_Создание точечного слоя.png){#fig-point_layer}

После задания всех параметов нажмите **"ОК"**, новый слой будет сохранен на диск и появится в панеле **"Слои"**.

!!! Видео - создание векторного слоя

::: {.callout-note}
## Обратите внимание!
Названия полей **всегда задаются латинскими буквами без пробелов и специальных символов**. Слова в названии поля следует разделять знаком нижнего подчеркивания "_".
:::

::: {#task-task_make_new_layer .callout-tip}
По примеру выше создайте новый векторный слой "Скалы" с типом геометрии "точка" и текстовым полем "name".
:::

### Оцифровка точечных объектов

Для добавления новых объектов в векторный слой следует выделить его в панеле слоев и нажать иконку **"Режим редактирования"** ![Режим редактирования](./QGIS_icons/mActionToggleEditing.svg) в панеле **"Инструменты оцифровки"** ![инструменты оцифровки](./pictures2/2_9_Панель инструментов оцифровки.png) 

После активации режима редактирования **"Инструменты оцифровки"** становятся доступны, появляется возможность добавлять или изменять объекты слоя. **"Режим редактирования"** выполняет роль предохранителя. Пока он не активирован, слой находится в режиме просмотра и не может быть изменен. Таким образом данные защищены от нежелательных случайных изменений.  
Панель **"Инструменты оцифровки"** состоит из следующих инструментов:

- **"Сохранить изменения"** ![1](./QGIS_icons/mActionSaveAllEdits.svg) - при нажатии сохраняются изменения в объектах слоя; 
- **"Добавить объект"** - позволяет добавить объект (точка ![1](./QGIS_icons/mActionCapturePoint.svg), линия ![1](./QGIS_icons/mActionCaptureLine.svg) или полигон ![1](./QGIS_icons/mActionCapturePolygon.svg) в зависимости от типа геометрии слоя); 
- **"Инструмент правки вершин"** ![1](./QGIS_icons/mActionVertexToolActiveLayer.svg) - позволяет передвигать или удалять отдельные вершины геометрий; 
- **"Удалить выделенное"** ![1](./QGIS_icons/mActionDeleteSelectedFeatures.svg); 
- **"Отменить"** ![1](./QGIS_icons/mActionUndo.svg) и другие.

Что бы добавить первую точку выберите инструмент **"Добавить объект"** ![1](./QGIS_icons/mActionCapturePoint.svg) и нажмите на одну из подписанных скал. Появится окно **"Атрибуты объекта"** в котором нужно заполнить ранее созданное поле **"name"** - название скалы (@fig-attr_window), после чего нажать **"ОК"**. Новый объект появится на карте. Аналогичным способом добавляют остальные вершины скал. 

![Окно "Атрибуты объектов"](./pictures2/2_2_Заполнение атрибутов точечного слоя.png){#fig-attr_window}

::: {.callout-note}
## Обратите внимание!
Хотя названия полей **всегда задаются латинскими буквами без пробелов и специальных символов**, для содежимиого полей таких ограничений нет, использование кириллицы вполне допустимо. Основное ограничение содержимого поля - тип данных поля.
:::

::: {#task-task_add_points .callout-tip}
По примеру выше добавьте все подписанные вершины скал в виде точек. Для каждой точки запишите название скалы.
:::

### Изменение положения точечных объектов

Изменение формы существующих объектов выполняется при помощи **"Инструмента правки вершин"** ![1](./QGIS_icons/mActionVertexToolActiveLayer.svg), позволяющего изменить местоположение вершин и сегментов а так же добавить/удалить вершины. Воспользуемся этим инструментом что бы передвинуть добавленные точки. Для этого активируйте инструмент и передвиньте любую из точек, нажав на нее.

!!! Видео

::: {#task-vertex_tool_task_1 .callout-tip}
Используйте **"Инструмента правки вершин"** что бы передвинуть несколько точек, как показано выше (ссылка на видео!!!).
:::

Для перемещения сразу нескльких точек, выделите их (зажмите левую кнопку мыши > потяните курсор > выделите точки синим контуром) и переместите одну из точек на новое место. Остальные точки сместятся вслед за ней.


!!! Видео

::: {#task-vertex_tool_task_2 .callout-tip}
Используйте **"Инструмента правки вершин"** что бы выделить и переместить несколько точек, как показано выше (ссылка на видео!!!).
:::

Пока точки выделены вы можете удалить их, нажав клавишу "Delete". Для отмены последних действий используйте инструмент "Отменить" ![1](./QGIS_icons/mActionUndo.svg) или сочетание клавиш `Ctrl+Z`. Инструмент "Вернуть" ![1](./QGIS_icons/mActionRedo.svg) позволяет вернуть отмененные изменения (`Ctrl+Shift+Z`). Для просмотра изменений возможно использовать панель **"История изменений"** которая включается в меню **"Настройки" > "Панели" > "История изменений"** и позволяет так же отменить и вернуть изменения (@fig-change_hist).

![Панель "История изменений"](./pictures2/2_3_Панель история изменений.png){#fig-change_hist}


!!! Видео отмены и возврата изменений.


Изменения векторного слоя (добавление, удаление объектов, изменение атрибутов и т.д.) не записываются в файл автоматически. Для сохранения изменений воспользуйтесь иконкой **"Сохранить изменения"** ![1](./QGIS_icons/mActionSaveAllEdits.svg) в панеле **"Инструменты оцифровки"**.

::: {.callout-note}
## Обратите внимание!
- После сохранения изменений в файл, становится невозможно отменить последние действия. Перед сохранением убедитесь в том, что все правки сделаны верно, после сохранения отменить их уже **не получится!**
- Не путайте иконки "Сохранить изменения" ![1](./QGIS_icons/mActionSaveAllEdits.svg) и "Сохранить проект" ![сохранить проект](./QGIS_icons/mActionFileSave.svg). Первая сохраняет изменения в слое, вторая - проект!
:::

::: {#task-task .callout-tip}
При помощи панели "История изменений" отмените несколько последних действий и сохраните изменения в слое (иконки "Сохранить изменения" ![1](./QGIS_icons/mActionSaveAllEdits.svg)).
:::

### Удаление точечных объектов

Другой способ удаления объектов заключается в выделении их при помощи **"Панели выбора объектов"** (в которой выбирается один из инструментов). Выделенные объекты окрасятся в желтый цвет, после чего нажимается клавиша **Delete** или иконка **"Удалить выделенное"** ![1](./QGIS_icons/mActionDeleteSelectedFeatures.svg). Появится предупреждающее окно в котором нужно нажать "Удалить объект" (@fig-confirm_del). Для примера используем инструмент "Выбрать объекты в прямоугольнике или точке" ![1](./QGIS_icons/mActionSelectRectangle.svg) для выбора и удаления объектов.

![Подтверждение удаления объектов](./pictures2/2_4_Подтверждение удаления.png){#fig-confirm_del}

!!! Видео выбора и удаления объектов.

::: {#task-task .callout-tip}
По примеру выше, выделите и удалите несколько точечных объектов. Сохраните изменения в слое и отключите режим редактирования.
:::

## Таблица атрибутов слоя

При добавлении точечных объектов в поле "name" записывались названия скал. Эти названия хранятся в таблице атрибутов и могут использоваться для подписи объектов, по аналогии с подписями кварталов (@task-task_kvnet). Вы можете открыть таблицу атрибутов и убедиться в этом. Для этого в панеле слоев откройте контекстное меню слоя "Скалы" и выберите пункт **"Открыть таблицу атрибутов"** ![Открыть таблицу атрибутов](./QGIS_icons/mActionOpenTable.svg). Таблица атрибутов откроется в отдельном окне (@fig-attr_table).

![Таблица атрибутов](./pictures2/2_5_Таблиа атрибутов.png){#fig-attr_table}

Каждая строка таблицы атрибутов связана с отдельной геометрией (точкой), столбцы - атрибутивные характеристики. При выделении строки в таблице атрибутов, связанная точка будет выделена желтым цветом, и наоборот, при выделении точек в главном окне карты, они будут выделены синим в таблице атрибутов. Конечно, атрибутов (столбцов) может быть больше чем 1 или 2. Для точек это могли бы быть дополнительные стобцы в виде координат, значений высот и т.д.

!!! Видео выделения объектов в таблице атрибутов

::: {#task-task .callout-tip}
Откройте таблицу атрибутов слоя "Скалы".
:::

Таким образом каждой точке соответствует название скалы. Эти названия можно использовать, например, в качестве подписей точек. Для добавления подписей скал перейдите в контекстное меню слоя **"Скалы" > "Свойства..." > "Подписи"**. Режим **"Без подписей"** измените на **"Обычные подписи"**, в поле **"Значение"** выберите атрибут **"name"** (в это поле записывались названия скал при создании объектов) и нажмите "ОК". Рядом с каждой точкой появится подпись - название скалы.

!!! Видео добавления подписей

::: {#task-task .callout-tip}
По примеру выше, добавьте подписи для точечных объектов.
:::

## Оцифровка линейных объектов

По аналогии с точечными объектами могут оцифровываться и линейные объекты. Обычно к таковым относят объекты большой протяженности и малой ширины (дороги, небольшие реки, лэп и т.д.). В векторной моделе данных линии представляют из себя последовательность соединенных точек. Соответственно образуются две части такого вида геометрии: **вершины** (точки) и **сегменты** (линии их соединяющие). Для примера оцифруем некоторые тропы и дороги на территории заповедника "Столбы".  
Каждый векторный слой может содержать только один тип геометрии (точка, линия, полигон) поэтому для оцифровки линейных объектов создадим новый векторный слой (см. @task-task_make_new_layer) под названием **"Дороги"**, **"Тип геометрии" - "Линия"**. Так же добавим атрибут **"Имя" - "type", "Тип" - "Текст"** куда будем запиcывать тип дороги (автомобильная дорга или тропа) (@fig-make_roads_layer).

![Создание векторного слоя "Дороги"](./pictures2/2_6_Создание слоя Дороги.png){#fig-make_roads_layer}

::: {#task-task .callout-tip}
По примеру выше создайте новый векторный слой "Скалы" с типом геометрии "линия" и текстовым полем "type".
:::

### Оцифровка дороги

Первым добавленным объектом будет автомобильная дорога на территории заповедника "Столбы". Для этого переключите слой "Дороги" в **"Режим редактирования"** ![Режим редактирования](./QGIS_icons/mActionToggleEditing.svg) (см. #task-task_add_points), и оцифруйте дорогу, путем расставления точек поворота по линии дороги. В поле "type" сделайте запись "автомобильная дорога".


!!! Видео - оцифровка дороги.


По умолчанию новые слои имеют тонкие линии и случайный цвет. Что бы линии были более заметны, увеличим толщину линий и зададим яркий цвет, для этого перейдите в **"Свойства..." слоя > "Стиль"** измените цвет на более яркий и увеличьте толщину линий до 0,66

!!! Видео изменения стиля

### Топология линейных объектов. Инстурменты прилипания

Под топологией объектов понимают их взаимное положение. Это важное свойство векторной модели данных, которое должно учитыватся при оцифровке объектов. Например, если река впадает в другую реку, то в векторной моделе данных эти две линии должны иметь общую точку. Разрыв или пересечение линий в этой точке будут топологическми ошибками (@fig-topology_errors). Этот пример можно экстраполировать на множество других объектов: дороги, тропы, ЛЭП и т.д. 


::: {#fig-topology_errors layout-nrow=3}

![Ошибка топологии - разрыв](./pictures2/2_7_Ошибки топологии 1.png){#fig-topology_errors1}

![Ошибка топологии - пересечение](./pictures2/2_7_Ошибки топологии 2.png){#fig-topology_errors2}

![Пример корректной топологии](./pictures2/2_7_Ошибки топологии 3.png){#fig-topology_errors3}

Ошибки топологии
:::


Соблюдение топологии невозможно без использования специальных инструментов, находящихся в **"Панеле инструментов прилипания"** ![инструменты прилипания](./pictures2/2_8_Панель инструментов прилипания.png)  
Инструмент **"Разрешить прилипание"** ![1](./QGIS_icons/mIconSnapping.svg) активирует возможности топологического редактирования, после чего остальные инструменты на панеле становятся активны. Возможны следующие настройки прилипания:

 - Прилипание к объектам всех слоев или только текущего  
 ![1](./pictures2/2_10_Настройка прилипания 1.png)
 - Прилипание к вершинам, сегментам или другим элементам геометрий  
 ![1](./pictures2/2_10_Настройка прилипания 2.png)
 - порог прилипания позволяет задать радиус прилипания и единицы измерения этого радиуса (единицы измерения зависят от СК проекта: градусы или метры);
 - Инструмент **"Вычитать наложения на текущем слое"** позволяет избежать наложения полигонов друг на друга  
 ![1](./pictures2/2_10_Настройка прилипания 3.png)
 - функция **"Включить трассировку"** дает возможность добавлять новые геометрии по границам существующих.
 
 Для оцифровки троп требуется соблюсти топологию. Настроим **"Инструменты прилипания"** следующим образом: 
 
 - активируйте панель инструментов прилипания нажав на иконку **"Разрешить прилипание"** ![1](./QGIS_icons/mIconSnapping.svg);
 - настройте прилипание **К текущему слою**;
 - настройте прилипание к **Вершинам** и **Сегментам** (в этом пункте возможно выбрать одновременно несколько режимов);
 - задайте порог прилипания **30 пикселей (пикс)**.
 
Теперь при добавлении нового объекта и приближении указателя на расстояние менее 30 пикселей к уже существующей линии, курсор «приклеится» к ней (прилипание к вершинам обозначается квадратом, прилипание к сегментам - знаком "х" ). Такие настройки позволяют избежать разрывов в линиях.
Используя знания о топологическом редактировании, можно векторизировать оставшиеся тропы топологически корректно.

!!! Видео настройки прилипания и векторизации троп.

::: {#task-task .callout-tip}
По примеру выше, настройте инструменты прилипания и оцифруйте оставшиеся тропы (они выделены пунктиром). В атрибут "type" запишите слово "тропа".
:::

### Редактирование линейных объектов

Редактирование добавленных линейных объектов выполняется при помощи **"Инструмента редактирования вершин"** ![1](./QGIS_icons/mActionVertexToolActiveLayer.svg) (см. @task-vertex_tool_task_1 и @task-vertex_tool_task_2), однако, по сравнению с точечными объектами, этот инструмент имеет гораздо больше возможностей редактирования линейных объектов. Рассмотрим эти возможности на примере объектов из слоя "Дороги".  
Выбрав **"Инструмент редактирования вершин"** ![1](./QGIS_icons/mActionVertexToolActiveLayer.svg) и нажав правой кнопкой мыши на одну из линий, отоброзятся составные части этой линии (вершины в виде красных кругов и сегменты). Инструмент позволяет редактировать положение вершин и сегментов а так же добавлять или удалять новые вершины. Для перемещения вершины, нажмите на нее левой клавишей мыши и перетяните в нужное место.

!!! Видео перемещения вершины

::: {#task-task .callout-tip}
По примеру выше, переместите несколько вершин.
:::

Для добавления новой вершины нажмите левой клавишей мыши на середину сегмента (при наведении курсора на сегмент его середина будет выделена символом "+") и переместите новую вершину в нужное место. Аналогично сегмент можно добавить в начале и конце линии, нажав на символ "+".

!!! Видео добавления вершины в середине и конце отрезка

::: {#task-task .callout-tip}
По примеру выше, добавьте вершины в вередине и конце отрезка.
:::

Для перемещения сегмента целиком нажмите на него (не на середину) левой клавишей мыши и переместите на нужное место. При этом изменится положение двух вершин, образующих сегмент.

!!! Видео перемещения сегмента.

::: {#task-task .callout-tip}
По примеру выше, переместите несколько сегментов линии.
:::

Для выделения нескольких вершин зажмите левую клавишу мыши и потяните курср. Вершины попадающие в область будут подсвечены синим. Выделенные вершины возможно удалить, нажав клавишу "Delete" или переместить все вместе (для этого переместите одну из выделенных вершин, остальные последуют за ней). С нажатой клавишей "Shift" возможно выделить произвольные вершины.

!!! Видео - выделение, перемещение и удаление вершин.

::: {#task-task .callout-tip}
По примеру выше, выделите и удалите несколько вершин в слое "Дороги".
:::

Во время оцифровки дорог, для каждого объекта было заполнено поле (атрибут) "type", который принимал 2 значения: "автомобильная дорога" или "тропа". Такие атрибуты называют группирующими потому что они позволяют разделить объекты на несколько групп. Воспользуемся атрибутом "type" что бы раскрасить дороги и тропы в разные цвета. Для этого перейдите в свойства слоя "Дороги" > "Стиль", измените режим "Простая символика" на "Символизация по уникальным значениям", в поле "Значение" выберите поле для классификации ("type") и нажмите "Классифицировать" (@fig-roads_style). В окне появятся 3 класса объектов с разным цветом линии, после чего нажмите "ОК".

![Настройка стиля слоя "Дороги"](./pictures2/2_11_Стиль слоя Дороги.png){#fig-roads_style}

Таким образом уникальные значения атрибута "type" использовались для окраски дорог в разные цвета. Более подробно настройка стиля объектов будет рассмотрена в последующих разделах (см. @sec-thematic_maps).

::: {#task-task .callout-tip}
По примеру выше, настройте стиль слоя "Дороги".
:::

## Оцифровка полигональных объектов

Полигоны используют для оцифровки площадных объектов (больших рек, земельных участков, лесных кварталов и выделов). Полигон можно рассматривать как замкнутую линию (начальная и конечная точки имеют одинаковые координаты). Во многом оцифровка полигональных объектов схожа с линейными, но имеет свои особенности. Рассмотрим оцифровку полигональных объектов на примере лесных кварталов учебно-опытного лесхоза СибГУ. Для этого используем план лесонасаждений из предыдущего раздела (см. @task-georef_forestplan).

















## Создание векторного слоя

Начните оцифровку с линейных объектов. В перечень их входят дороги и ручьи. Для начала создадим дополнительный векторный слой, на котором будем отмечать ручьи, для этого переходим во вкладку **"Слой" > "Создать слой" > "Создать слой Shapefile..."**. В поле имя файла следует нажать на иконку **"..."**, после чего выбрать папку для сохранения файла, ввести название (например "Дороги", в зависимости от содержащихся в слое объектов).

::: {.callout-note}
## Обратите внимание!
При создании нового векторного слоя всегда явно указывайте путь его сохранения. Для этого в поле **"Имя файла"** нажмите **"..."**, выберите папку для сохранения и затем введите название файла. **Всегда сохраните файл в папку проекта!**
:::

В поле **"Тип геометрии"** необходимо выбрать какой тип геометрии будет содержать создаваемый слой. Один слой может содержать объекты только одного типа: точечная, линия или полигон (площадная). Задайте тип геометрии **"Линия"**, в области «Новое поле» введите "Имя" - **"name"**, «Тип» – **"Текст"**, размер можно оставить без изменений (80 символов). После этого нажимаем на иконку **"Добавить в список полей"**, поле с заданными параметрами появится в области **"Список полей"**. Теперь слой содержит два поля: **id** - создается по умолчанию и добавленное поле **name** в которое будут записываться названия объектов.  Для удаления полей предусмотрена иконка **"Удалить поле"** (@fig-makelayer). После задания всех параметов нажмите **ОК**, новый слой будет сохранен на диск и появится в панеле **"Слои"**.

![Создание векторного слоя](./gif/8_make_roads.gif){#fig-makelayer}

Список полей отражает атрибуты (характеристики), которые возможно заполнить при создании объекта. Создавая очередной векторный слой, полезно задать минимальное необходимое количество полей, характеризующий каждый отдельный объект. Дополнительные поля можно добавить в любой момент после создания векторного слоя в контекстном меню **"Открыть таблицу атрибутов"**. 
Несмотря на то, что добавить или удалить поля атрибутивных данных можно после создания слоя, тип отдельного поля и его настройки (имя, длина, точность)  изменить невозможно. Поэтому к настройкам полей нужно подходить внимательно. Тип поля может быть текстовым, целочисленным, десятичным числом или датой. **"Размер"** поля определяет количество символов, которое может храниться в этом поле, **"Точность"** - количество знаков после запятой (@fig-makelayer).

::: {#task-task .callout-tip}
Создайте новый слой "Дороги.shp", как показано выше. Сохраните его в папку с проектом.
:::

Завершив настройку нового слоя, нажимаем «ОК». Новый слой автоматически появится в «Панели слоев» основного окна QGIS. Отображение слоев на карте зависит от их порядка в панели слоев, поэтому векторные слои должны быть всегда выше чем растровые. Отключить видимость слоя можно сняв chekbox (флажок) слева от него (@fig-layerpanel).

![Переключение видимости слоев](./gif/9_layers_panel.gif){#fig-layerpanel}

::: {.callout-note}
## Обратите внимание!
Если Вы не можете найти ту или иную панель в главном окне программы, возможно она не активирована. Для отображения панели перейдите во вкладку "**Настройки**", в пунктах "**Панели**" или "**Панели инструментов**" поставьте chekbox (флажок) напротив нужной панели и она появится в главном окне программы.
:::

## Векторизация линейных объектов

Для векторизации используют панель **"Инструменты оцифровки"** ![инструменты оцифровки](./icons/5_инструменты оцифровки.png)  
Выбор слоя для добавления или изменения геометрий произволится в **Панеле слоев**. Выделяем созданный векторный слой (Дороги), в **"Инструментах оцифровки"** нажимаем на иконку **"Режим редактирования"** ![Режим редактирования](./QGIS_icons/mActionToggleEditing.svg). После активации режима редактирования **"Инструменты оцифровки"** становятся активны и появляется возможность добавлять или изменять объекты слоя. **"Режим редактирования"** выполняет роль предохранителя. Пока он не активирован, слой находится в режиме просмотра и не может быть изменен. Таким образом данные защищены от нежелательных случайных изменений.  
Панель **"Инструменты оцифровки"** состоит из следующих инструментов: **"Сохранить правки слоя"** ![1](./QGIS_icons/mActionSaveAllEdits.svg) - при нажатии сохраняются изменения в объектах слоя; **"Добавить объект"** - позволяет добавить объект (точка, линия или полигон в зависимости от типа геометрии слоя); **"Инструмент правки вершин"** - позволяет передвигать или удалять отдельные вершины геометрий; **"Удалить выделенное"**; **"Отменить"** и другие.  
Находим на плане дорогу и применяя инструмент **"Добавить объект"** добавляем линию, отмечая точки вдоль изображения дороги на растровом слое. Во время добавления объекта масштаб карты можно менять прокруткой колеса мышки, перемещаться по плану — удерживая клавишу пробел. Добавление объекта завершается нажатием правой кнопки мыши, после чего появится окно ввода атрибутивной информации этого объекта. Если у дороги на плане есть название, его следует ввести в поле **"name"**. В противном случае поля можно не заполнять и просто нажать **ОК**. Первый объект в виде дороги будет добавлен (@fig-vectorization).

![Оцифровка линий](./gif/5_add_road.gif){#fig-vectorization}

По умолчанию вновь созданные слои имеют тонкие линии и случайный цвет. Эти настройки можно изменить в контекстном меню слоя (правый «клик» в панеле слоев), пункт **"Свойства" > "Стиль"**. В этом окне можно изменить цвет и толщину линии. Так же существует масса других настроек, они будут рассмотрены в последующих разделах. Измените цвет и увеличьте толщину линий до 0,86 (@fig-roadstyle).

![Настройка стиля линий](./gif/6_road_style.gif){#fig-roadstyle}

Для сохранения прогресса векторизации рекомендуется периодически использовать инструмент **"Сохранить правки слоя"** ![1](./QGIS_icons/mActionSaveAllEdits.svg), который записывает все изменения в файл. Таким образом прогресс не будет потерян, но после сохранения отменить изменения будет невозможно. 

::: {.callout-note}
## Обратите внимание!
Используйте инструмент **"Сохранить правки слоя"** с осторожностью, охраненные изменения **невозможно** будет отменить!
:::

::: {#task-task .callout-tip}
Оцифруйте одну дорогу в границах одного кваратала. Измените цвет (выберите любой) и толщину линий слоя, как показано выше.
:::

## Топология объектов

При оцифровке важно соблюдать топологию объектов. Например, в месте соединения двух дорог они должны иметь общую точку, а между границами выделов не должно быть пустот или наложений. Для соблюдения топологии оцифровки объектов применяется панель **"Инструменты прилипания"**. ![инструменты привязки](./icons/6_инструменты привязки.png)  
Инструмент **"Разрешить прилипание"** ![1](./QGIS_icons/mIconSnapping.svg) активирует возможности топологического редактирования, после чего остальные инструменты на панеле становятся активны. Возможна настройка прилипания к объектам на всех слоях или только на текущем слое, к вершинам, сегментам или другим элементам геометрий, порог прилипания позволяет задать радиус прилипания и единицы измерения этого радиуса. Инструмент **"Вычитать наложения на текущем слое"** позволяет избежать наложения полигонов друг на друга, функция **"Включить трассировку"** дает возможность добавлять новые геометрии по границам уже существующих геометрий.
Настроим **"Инструменты прилипания"** следующим образом. Прилипание **К текущему слою**, прилипание **к вершинам** и **к линиям**, порог прилипания **25 пикселей**. Теперь при добавлении нового объекта и приближении указателя на расстояние менее 25 пикселей к уже существующей линии, курсор «приклеится» к ней. Такие настройки позволяют избежать разрывов в линиях.
Используя полученные навыки, можно векторизировать оставшиеся дороги топологически корректно. Таким же образом создается отдельный векторный слой для векторизации рек или иных линейных объектов, которые существуют на карте (@fig-snapping).

![Топологическое редактирование](./gif/10_Прилипание.gif){#fig-snapping}

::: {#task-task .callout-tip}
Оцифруйте оставшиеся дороги в границах квартала используя прилипание к уже существующим дорогам. Аналогично оцифруйте реки в приделах квартала (создайте новый векторный слой под названием "Реки.shp", добавьте поле **name**, заполните его названием реки).
:::

## Векторизация полигонов

После векторизации линейных объектов, подобным образом векторизуют площадные объекты (лесные выдела). Для этого создается отдельный векторный слой с названием **"выдела"**, тип геометрии - Площадная (полигон). В атрибутивной информации добавьте одно поле с номерами выделов: "имя" — **"videl"**, тип — **целое число**, размер — **2**. Сохраните слой в папку проекта. В панеле **"Инструменты прилипания"** находятся инструменты для топологически корректной оцифровки.  
Инструмент **"Включить трассировку"** позволяет проводить границу вдоль уже существующих геометрий. Если требуется создать общую границу - настройку **Offset** следуют оставить по умолчанию (0,000000) в противном случае новая линия будет проведена на указанном в настройке расстоянии от уже существущей геометрии. Этот инструмент не всегда работает предсказуемо, поэтому при его использовании следует внимательно следить за результатом (@fig-tracking).

![Трассировка](./gif/11_Трассировка.gif){#fig-tracking}

Функция **"Вычитать наложения на текущем слое"** позволяет оцифровывать полигоны без пересечений. При добавлении нового полигона поверх существующего он будет обрезан по границе второго. Такая настройка позволяет проводить оцифровку сплошных площадей, состоящих их множества участков, без наложений и разрывов (@fig-avoidint).

::: {.callout-note}
## Обратите внимание!
Функция **"Вычитать наложения на текущем слое"** не работает с геометриями содержащими ошибки. См. @sec-invalidgeom.
:::

![Вычитание наложений полигонов](./gif/12_Вычитание наложений.gif){#fig-avoidint}

После создания геометрии можно воспользоваться инструментом **"Редактирование вершин"** позволяющим изменять положение вершин и сегментов, добавлять и удалять вершины (@fig-editpoints).

![Редактирование вершин](./gif/13_Редактирование вершин.gif){#fig-editpoints}

Инструмент **"Включить топологическое редактирование"** дает возможность перемещать вершины смежных полигонов топологически корректно, как одну общую вершину (@fig-pointstopo).

![Топологическое редактирование вершин](./gif/14_Топологическое редактирование вершин.gif){#fig-pointstopo}

В процессе оцифровки периодически случаются ошибки при расстановке вершин геометрии. Если геометрия еще не создана, последнюю установленную вершину можно удалить нажатием клавиши **Backspace** на клавиатуре (@fig-pointsedit).

![Удаление вершин при оцифровке](./gif/15_Редактирование вершин в процессе.gif){#fig-pointsedit}

::: {#task-task .callout-tip}
Топологически корректно оцифруйте выдела на территории квартала. При оцифровке не забывайте сразу проставлять номера выделов во всплывающем окне (поле "videl").
:::

## Панель выбора объектов {#sec-pickobj}

Для выделения объектов используется **Панель выбора объектов** ![Панель выбора объектов](./icons/9_Панель выбора объектов.png)
Первый инструмент **Выбрать объекты в прямоугольнике или точке** позволяет выделить объект или группу объектов на карте. Для удаления выделенных объектов нажмите клавишу **Delete** или выберите инструмент **Удалить выделенное** в панеле **Инструменты оцифровки**. При этом слой должен находиться в режиме редактирования, в противном случае удаление будет невозможно. Отмена выделения выполняется инструментом **Снять выделение...**, так же отменить выделение можно нажав на пустую область без объектов. Выбор объектов можно производить как точечно, так и в некоторой области (полигоне). Точечный выбор нескольких объектов выполняется при нажатой клавише **Control (Ctrl)** (@fig-pickobj).

![Выбор объектов разными способами](./gif/18_Выбор объектов.gif){#fig-pickobj}

**Панель выбора объектов** так же содержит инструменты для выбора по атрибутам и положению объектов. Возможности такого выбора будут рассмотрены в будущих разделах.

## Ошибки геометрий {#sec-invalidgeom}

При оцифровке объектов могут возникать ошибки геометрий. В QGIS, большинство инструментов работы с векторными слоями не будут работать со слоями содержащими ошибки геометрий. Для выявления таких ошибок существует инструмент **Вектор > Обработка геометрии > Проверка геометрии...** который создает три временных слоя с указаниями на объекты с корректными и некорректными геометриями. Исправить такие геометрии можно как вручную, так и при помощи инструмента "**Исправить геометрии**" в панеле "**Инструменты анализа**" ![панель инструментов](./icons/8_инструменты анализа.png). Иногда для исправления некоторых ошибок создают буфер нулевого радиуса вокруг объектов.
Наиболее распространенные ошибки геометрий следующие:

 - Задвоение точек - геометрия содержит две точки с одинаковыми координатами;
 - Самопересечение линий - линия пересекает саму себя;
 
 ![Самопересечение линий](./pictures/6_2 Самопересечение линий.png){#fig-invalidgeom2}
 
 - Самопересечение полигонов - полигон пересекает сам себя;
 
 ![Самопересечение линий](./pictures/6_3 Самопересечение полигонов.png){#fig-invalidgeom3}
 
 - Висячая линия в полигоне - полигон содержет в своем контуре линию.

 ![Самопересечение линий](./pictures/6_4 Висячая линия.png){#fig-invalidgeom4}

Ошибки геометрий подсвечиваются знаком "X" зеленого цвета. Нужно отметить, что некоторые инструменты прилипания (например "Вычитать наложения на текущем слое") не работают с геометриями содержащими ошибки.

::: {#task-task .callout-tip}
Проверьте созданные слои (дороги, реки, выдела) на наличие ошибок геометрий. В случае обнаружения ошибок, устраните их.
:::

## Дополнительные инструменты оцифровки (в разработке)
