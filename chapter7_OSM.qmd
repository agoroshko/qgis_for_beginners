
# Open Street Map (OSM)

[Open Street Map (OSM)](https://www.openstreetmap.org/#map=9/55.983/92.873) это некоммерческий проект по созданию подробной, свободной и бесплатной географической карты мира. Наполнение карты осуществляется участниками проекта OSM на добровольных началах. Проект функционирует по принципу Википедии: любой участник может добавлять объекты и их описание на карту. Данные OSM распространяются свободно под открытой лицензией Open Database License. OSM является одним из самых крупных источников информации для создания ГИС.

::: {.callout-note}
## Загрузите файлы!
Для выполнения последующих заданий загрузите файл по [ссылке 1]() или [ссылке 2](https://disk.yandex.ru/d/oCsbwolnayypiA) и создайте новый проект:

- Создайте новую папку проекта под названием "Раздел 7 OSM" а так же новый проект в QGIS.
:::

Файл **"osm.gpkg"** является файлом GeoPackage и содержит несколько векторных слоев для территории Красноярского края, полученных из базы данных Open Street Map (получить аналогичные данные возможно по [ссылке](https://download.geofabrik.de), регион - Siberian Federal District). При загрузке файла **"osm.gpkg"** появится окно выбора слоев для загрузки в проект. По умолчанию выбраны все слои, но возможно выбрать только некоторые слои из списка. Все слои содержатся в одном файле **"osm.gpkg"** который является контейнером базы данных SQLite. В описании каждого слоя указывается тип геометрии и количество объектов (@fig-choice).

![Окно выбора слоев файла "osm.gpkg"](./pictures2/7_1_Загрузка слоев.png){#fig-choice}

::: {#task-task .callout-tip}
## Задание
Загрузите в проект все слои из файла "osm.gpkg". Сохраните проект в папку проекта под названием "Раздел 7 OSM".
:::

В результате выполнения задания загружено 6 слоев: 

- **"level_6"** - административные районы в границах Красноярского края;
- **"places"** - населенные пункты; 
- **"railways"** - железные дороги; 
- **"roads"** - дороги; 
- **"water"** - площадные водные объекты (крупные реки, озера); 
- **"waterways"** - линейные водные объекты (реки в виде линий).

## Создание границы Красноярского края

Для создания границы Красноярского края из слоя **"level_6"** применяется инструмент **"Вектор" > "Геообработка" > "Объединение по признаку..."**. В качестве исходного слоя указывается **"level_6"**, в пункте **"поле слияния"** отмечается поле - **"admin_level"**. В результате геометрии с одинаковым атрибутом "admin_level" будут объединены между собой. Поскольку все геометрии слоя имеют одинаковое значение в поле **"admin_level"** (число 6), они будут объединены, создав таким образом границу Красноярского края (@fig-border).

![Результат применения инструмента "Объединение по признаку"](./pictures/6_12_Граница КК.png){#fig-border}

::: {#task-task .callout-tip}
## Задание
Создайте границу Красноярского края по примеру выше. Сохраните слой в файл "osm.gpkg" под названием "border" (@vid-addfile).

![Применение инструмента "Объединение по признаку", объединение по полю "admin_level"](./videos/6_2_объединение по признаку.mp4){#vid-addfile}
:::

## Подготовка данных

Некоторые объекты слоя **"places"** не находятся на территории Красноярского края. Обрежем слой по границе полигона **"border"** что бы удалить населенные пункты не входящие в границы Красноярского края. Для этого используется инструмент **"Обрезать"** (см. @task-task_cut).

::: {#task-task .callout-tip}
## Задание
Используйте инструмент "Обрезать" для обрезки слоя "places" по границе Красноярского края. Сохраните слой в файл "osm_krai.gpkg" под названием "places_border".
:::


## Кейсовые задания

Кейсовые задания предполагают решение задач с применением уже изученных а так же новых инструментов. Это комплексные задания, требующие декомпозиции задачи и решения в несколько шагов, на каждом из которых применяется свой набор инструментов. Для решения последующих заданий Вы можете использовать любые источники информации а так же помощь ваших коллег.  
Часть инструментов, необходимых для решения заданий, находится в меню **"Инструменты анализа"** (@fig-geotools).  
Окно **"Инструменты анализа"** открывается в правой части программы нажатием на иконку **"Панель инструментов"** ![1](./QGIS_icons/processingAlgorithm.svg). Если иконка отсутствует, убедитесь что в пункте **"Модули" > "Управление модулями..." > вкладка слева "Установленные"** присутствует галочка напротив инструмента **"Processing"**. Если галочка отсутствует - поставьте ее (см. @fig-processing).

![Активация модуля "Processing" (галочка установлена)](./pictures2/7_3_Модули processing.png){#fig-processing}

Для быстрого поиска инструмента удобно использвать поиск по названию (строка "Поиск..." в верхней части окна").

![Окно "Инструменты анализа"](./pictures2/7_2_Инструменты анализа.png){#fig-geotools}

### Кейс 1 Вычисление протяженности автомобильных дорог по муниципальным районам

**Задача:** Вычислить протяженность крупных дорог (в слое "roads", в поле "fclass" это значения 'trunk', 'primary' и 'secondary') для каждого муниципального района Красноярского края. В результате должна быть получена таблица с суммарной длиной дорог на территории каждого района. Результат выполнения кейса приведен на рисунке ниже (@fig-case_1_result).

![Таблица - результат выполнения кейса 1](./pictures2/7_4_Результат кейса 1.PNG){#fig-case_1_result}

**Исходные данные:** слои "roads" и "level_6".

**Описание:** Сначала следует рассмотреть структуру исходных слоев:

- слой "level_6" содержит полигоны, границы муниципальных районов Красноярского края. В таблице атрибутов слоя содержится название для каждого района (поле "local_name");
- слой "roads" содержит линейные объекты, дороги. В атрибутах слоя указаны характеристики дорог, в том числе в поле "fclass" указан тип дороги ([подробнее о типах дорог в OSM](https://wiki.openstreetmap.org/wiki/Key:highway)). Согласно заданию, из всех дорог необходимо выбрать дороги с типами 'trunk', 'primary' и 'secondary'.

Для последующего подсчета длины нужно разбить дороги на части по границам муниципальных районов и добавить поле принадлежности к тому или иному району (инструмент "Пересечение").

После чего в слой дорог добавляют еще одно поле в котором рассчитывают длину каждой части дороги. На последнем этапе суммируют протяженность дорог для каждого муниципального района (инструмент "Агрегировать"). При этом геометрии дорог так же будут объединены в границах каждого района а тип геометрии слоя конвертируется из линии в мультилинию.

**Этапы выполнения:**

- из слоя "roads" выберите нужные типы дорог (в поле "fclass" значения 'trunk', 'primary' и 'secondary') (см. @task-inquery);
- используйте инструмент "Пересечение", что бы обрезать дороги по границам муниципальных районов и добавить в атрибуты дорог название муниципального района (см. @task-task_cut);
- для каждой дороги рассчитайте длину (единицы измерения километры, 3 знака после запятой) (см. @task-task_measure_units, @task-length);
- используйте инструмент "Агрегировать" для того, что бы рассчитать суммарную протяженность дорог для каждого района;
- сохраните таблицу как файл Excel (.xlsx).


### Кейс 2 Построить карту количества железнодорожных мостов

**Задача:** Подсчитать количество железнодорожных мостов (пересечения рек и железных дорог) в каждом административном районе Красноярского края. Построить карту (см. @fig-case_2_result).

![Карта - результат выполнения кейса 2](./pictures2/7_6_Карта мостов.png){#fig-case_2_result}

**Исходные данные:** слои "railways", "waterways" и "level_6".

**Описание:** Исходными данным для выполнения задания является полигональный слой административных районов ("level_6"), линейный слой железных дорог ("railways") и линейный слой рек ("waterways"). В слое "waterways" содержатся различные реки (от крупных до мелких). В местах пересечения ЖД и небольших рек обычно стороят насыпи а не мосты, поэтому из слоя "waterways" необходимо выбрать только крупные реки. Для этого применяется фильтр к полю "fclass" и выбираются геометрии с атрибутом "river" (крупные реки). После этого, используйте инструмент "Пересечение линий" на слоях "railways" и отфильтрованом слое "waterways". В результате будет получен точечный слой пересечения линий из этих слоев.  
Следующая сложность заключается в том, что железная дорога часто имеет 2 колеи, но мост при этом один (см. @fig-case_2_points).

![Задвоение точек пересечения](./pictures2/7_5_Задвоение точек.PNG){#fig-case_2_points}

Одинм из способов удаления близко расположенных точек: построение буферов небольшого радиуса (30 м) вокруг каждой из точек (в инструменте "Буферизация..." должен быть установлен чек-бокс в пункте "Результат объединения"). Таким боразом, точки на расстоянии менее 30 метров будут объединены общей буферной зоной. С помощью инструмента "Центроиды" (должен быть установлен чек-бокс в пункте "Создать центроиды для каждой части") извлекаются центроиды из объединенных буферов. Эти центроиды соответствуют положению ЖД моста.  
После того как точечный слой ЖД мостов получен, остается подсчитать количество мостов в каждом муниципальном районе (для этого применяют инструмент "Подсчет точек в полигоне" к слою ЖД мостов и слою "level_6") и создать карту. 


**Этапы выполнения:**

- Выбрать из слоя "waterways" крупные реки (в поле "fclass" значение "river") (см. @task-task_t1);
- Получить точечный слой пересечений крупных рек и железных дорог (инструмент "Пересечения линий");
- Построить буферы радиусом 30 м с объединением пересекающихся буферов (перед построением буферов необходимо перепроецировать слой в систему координат ESRI: 102025) (см. @sec-ref_sys и @sec-buffer);
- Извлечь центроиды из буферов (используется инструмент "Центроиды", с установленным чек-боксом "Создать центроиды для каждой части");
- Рассчитать количество мостов в каждом административном районе (инструмент "Подсчет точек в полигоне").
- Составить карту количества ЖД мостов по регионам (см. @sec-thematic_maps_numsym).


### Кейс 3 Рассчитать площадь, покрытую водной поверхностью для каждого муниципального района.

**Задача:** Рассчитайте площадь муниципальных районов покрытую реками и озерами (в процентах от общей площади района). Постройте карту.

**Исходные данные:** слой муниципальных районов "level_6"; слой площадных водных объектов "water".

**Описание:**



**Этапы выполнения:**

- Переклассификация слоя "water": реки (reservoir, riverbank) и озера (water)
- Расчет площади для каждой геометрии (две колонки для рек и озер отдельно)
- В слое админ. границ так же расчет площади
- Пересечение водных объектов с админ. границами





